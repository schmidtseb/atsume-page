import{r,j as e,X as C,i as Q,k as V,l as O,m as Y,n as R,o as Z,A as ee,p as te,q as _,s as ae,P as le,t as se,u as oe,v as re,w as ne}from"./react-vendor-DJ-QoGxu.js";import{u as w,a as ie}from"./index-DQy-5LOC.js";import{u as de}from"./useGeolocations-BZFd3C9v.js";import{u as G}from"./useGallery-BeyW6TB5.js";import{c as ce,B as ue}from"./BaseMap-BQCdfX77.js";import{S as me}from"./SliderControl-CLdAFiUk.js";import xe from"./BatchUploadModal-BN2Glq3G.js";import"./vendor-CFJUWez9.js";import"./maplibre-gl-vendor-Csyg3Y42.js";import"./supabase-vendor-C_Ws-sQM.js";import"./presets-CtbnJzjA.js";const ge=({initialData:d,onSave:c,onClose:a})=>{const[l,f]=r.useState(d.name||""),[u,b]=r.useState(d.description||""),[s,p]=r.useState(d.radius||100),[m,j]=r.useState(d.stamp_id||null),{stamps:n,loading:x}=G(),{t:o}=w(),y=()=>{if(!l.trim()){alert(o("locationEditModal.validationError"));return}c({name:l,description:u,radius:s,latitude:d.latitude,longitude:d.longitude,stamp_id:m})};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm animate-fade-in","aria-modal":"true",role:"dialog",onClick:a,children:e.jsxs("div",{className:"relative w-full max-w-lg m-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-white transform animate-scale-in flex flex-col gap-6",onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:d.id?o("locationEditModal.titleEdit"):o("locationEditModal.titleAdd")}),e.jsx("button",{onClick:a,className:"p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors","aria-label":o("common.close"),children:e.jsx(C,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("input",{type:"text",placeholder:o("locationEditModal.namePlaceholder"),value:l,onChange:i=>f(i.target.value),className:"w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition"}),e.jsx("textarea",{placeholder:`${o("common.description")} (${o("common.optional")})`,value:u||"",onChange:i=>b(i.target.value),rows:3,className:"w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition resize-none"}),e.jsx(me,{label:o("locationEditModal.radius"),name:"radius",value:s,min:10,max:1e3,step:10,unit:"m",onChange:i=>p(parseInt(i.target.value,10)),tooltip:o("locationEditModal.radiusTooltip")})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:o("locationEditModal.assignStamp")}),e.jsx("div",{className:"h-48 bg-gray-900/50 rounded-lg p-3 overflow-y-auto no-scrollbar border border-gray-700",children:x?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:o("locationEditModal.loadingStamps")}):e.jsxs("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-3",children:[e.jsxs("button",{onClick:()=>j(null),className:`w-full aspect-square rounded-lg flex flex-col items-center justify-center text-gray-400 transition-all duration-200 focus:outline-none ring-offset-2 ring-offset-gray-800 focus:ring-2 ${m===null?"ring-2 ring-blue-500 bg-blue-500/10":"ring-1 ring-gray-600 hover:ring-blue-500 bg-gray-700"}`,children:[e.jsx(Q,{className:"w-8 h-8"}),e.jsx("span",{className:"text-xs mt-1",children:o("locationEditModal.noStamp")})]}),n.map(i=>e.jsx("button",{onClick:()=>j(i.id),className:`w-full aspect-square rounded-lg overflow-hidden transition-all duration-200 focus:outline-none ring-offset-2 ring-offset-gray-800 focus:ring-2 ${m===i.id?"ring-2 ring-blue-500":"ring-1 ring-gray-700 hover:ring-blue-500"}`,children:e.jsx("img",{src:i.thumbnail,alt:i.name,className:"w-full h-full object-contain bg-gray-900/50"})},i.id))]})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:a,className:"w-full bg-gray-600 hover:bg-gray-500 font-medium py-3 px-4 rounded-lg transition-colors",children:o("common.cancel")}),e.jsxs("button",{onClick:y,className:"w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2",children:[e.jsx(V,{className:"w-5 h-5"}),o("common.save")]})]})]})})},pe=({onSelect:d})=>{const{t:c}=w(),a=[{method:"map",icon:O,label:c("mapEditor.placeOnMap")},{method:"coords",icon:Y,label:c("mapEditor.byCoordinates")},{method:"osm",icon:R,label:c("mapEditor.fromOSM")},{method:"batch",icon:Z,label:c("mapEditor.batchUpload")}];return e.jsx("div",{className:"flex flex-col items-stretch gap-1 bg-gray-900/80 backdrop-blur-sm p-2 rounded-xl shadow-lg w-48",children:a.map((l,f)=>e.jsxs("button",{onClick:()=>d(l.method),className:"flex items-center gap-3 w-full text-left p-2 rounded-lg text-white hover:bg-blue-600 transition-colors animate-fade-in",style:{animationDelay:`${f*50}ms`},title:l.label,children:[e.jsx(l.icon,{className:"w-5 h-5 flex-shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:l.label})]},l.method))})},fe=({onSave:d,onClose:c})=>{const{t:a}=w(),[l,f]=r.useState(""),[u,b]=r.useState(""),[s,p]=r.useState({}),m=()=>{const n={},x=parseFloat(l),o=parseFloat(u);return l?(isNaN(x)||x<-90||x>90)&&(n.lat=a("coordInputModal.validation.latInvalid")):n.lat=a("coordInputModal.validation.latRequired"),u?(isNaN(o)||o<-180||o>180)&&(n.lon=a("coordInputModal.validation.lonInvalid")):n.lon=a("coordInputModal.validation.lonRequired"),p(n),Object.keys(n).length===0},j=n=>{n.preventDefault(),m()&&d({latitude:parseFloat(l),longitude:parseFloat(u)})};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm animate-fade-in","aria-modal":"true",role:"dialog",onClick:c,children:e.jsxs("div",{className:"relative w-full max-w-md m-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-white transform animate-scale-in flex flex-col gap-6",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:a("coordInputModal.title")}),e.jsx("button",{onClick:c,className:"p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors","aria-label":a("common.close"),children:e.jsx(C,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:j,className:"flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"latitude",className:"block text-sm font-medium text-gray-300 mb-1",children:a("coordInputModal.latitude")}),e.jsx("input",{id:"latitude",type:"number",step:"any",placeholder:a("coordInputModal.latitudePlaceholder"),value:l,onChange:n=>f(n.target.value),className:`w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border ${s.lat?"border-red-500":"border-gray-600"} focus:ring-2 focus:ring-blue-500 focus:outline-none transition`}),s.lat&&e.jsx("p",{className:"text-red-400 text-xs mt-1",children:s.lat})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"longitude",className:"block text-sm font-medium text-gray-300 mb-1",children:a("coordInputModal.longitude")}),e.jsx("input",{id:"longitude",type:"number",step:"any",placeholder:a("coordInputModal.longitudePlaceholder"),value:u,onChange:n=>b(n.target.value),className:`w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border ${s.lon?"border-red-500":"border-gray-600"} focus:ring-2 focus:ring-blue-500 focus:outline-none transition`}),s.lon&&e.jsx("p",{className:"text-red-400 text-xs mt-1",children:s.lon})]}),e.jsxs("div",{className:"flex gap-4 pt-2",children:[e.jsx("button",{type:"button",onClick:c,className:"w-full bg-gray-600 hover:bg-gray-500 font-medium py-3 px-4 rounded-lg transition-colors",children:a("common.cancel")}),e.jsxs("button",{type:"submit",className:"w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2",children:[a("coordInputModal.next"),e.jsx(ee,{className:"w-5 h-5"})]})]})]})]})})},he=({onImport:d,onClose:c})=>{const{t:a}=w(),[l,f]=r.useState(""),[u,b]=r.useState(!1),[s,p]=r.useState(null),m=async()=>{if(p(null),!/^([NWR]\d+|\d+)$/i.test(l)){p("invalidId");return}b(!0);let o=l;/^\d+$/.test(l)&&(o=`N${l}`);try{const y=await fetch(`https://nominatim.openstreetmap.org/lookup?osm_ids=${o.toUpperCase()}&format=json`);if(!y.ok)throw new Error("Network response was not ok");const i=await y.json();i&&i.length>0?d({latitude:parseFloat(i[0].lat),longitude:parseFloat(i[0].lon)}):p("notFound")}catch(y){console.error("OSM Import Error:",y),p("network")}finally{b(!1)}},j=x=>{x.preventDefault(),m()},n={invalidId:a("osmImportModal.error.invalidId"),notFound:a("osmImportModal.error.notFound"),network:a("osmImportModal.error.network")};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm animate-fade-in","aria-modal":"true",role:"dialog",onClick:c,children:e.jsxs("div",{className:"relative w-full max-w-md m-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-white transform animate-scale-in flex flex-col gap-6",onClick:x=>x.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:a("osmImportModal.title")}),e.jsx("button",{onClick:c,className:"p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors","aria-label":a("common.close"),children:e.jsx(C,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:j,className:"flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"osmId",className:"block text-sm font-medium text-gray-300 mb-1",children:a("osmImportModal.idLabel")}),e.jsx("input",{id:"osmId",type:"text",placeholder:a("osmImportModal.idPlaceholder"),value:l,onChange:x=>f(x.target.value),className:`w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border ${s?"border-red-500":"border-gray-600"} focus:ring-2 focus:ring-blue-500 focus:outline-none transition`}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:a("osmImportModal.helpText")})]}),s&&e.jsx("p",{className:"text-red-400 text-xs mt-1",children:n[s]}),e.jsxs("div",{className:"flex gap-4 pt-2",children:[e.jsx("button",{type:"button",onClick:c,className:"w-full bg-gray-600 hover:bg-gray-500 font-medium py-3 px-4 rounded-lg transition-colors",children:a("common.cancel")}),e.jsx("button",{type:"submit",disabled:u||!l,className:"w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:bg-gray-600 disabled:cursor-not-allowed",children:u?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),a("osmImportModal.importing")]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-5 h-5"}),a("osmImportModal.import")]})})]})]})]})})},be=({isOpen:d,onClose:c,locations:a,selectedLocationId:l,onSelectLocation:f})=>{const{t:u}=w(),b=s=>{f(s),c()};return e.jsx("aside",{className:`fixed top-0 left-0 h-full bg-gray-800 flex-shrink-0 transition-transform duration-300 ease-in-out z-40 w-full max-w-sm border-r-2 border-gray-700 shadow-2xl ${d?"translate-x-0":"-translate-x-full"}`,"aria-hidden":!d,children:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0",children:[e.jsx("h1",{className:"text-xl font-bold",children:u("locationList.title")}),e.jsx("button",{onClick:c,className:"p-2 rounded-full hover:bg-gray-700","aria-label":u("common.close"),children:e.jsx(C,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-grow overflow-y-auto p-2 no-scrollbar",children:a.length===0?e.jsxs("div",{className:"text-center text-gray-400 mt-8 px-4",children:[e.jsx("p",{children:u("locationList.empty")}),e.jsx("p",{className:"text-sm mt-1",children:u("locationList.emptySubtext")})]}):e.jsx("ul",{className:"flex flex-col gap-2",children:a.map(s=>e.jsx("li",{children:e.jsxs("button",{onClick:()=>b(s),className:`w-full flex items-center gap-3 text-left p-2 rounded-lg transition-colors duration-200 ${l===s.id?"bg-blue-600 text-white":"text-gray-200 hover:bg-gray-700"}`,"aria-label":u("locationList.selectLocation",{name:s.name}),"aria-current":l===s.id,children:[e.jsx("div",{className:"w-10 h-10 flex-shrink-0 bg-gray-900/50 rounded-md flex items-center justify-center",children:s.stamp?e.jsx("img",{src:s.stamp.thumbnail,alt:s.stamp.name,className:"w-full h-full object-contain"}):e.jsx(O,{className:"w-6 h-6 text-gray-500"})}),e.jsx("span",{className:"flex-grow font-medium truncate",children:s.name})]})},s.id))})})]})})},Ee=({editingRallyId:d,isVisible:c})=>{const{addToast:a}=ie(),{geolocations:l,addGeolocation:f,updateGeolocation:u,deleteGeolocation:b,refreshGeolocations:s}=de(d),{stamps:p}=G(),{t:m}=w(),[j,n]=r.useState(!1),[x,o]=r.useState(!1),[y,i]=r.useState(!1),[F,L]=r.useState(!1),[P,$]=r.useState(!1),[T,z]=r.useState(!0),[g,N]=r.useState(null),[M,S]=r.useState(null),[I,v]=r.useState(null),k=r.useRef(null),A=r.useMemo(()=>l.map(t=>({...t,stamp:p.find(h=>h.id===t.stamp_id)||null})).sort((t,h)=>t.created_at&&h.created_at?new Date(h.created_at).getTime()-new Date(t.created_at).getTime():0),[l,p]),U=r.useMemo(()=>({type:"FeatureCollection",features:l.map(t=>{const h=ce([t.longitude,t.latitude],t.radius);return h.properties={id:t.id},h})}),[l]),q=t=>{if(j){const{lng:h,lat:K}=t.lngLat;v({latitude:K,longitude:h}),n(!1)}g&&N(null)},B=t=>{M?u(M.id,t):(f(t),s()),S(null),v(null)},D=t=>{window.confirm(m("mapEditor.deleteConfirm"))&&(b(t),N(null))},E=r.useMemo(()=>g!=null&&g.stamp_id&&p.find(t=>t.id===g.stamp_id)||null,[g,p]),W=t=>{switch(o(!1),t){case"map":n(!0),a(m("mapEditor.addLocationToast"),"info");break;case"coords":i(!0);break;case"osm":L(!0);break;case"batch":$(!0);break}},J=t=>{i(!1),v(t)},X=t=>{L(!1),v(t),k.current&&k.current.flyTo({center:[t.longitude,t.latitude],zoom:15})},H=t=>{k.current&&k.current.flyTo({center:[t.longitude,t.latitude],zoom:15,speed:1.2}),N(t)};return r.useEffect(()=>{I&&S(null)},[I]),e.jsxs(e.Fragment,{children:[e.jsx(be,{isOpen:T,onClose:()=>z(!1),locations:A,selectedLocationId:(g==null?void 0:g.id)||null,onSelectLocation:H}),e.jsxs(ue,{isVisible:c,onMapClick:q,cursor:j?"cursor-add":"",mapRef:k,children:[e.jsxs(te,{id:"radius-circles",type:"geojson",data:U,children:[e.jsx(_,{id:"radius-circles-fill",type:"fill",paint:{"fill-color":"#ef4444","fill-opacity":.25}}),e.jsx(_,{id:"radius-circles-stroke",type:"line",paint:{"line-color":"#ef4444","line-width":1.5,"line-dasharray":[2,2]}})]}),l.map(t=>e.jsx(ae,{longitude:t.longitude,latitude:t.latitude,style:{zIndex:999},children:e.jsx("button",{onClick:h=>{h.stopPropagation(),N(t)},"aria-label":m("mapEditor.viewLocation",{name:t.name}),children:e.jsx(O,{className:"text-red-500 w-8 h-8 drop-shadow-lg",strokeWidth:1.5})})},t.id)),g&&e.jsx(le,{longitude:g.longitude,latitude:g.latitude,onClose:()=>N(null),closeOnClick:!1,anchor:"bottom",offset:35,children:e.jsxs("div",{className:"flex flex-col",children:[E&&e.jsx("img",{src:E.thumbnail,alt:E.name,className:"w-full h-32 object-contain bg-gray-900/50 rounded-t-md"}),e.jsxs("div",{className:"p-3",children:[e.jsx("h3",{className:"font-bold text-lg text-white mb-1",children:g.name}),e.jsx("p",{className:"text-sm text-gray-300 mb-3",children:g.description}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>{S(g),N(null)},className:"flex-1 bg-blue-600 text-white px-2 py-1.5 text-xs rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-1.5",children:[e.jsx(se,{className:"w-3 h-3"})," ",m("common.edit")]}),e.jsxs("button",{onClick:()=>D(g.id),className:"flex-1 bg-red-600 text-white px-2 py-1.5 text-xs rounded-md hover:bg-red-700 transition-colors flex items-center justify-center gap-1.5",children:[e.jsx(oe,{className:"w-3 h-3"})," ",m("common.delete")]})]})]})]})})]}),!T&&e.jsx("button",{onClick:()=>z(!0),className:"fixed top-1/2 -translate-y-1/2 left-0 z-30 py-4 px-1 bg-gray-900/70 hover:bg-gray-800/90 backdrop-blur-sm rounded-r-lg shadow-lg transition-colors","aria-label":m("locationList.toggle"),title:m("locationList.toggle"),children:e.jsx(re,{className:"w-5 h-5 text-white"})}),e.jsx("div",{className:"absolute bottom-6 right-6 z-10",children:e.jsxs("div",{className:"relative",children:[x&&e.jsx("div",{className:"absolute bottom-full right-0 mb-3",children:e.jsx(pe,{onSelect:W})}),e.jsx("button",{onClick:()=>{o(t=>!t),n(!1)},className:"bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-transform hover:scale-110","aria-label":m("mapEditor.addLocation"),"aria-expanded":x,children:e.jsx(ne,{className:`w-6 h-6 transition-transform duration-300 ${x?"rotate-45":""}`})})]})}),(M||I)&&!y&&!F&&e.jsx(ge,{initialData:M||I,onSave:B,onClose:()=>{S(null),v(null)}}),y&&e.jsx(fe,{onSave:J,onClose:()=>i(!1)}),F&&e.jsx(he,{onImport:X,onClose:()=>L(!1)}),P&&e.jsx(xe,{isOpen:P,onClose:()=>$(!1),rallyId:d})]})};export{Ee as default};
