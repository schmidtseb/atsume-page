var q=Object.defineProperty;var L=(o,t,e)=>t in o?q(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var S=(o,t,e)=>L(o,typeof t!="symbol"?t+"":t,e);import{r as z}from"./react-vendor-DJ-QoGxu.js";import{d as P,a as H,u as N,l as v,b as W,m as $,n as j}from"./index-DQy-5LOC.js";const k=(o=0,t=1)=>{const e=Math.random(),n=Math.random();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*n)*t+o};class b{constructor(t,e,n){S(this,"data");S(this,"width");S(this,"height");this.width=e,this.height=t;const r=e*t;if(n instanceof Float32Array){if(n.length!==r)throw new Error("Data array does not match matrix dimensions");this.data=n}else this.data=new Float32Array(r),typeof n=="number"&&this.data.fill(n)}static ones(t,e){return new b(t,e,1)}static zeros(t,e){return new b(t,e,0)}get(t,e){return t<0||t>=this.height||e<0||e>=this.width?0:this.data[t*this.width+e]}set(t,e,n){t>=0&&t<this.height&&e>=0&&e<this.width&&(this.data[t*this.width+e]=n)}clone(){return new b(this.height,this.width,new Float32Array(this.data))}getBilinear(t,e){const n=Math.floor(t),r=Math.floor(e),a=Math.ceil(t),s=Math.ceil(e);if(n<0||a>=this.height||r<0||s>=this.width)return 0;const h=this.get(n,r),i=this.get(n,s),c=this.get(a,r),f=this.get(a,s),d=t-n,l=e-r,u=h*(1-l)+i*l,m=c*(1-l)+f*l;return u*(1-d)+m*d}}function F(o,t){const e=b.zeros(o.height,o.width);for(let n=0;n<o.data.length;n++)e.data[n]=o.data[n]*t.data[n];return e}function U(o,t,e,n,r){const a=b.zeros(o.height,o.width);for(let s=0;s<o.data.length;s++)a.data[s]=o.data[s]*t+e.data[s]*n+r;return a}function C(o){const t=o.clone();let e=1/0,n=-1/0;for(let a=0;a<t.data.length;a++)t.data[a]<e&&(e=t.data[a]),t.data[a]>n&&(n=t.data[a]);const r=n-e;if(r>0)for(let a=0;a<t.data.length;a++)t.data[a]=(t.data[a]-e)/r;return t}function B(o){let t=0;for(let e=0;e<o.data.length;e++)o.data[e]!==0&&t++;return t}const E=240,O=10,X=1;function G(o,t){const e=[];for(let n=0;n<o.length;n+=3){const r=o[n],a=o[n+1],s=o[n+2],h=(r+a+s)/3,i=r>E&&a>E&&s>E;h>t&&!i&&e.push(r,a,s)}return new Float32Array(e)}function x(o,t){return Math.sqrt((o[0]-t[0])**2+(o[1]-t[1])**2+(o[2]-t[2])**2)}function K(o,t){if(o.length===0||t===0)return{colors:[],labels:new Int32Array(0)};const e=o.length/3,n=[];for(let i=0;i<o.length;i+=3)n.push([o[i],o[i+1],o[i+2]]);e<t&&(t=e);let r=[];const a=new Set;for(;r.length<t;){const i=Math.floor(Math.random()*e);a.has(i)||(r.push([...n[i]]),a.add(i))}const s=new Int32Array(e);for(let i=0;i<O;i++){for(let l=0;l<e;l++){let u=1/0,m=0;for(let p=0;p<r.length;p++){const y=x(n[l],r[p]);y<u&&(u=y,m=p)}s[l]=m}const c=Array(r.length).fill(0).map(()=>[0,0,0]),f=new Array(r.length).fill(0);for(let l=0;l<e;l++){const u=s[l];c[u][0]+=n[l][0],c[u][1]+=n[l][1],c[u][2]+=n[l][2],f[u]++}let d=!0;for(let l=0;l<r.length;l++){if(f[l]>0)c[l][0]/=f[l],c[l][1]/=f[l],c[l][2]/=f[l];else{const u=Math.floor(Math.random()*e);c[l]=[...n[u]]}x(c[l],r[l])>X&&(d=!1)}if(r=c,d)break}return{colors:r.map(i=>i.map(Math.round)),labels:s}}function Y(o,t){const e=b.zeros(o.height,o.width),n=Math.floor(t/2);for(let r=0;r<o.height;r++)for(let a=0;a<o.width;a++){let s=255;for(let h=-n;h<=n;h++)for(let i=-n;i<=n;i++)s=Math.min(s,o.get(r+h,a+i));e.set(r,a,s)}return e}function V(o,t,e,n,r,a){const s=new Array(n*r).fill(-1);let h=0;for(let c=0;c<o.length;c+=3){const f=o[c],d=o[c+1],l=o[c+2],u=(f+d+l)/3,m=f>E&&d>E&&l>E;u>a.background_threshold&&!m&&(s[c/3]=e[h],h++)}const i=[];for(let c=0;c<t.length;c++){const f=new Float32Array(n*r);for(let l=0;l<s.length;l++)f[l]=s[l]===c?255:0;let d=new b(r,n,f);a.color_shape_shrink>0&&(d=Y(d,a.color_shape_shrink)),i.push(d)}return i}function Z(o,t,e){const n=t*Math.PI/180,r=e*Math.cos(n),a=e*Math.sin(n);return[r,a,(1-r)*o.x-a*o.y,-a,r,a*o.x+(1-r)*o.y]}function J(o,t,e,n){const r=b.zeros(n,e),[a,s,h,i,c,f]=t,d=a*c-s*i;if(Math.abs(d)<1e-6)return r;const l=1/d,u=c*l,m=-s*l,p=(s*f-c*h)*l,y=-i*l,w=a*l,A=(i*h-a*f)*l;for(let _=0;_<n;_++)for(let I=0;I<e;I++){const g=u*I+m*_+p,M=y*I+w*_+A,T=o.getBilinear(M,g);r.set(_,I,T)}return r}function Q(o,t,e,n,r){return o.map(a=>{const s=k(...n),h=k(...n),i=k(...r),c=Z({x:t/2,y:e/2},i,1);return c[2]+=s,c[5]+=h,J(a,c,t,e)})}function R(o){var i;const t=o.length,e=((i=o[0])==null?void 0:i.length)||0,n=Array(t).fill(null).map(()=>Array(e));for(let c=0;c<t;c++)for(let f=0;f<e;f++)n[c][f]=o[c][f]>127;const r=Array(t).fill(null).map(()=>Array(e));for(let c=0;c<t;c++)tt(n[c],r[c]);const a=Array(t).fill(null).map(()=>Array(e)),s=Array(t),h=Array(t);for(let c=0;c<e;c++){for(let f=0;f<t;f++)s[f]=r[f][c];et(s,h);for(let f=0;f<t;f++)a[f][c]=Math.sqrt(h[f])}return a}function tt(o,t){const e=o.length;let n=1/0;for(let r=0;r<e;r++)o[r]?n++:n=0,t[r]=n*n;n=1/0;for(let r=e-1;r>=0;r--)o[r]?n++:n=0,t[r]=Math.min(t[r],n*n)}function et(o,t){const e=o.length;if(e===0)return;const n=Array(e),r=Array(e+1);let a=0;n[0]=0,r[0]=-1/0,r[1]=1/0;for(let s=1;s<e;s++){let h=(o[s]+s*s-(o[n[a]]+n[a]*n[a]))/(2*s-2*n[a]);for(;h<=r[a];)a--,h=(o[s]+s*s-(o[n[a]]+n[a]*n[a]))/(2*s-2*n[a]);a++,n[a]=s,r[a]=h,r[a+1]=1/0}a=0;for(let s=0;s<e;s++){for(;r[a+1]<s;)a++;t[s]=(s-n[a])*(s-n[a])+o[n[a]]}}function nt(o,t,e){const n=Array(e).fill(null).map(()=>Array(t));for(let r=0;r<e;r++)for(let a=0;a<t;a++)n[r][a]=o.get(r,a);return R(n)}function ot(o,t,e,n,r){return o.map(a=>{const s=Array(e).fill(0).map(()=>Array(t).fill(0));for(let c=0;c<e;c++)for(let f=0;f<t;f++)s[c][f]=a.get(c,f);const h=R(s),i=b.ones(e,t);for(let c=0;c<e;c++)for(let f=0;f<t;f++){const d=h[c][f];for(let l=1;l<=n;l++)if(d>l-1&&d<=l){const u=r*(n-l+1)/n;i.set(c,f,u);break}}return i})}function rt(o,t,e){const n=b.zeros(t,o);for(let r=0;r<3;r++){const a=2**r,s=1/a,h=1/a;for(let i=0;i<t;i++)for(let c=0;c<o;c++){const f=h*Math.sin(c*s*2*Math.PI/e)*Math.sin(i*s*2*Math.PI/e),d=n.get(i,c);n.set(i,c,d+f)}}return C(n)}function at(o,t,e,n,r){const a=b.ones(t,o);if(r<=0||e<=0)return a;for(let s=0;s<e;s++){const h=Math.random()*(n[1]-n[0])+n[0],i=Math.random()*o,c=Math.random()*t,f=Math.max(0,Math.floor(i-h)),d=Math.min(o,Math.ceil(i+h)),l=Math.max(0,Math.floor(c-h)),u=Math.min(t,Math.ceil(c+h));for(let m=l;m<u;m++)for(let p=f;p<d;p++){const y=Math.sqrt((p-i)**2+(m-c)**2);if(y<h){const A=1-(y/h)**2,_=1-r*A;a.get(m,p)>_&&a.set(m,p,_)}}}return a}function st(o,t,e,n){const r=[];for(let a=0;a<o;a++){const s=k(...n.noise_scale),h=rt(t,e,s),i=Math.round(k(...n.num_patches)),c=k(...n.ink_depletion_intensity),f=at(t,e,i,n.patch_size_range,c),d=k(...n.wear_intensity),l=b.ones(e,t);let u=U(h,d,l,1-d,0);u=F(u,f),u=C(u),r.push(u)}return r}function ct(o,t){const e=[];let n=0;for(let r=0;r<o.length;r++){const a=t>0?o[r].density/t:1/o.length;n+=a,e.push(n)}return e.length>0&&(e[e.length-1]=1),e}function lt(o){const t=Math.random();let e=0,n=o.length-1;if(o.length===0)return-1;if(t<=o[0])return 0;if(t>=o[o.length-1])return o.length-1;for(;e<n;){const r=Math.floor((e+n)/2);o[r]<t?e=r+1:n=r}return e}function it(o,t,e,n,r,a){const s=F(t,e);let h=null;a.bleeding_factor>0&&(h=nt(o,n,r));const i=[];let c=0;for(let u=0;u<r;u++)for(let m=0;m<n;m++)if(o.get(u,m)>127){const p=s.get(u,m);i.push({x:m,y:u,density:p}),c+=p}if(i.length===0)return[];const f=ct(i,c),d=Math.floor(a.splat_density*i.length),l=[];for(let u=0;u<d;u++){const m=lt(f);if(m<0)continue;const p=i[m],{x:y,y:w,density:A}=p,I=(Math.random()*(a.splat_size_range[1]-a.splat_size_range[0])+a.splat_size_range[0])*(.5+.5*A);let g=0;a.bleeding_factor>0&&h&&h[w][y]<5&&(g=-Math.log(Math.random())*a.bleeding_factor);const M=I+g,T=Math.min(255,Math.floor(100+155*A));l.push({x:y,y:w,size:M,opacity:T})}return l}function ft(o,t,e,n,r,a=!1){const s=document.createElement("canvas");s.width=e,s.height=n;const h=s.getContext("2d");if(!a){const[i,c,f]=r;h.fillStyle=`rgb(${i}, ${c}, ${f})`,h.fillRect(0,0,e,n)}return o.forEach((i,c)=>{const[f,d,l]=t[c],u=i.sort((m,p)=>p.size-m.size);for(const m of u)h.fillStyle=`rgba(${f}, ${d}, ${l}, ${m.opacity/255})`,h.beginPath(),h.ellipse(m.x,m.y,m.size/2,m.size/2,0,0,2*Math.PI),h.fill()}),h.getImageData(0,0,e,n)}function ht(o,t){const{data:e,width:n,height:r}=o,a=new Uint8ClampedArray(n*r*3);for(let g=0,M=0;g<e.length;g+=4,M+=3)a[M]=e[g],a[M+1]=e[g+1],a[M+2]=e[g+2];const s=G(a,t.background_threshold),h=t.num_colors==="auto"?15:t.num_colors,{colors:i,labels:c}=K(s,h),f=V(a,i,c,n,r,t),d=240,l=g=>g[0]>d&&g[1]>d&&g[2]>d,u=f.map((g,M)=>({mask:g,color:i[M],size:B(g)})).filter(g=>!l(g.color)).sort((g,M)=>M.size-g.size);if(u.length===0){const g=document.createElement("canvas");return g.width=n,g.height=r,g.getContext("2d").getImageData(0,0,n,r)}const m=u.map(g=>g.mask),p=u.map(g=>g.color),y=Q(m,n,r,t.shift,t.rotation),w=ot(y,n,r,t.edge_width,t.edge_boost),A=st(p.length,n,r,t),_=[];for(let g=0;g<y.length;g++){const M=it(y[g],w[g],A[g],n,r,t);_.push(M)}return ft(_,p,n,r,t.background_color,!0)}const _t={stamp_size:512,num_colors:"auto",background_threshold:5,color_shape_shrink:5,shift:[0,1],rotation:[0,1],edge_width:4,edge_boost:3,wear_intensity:[.1,.05],noise_scale:[50,5],rotation_angle:[0,0],ink_depletion_intensity:[.3,.05],num_patches:[2,1],patch_size_range:[20,100],splat_density:.75,splat_size_range:[1,2],bleeding_factor:.1,background_color:[255,255,255]};function dt(o,t){const e=document.createElement("canvas"),n=e.getContext("2d");if(!n)throw new Error("Could not create canvas context");const r=o.width/o.height,a=r>=1?t:t*r,s=r<1?t:t/r;return e.width=Math.ceil(a),e.height=Math.ceil(s),n.drawImage(o,0,0,e.width,e.height),e}async function wt(o,t){return new Promise((e,n)=>{setTimeout(()=>{try{const r=ht(o,t);e(r)}catch(r){n(r)}},0)})}const D=128;async function ut(o){const t=document.createElement("canvas"),e=o.width/o.height;t.width=D,t.height=D/e;const n=t.getContext("2d");return n?(n.drawImage(o,0,0,t.width,t.height),t.toDataURL("image/jpeg",.7)):""}function bt(){const{user:o}=P(),[t,e]=z.useState([]),[n,r]=z.useState(!0),{addToast:a}=H(),{t:s}=N();z.useEffect(()=>{o!=null&&o.id?(r(!0),v().then(d=>e(d)).catch(d=>{console.error("Failed to load stamps from DB",d),a(s("gallery.loadErrorToast"),"error")}).finally(()=>{r(!1)})):(e([]),r(!1))},[o==null?void 0:o.id,a,s]);const h=z.useCallback(()=>{o!=null&&o.id&&(r(!0),v().then(d=>e(d)).catch(d=>{console.error("Failed to load stamps from DB",d),a(s("gallery.loadErrorToast"),"error")}).finally(()=>{r(!1)}))},[o==null?void 0:o.id,a,s]),i=z.useCallback(async(d,l,u)=>{if(!o){a(s("gallery.loginToast"),"info");return}try{const m=dt(d,l.stamp_size),p=m.toDataURL("image/jpeg",.7),y=await ut(m),w={user_id:o.id,name:u,thumbnail:y,settings:l,sourceImageURL:p},A=await W(w);e(_=>[A,..._]),a(s("gallery.addSuccessToast",{name:u}),"success"),h()}catch(m){console.error("Failed to add stamp to gallery:",m),a(s("gallery.addErrorToast"),"error"),e(p=>p.filter(y=>y.user_id===o.id))}},[a,o,s]),c=z.useCallback(async d=>{const l=t;e(u=>u.filter(m=>m.id!==d));try{await $(d),a(s("gallery.deleteSuccessToast"),"info")}catch(u){console.error("Failed to delete stamp:",u),a(s("gallery.deleteErrorToast"),"error"),e(l)}},[a,t,s]),f=z.useCallback(async(d,l)=>{const u=[...t],m=t.find(y=>y.id===d);if(!m)return;const p=m.name;e(y=>y.map(w=>w.id===d?{...w,name:l}:w));try{await j(d,l),a(s("gallery.renameSuccessToast",{name:l}),"success")}catch(y){console.error("Failed to rename stamp:",y),a(s("gallery.renameErrorToast",{oldName:p}),"error"),e(u)}},[a,t,s]);return{stamps:t,loading:n,addStampToGallery:i,deleteStampFromGallery:c,renameStampInGallery:f}}export{dt as c,_t as d,wt as g,bt as u};
