var R=Object.defineProperty;var q=(o,t,n)=>t in o?R(o,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[t]=n;var S=(o,t,n)=>q(o,typeof t!="symbol"?t+"":t,n);import{r as k}from"./react-vendor-CzGlubEb.js";import{b as L,a as P,u as H,j as N,k as W,l as $,m as U}from"./index-BTQ1ARHp.js";const z=(o=0,t=1)=>{const n=Math.random(),e=Math.random();return Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*e)*t+o};class _{constructor(t,n,e){S(this,"data");S(this,"width");S(this,"height");this.width=n,this.height=t;const r=n*t;if(e instanceof Float32Array){if(e.length!==r)throw new Error("Data array does not match matrix dimensions");this.data=e}else this.data=new Float32Array(r),typeof e=="number"&&this.data.fill(e)}static ones(t,n){return new _(t,n,1)}static zeros(t,n){return new _(t,n,0)}get(t,n){return t<0||t>=this.height||n<0||n>=this.width?0:this.data[t*this.width+n]}set(t,n,e){t>=0&&t<this.height&&n>=0&&n<this.width&&(this.data[t*this.width+n]=e)}clone(){return new _(this.height,this.width,new Float32Array(this.data))}getBilinear(t,n){const e=Math.floor(t),r=Math.floor(n),a=Math.ceil(t),s=Math.ceil(n);if(e<0||a>=this.height||r<0||s>=this.width)return 0;const h=this.get(e,r),f=this.get(e,s),c=this.get(a,r),i=this.get(a,s),u=t-e,l=n-r,d=h*(1-l)+f*l,m=c*(1-l)+i*l;return d*(1-u)+m*u}}function D(o,t){const n=_.zeros(o.height,o.width);for(let e=0;e<o.data.length;e++)n.data[e]=o.data[e]*t.data[e];return n}function j(o,t,n,e,r){const a=_.zeros(o.height,o.width);for(let s=0;s<o.data.length;s++)a.data[s]=o.data[s]*t+n.data[s]*e+r;return a}function F(o){const t=o.clone();let n=1/0,e=-1/0;for(let a=0;a<t.data.length;a++)t.data[a]<n&&(n=t.data[a]),t.data[a]>e&&(e=t.data[a]);const r=e-n;if(r>0)for(let a=0;a<t.data.length;a++)t.data[a]=(t.data[a]-n)/r;return t}function O(o){let t=0;for(let n=0;n<o.data.length;n++)o.data[n]!==0&&t++;return t}const E=240,X=10,B=1;function G(o,t){const n=[];for(let e=0;e<o.length;e+=3){const r=o[e],a=o[e+1],s=o[e+2],h=(r+a+s)/3,f=r>E&&a>E&&s>E;h>t&&!f&&n.push(r,a,s)}return new Float32Array(n)}function v(o,t){return Math.sqrt((o[0]-t[0])**2+(o[1]-t[1])**2+(o[2]-t[2])**2)}function K(o,t){if(o.length===0||t===0)return{colors:[],labels:new Int32Array(0)};const n=o.length/3,e=[];for(let f=0;f<o.length;f+=3)e.push([o[f],o[f+1],o[f+2]]);n<t&&(t=n);let r=[];const a=new Set;for(;r.length<t;){const f=Math.floor(Math.random()*n);a.has(f)||(r.push([...e[f]]),a.add(f))}const s=new Int32Array(n);for(let f=0;f<X;f++){for(let l=0;l<n;l++){let d=1/0,m=0;for(let p=0;p<r.length;p++){const y=v(e[l],r[p]);y<d&&(d=y,m=p)}s[l]=m}const c=Array(r.length).fill(0).map(()=>[0,0,0]),i=new Array(r.length).fill(0);for(let l=0;l<n;l++){const d=s[l];c[d][0]+=e[l][0],c[d][1]+=e[l][1],c[d][2]+=e[l][2],i[d]++}let u=!0;for(let l=0;l<r.length;l++){if(i[l]>0)c[l][0]/=i[l],c[l][1]/=i[l],c[l][2]/=i[l];else{const d=Math.floor(Math.random()*n);c[l]=[...e[d]]}v(c[l],r[l])>B&&(u=!1)}if(r=c,u)break}return{colors:r.map(f=>f.map(Math.round)),labels:s}}function Y(o,t){const n=_.zeros(o.height,o.width),e=Math.floor(t/2);for(let r=0;r<o.height;r++)for(let a=0;a<o.width;a++){let s=255;for(let h=-e;h<=e;h++)for(let f=-e;f<=e;f++)s=Math.min(s,o.get(r+h,a+f));n.set(r,a,s)}return n}function V(o,t,n,e,r,a){const s=new Array(e*r).fill(-1);let h=0;for(let c=0;c<o.length;c+=3){const i=o[c],u=o[c+1],l=o[c+2],d=(i+u+l)/3,m=i>E&&u>E&&l>E;d>a.background_threshold&&!m&&(s[c/3]=n[h],h++)}const f=[];for(let c=0;c<t.length;c++){const i=new Float32Array(e*r);for(let l=0;l<s.length;l++)i[l]=s[l]===c?255:0;let u=new _(r,e,i);a.color_shape_shrink>0&&(u=Y(u,a.color_shape_shrink)),f.push(u)}return f}function Z(o,t,n){const e=t*Math.PI/180,r=n*Math.cos(e),a=n*Math.sin(e);return[r,a,(1-r)*o.x-a*o.y,-a,r,a*o.x+(1-r)*o.y]}function J(o,t,n,e){const r=_.zeros(e,n),[a,s,h,f,c,i]=t,u=a*c-s*f;if(Math.abs(u)<1e-6)return r;const l=1/u,d=c*l,m=-s*l,p=(s*i-c*h)*l,y=-f*l,A=a*l,b=(f*h-a*i)*l;for(let w=0;w<e;w++)for(let I=0;I<n;I++){const g=d*I+m*w+p,M=y*I+A*w+b,T=o.getBilinear(M,g);r.set(w,I,T)}return r}function Q(o,t,n,e,r){return o.map(a=>{const s=z(...e),h=z(...e),f=z(...r),c=Z({x:t/2,y:n/2},f,1);return c[2]+=s,c[5]+=h,J(a,c,t,n)})}function C(o){var f;const t=o.length,n=((f=o[0])==null?void 0:f.length)||0,e=Array(t).fill(null).map(()=>Array(n));for(let c=0;c<t;c++)for(let i=0;i<n;i++)e[c][i]=o[c][i]>127;const r=Array(t).fill(null).map(()=>Array(n));for(let c=0;c<t;c++)tt(e[c],r[c]);const a=Array(t).fill(null).map(()=>Array(n)),s=Array(t),h=Array(t);for(let c=0;c<n;c++){for(let i=0;i<t;i++)s[i]=r[i][c];et(s,h);for(let i=0;i<t;i++)a[i][c]=Math.sqrt(h[i])}return a}function tt(o,t){const n=o.length;let e=1/0;for(let r=0;r<n;r++)o[r]?e++:e=0,t[r]=e*e;e=1/0;for(let r=n-1;r>=0;r--)o[r]?e++:e=0,t[r]=Math.min(t[r],e*e)}function et(o,t){const n=o.length;if(n===0)return;const e=Array(n),r=Array(n+1);let a=0;e[0]=0,r[0]=-1/0,r[1]=1/0;for(let s=1;s<n;s++){let h=(o[s]+s*s-(o[e[a]]+e[a]*e[a]))/(2*s-2*e[a]);for(;h<=r[a];)a--,h=(o[s]+s*s-(o[e[a]]+e[a]*e[a]))/(2*s-2*e[a]);a++,e[a]=s,r[a]=h,r[a+1]=1/0}a=0;for(let s=0;s<n;s++){for(;r[a+1]<s;)a++;t[s]=(s-e[a])*(s-e[a])+o[e[a]]}}function nt(o,t,n){const e=Array(n).fill(null).map(()=>Array(t));for(let r=0;r<n;r++)for(let a=0;a<t;a++)e[r][a]=o.get(r,a);return C(e)}function ot(o,t,n,e,r){return o.map(a=>{const s=Array(n).fill(0).map(()=>Array(t).fill(0));for(let c=0;c<n;c++)for(let i=0;i<t;i++)s[c][i]=a.get(c,i);const h=C(s),f=_.ones(n,t);for(let c=0;c<n;c++)for(let i=0;i<t;i++){const u=h[c][i];for(let l=1;l<=e;l++)if(u>l-1&&u<=l){const d=r*(e-l+1)/e;f.set(c,i,d);break}}return f})}function rt(o,t,n){const e=_.zeros(t,o);for(let r=0;r<3;r++){const a=2**r,s=1/a,h=1/a;for(let f=0;f<t;f++)for(let c=0;c<o;c++){const i=h*Math.sin(c*s*2*Math.PI/n)*Math.sin(f*s*2*Math.PI/n),u=e.get(f,c);e.set(f,c,u+i)}}return F(e)}function at(o,t,n,e,r){const a=_.ones(t,o);if(r<=0||n<=0)return a;for(let s=0;s<n;s++){const h=Math.random()*(e[1]-e[0])+e[0],f=Math.random()*o,c=Math.random()*t,i=Math.max(0,Math.floor(f-h)),u=Math.min(o,Math.ceil(f+h)),l=Math.max(0,Math.floor(c-h)),d=Math.min(t,Math.ceil(c+h));for(let m=l;m<d;m++)for(let p=i;p<u;p++){const y=Math.sqrt((p-f)**2+(m-c)**2);if(y<h){const b=1-(y/h)**2,w=1-r*b;a.get(m,p)>w&&a.set(m,p,w)}}}return a}function st(o,t,n,e){const r=[];for(let a=0;a<o;a++){const s=z(...e.noise_scale),h=rt(t,n,s),f=Math.round(z(...e.num_patches)),c=z(...e.ink_depletion_intensity),i=at(t,n,f,e.patch_size_range,c),u=z(...e.wear_intensity),l=_.ones(n,t);let d=j(h,u,l,1-u,0);d=D(d,i),d=F(d),r.push(d)}return r}function ct(o,t){const n=[];let e=0;for(let r=0;r<o.length;r++){const a=t>0?o[r].density/t:1/o.length;e+=a,n.push(e)}return n.length>0&&(n[n.length-1]=1),n}function lt(o){const t=Math.random();let n=0,e=o.length-1;if(o.length===0)return-1;if(t<=o[0])return 0;if(t>=o[o.length-1])return o.length-1;for(;n<e;){const r=Math.floor((n+e)/2);o[r]<t?n=r+1:e=r}return n}function it(o,t,n,e,r,a){const s=D(t,n);let h=null;a.bleeding_factor>0&&(h=nt(o,e,r));const f=[];let c=0;for(let d=0;d<r;d++)for(let m=0;m<e;m++)if(o.get(d,m)>127){const p=s.get(d,m);f.push({x:m,y:d,density:p}),c+=p}if(f.length===0)return[];const i=ct(f,c),u=Math.floor(a.splat_density*f.length),l=[];for(let d=0;d<u;d++){const m=lt(i);if(m<0)continue;const p=f[m],{x:y,y:A,density:b}=p,I=(Math.random()*(a.splat_size_range[1]-a.splat_size_range[0])+a.splat_size_range[0])*(.5+.5*b);let g=0;a.bleeding_factor>0&&h&&h[A][y]<5&&(g=-Math.log(Math.random())*a.bleeding_factor);const M=I+g,T=Math.min(255,Math.floor(100+155*b));l.push({x:y,y:A,size:M,opacity:T})}return l}function ft(o,t,n,e,r,a=!1){const s=document.createElement("canvas");s.width=n,s.height=e;const h=s.getContext("2d");if(!a){const[f,c,i]=r;h.fillStyle=`rgb(${f}, ${c}, ${i})`,h.fillRect(0,0,n,e)}return o.forEach((f,c)=>{const[i,u,l]=t[c],d=f.sort((m,p)=>p.size-m.size);for(const m of d)h.fillStyle=`rgba(${i}, ${u}, ${l}, ${m.opacity/255})`,h.beginPath(),h.ellipse(m.x,m.y,m.size/2,m.size/2,0,0,2*Math.PI),h.fill()}),h.getImageData(0,0,n,e)}function ht(o,t){const{data:n,width:e,height:r}=o,a=new Uint8ClampedArray(e*r*3);for(let g=0,M=0;g<n.length;g+=4,M+=3)a[M]=n[g],a[M+1]=n[g+1],a[M+2]=n[g+2];const s=G(a,t.background_threshold),h=t.num_colors==="auto"?15:t.num_colors,{colors:f,labels:c}=K(s,h),i=V(a,f,c,e,r,t),u=240,l=g=>g[0]>u&&g[1]>u&&g[2]>u,d=i.map((g,M)=>({mask:g,color:f[M],size:O(g)})).filter(g=>!l(g.color)).sort((g,M)=>M.size-g.size);if(d.length===0){const g=document.createElement("canvas");return g.width=e,g.height=r,g.getContext("2d").getImageData(0,0,e,r)}const m=d.map(g=>g.mask),p=d.map(g=>g.color),y=Q(m,e,r,t.shift,t.rotation),A=ot(y,e,r,t.edge_width,t.edge_boost),b=st(p.length,e,r,t),w=[];for(let g=0;g<y.length;g++){const M=it(y[g],A[g],b[g],e,r,t);w.push(M)}return ft(w,p,e,r,t.background_color,!0)}const _t={stamp_size:500,num_colors:"auto",background_threshold:5,color_shape_shrink:5,shift:[0,1],rotation:[0,1],edge_width:4,edge_boost:3,wear_intensity:[.1,.05],noise_scale:[50,5],rotation_angle:[0,0],ink_depletion_intensity:[.3,.05],num_patches:[2,1],patch_size_range:[20,100],splat_density:.75,splat_size_range:[1,2],bleeding_factor:.1,background_color:[255,255,255]};function dt(o,t){const n=document.createElement("canvas"),e=n.getContext("2d");if(!e)throw new Error("Could not create canvas context");const r=o.width/o.height,a=r>=1?t:t*r,s=r<1?t:t/r;return n.width=Math.ceil(a),n.height=Math.ceil(s),e.drawImage(o,0,0,n.width,n.height),n}async function wt(o,t){return new Promise((n,e)=>{setTimeout(()=>{try{const r=ht(o,t);n(r)}catch(r){e(r)}},0)})}const x=128;async function ut(o){const t=document.createElement("canvas"),n=o.width/o.height;t.width=x,t.height=x/n;const e=t.getContext("2d");return e?(e.drawImage(o,0,0,t.width,t.height),t.toDataURL("image/png")):""}function bt(){const{user:o}=L(),[t,n]=k.useState([]),[e,r]=k.useState(!0),{addToast:a}=P(),{t:s}=H();k.useEffect(()=>{o!=null&&o.id?(r(!0),N().then(i=>n(i)).catch(i=>{console.error("Failed to load stamps from DB",i),a(s("gallery.loadErrorToast"),"error")}).finally(()=>{r(!1)})):(n([]),r(!1))},[o==null?void 0:o.id,a,s]);const h=k.useCallback(async(i,u,l)=>{if(!o){a(s("gallery.loginToast"),"info");return}try{const d=dt(i,u.stamp_size),m=d.toDataURL("image/png"),p=await ut(d),y={user_id:o.id,name:l,thumbnail:p,settings:u,sourceImageURL:m},A=await W(y);n(b=>[A,...b]),a(s("gallery.addSuccessToast",{name:l}),"success")}catch(d){console.error("Failed to add stamp to gallery:",d),a(s("gallery.addErrorToast"),"error"),n(m=>m.filter(p=>p.user_id===o.id))}},[a,o,s]),f=k.useCallback(async i=>{const u=t;n(l=>l.filter(d=>d.id!==i));try{await $(i),a(s("gallery.deleteSuccessToast"),"info")}catch(l){console.error("Failed to delete stamp:",l),a(s("gallery.deleteErrorToast"),"error"),n(u)}},[a,t,s]),c=k.useCallback(async(i,u)=>{const l=[...t],d=t.find(p=>p.id===i);if(!d)return;const m=d.name;n(p=>p.map(y=>y.id===i?{...y,name:u}:y));try{await U(i,u),a(s("gallery.renameSuccessToast",{name:u}),"success")}catch(p){console.error("Failed to rename stamp:",p),a(s("gallery.renameErrorToast",{oldName:m}),"error"),n(l)}},[a,t,s]);return{stamps:t,loading:e,addStampToGallery:h,deleteStampFromGallery:f,renameStampInGallery:c}}export{dt as c,_t as d,wt as g,bt as u};
