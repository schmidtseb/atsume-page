import{r,j as d}from"./react-vendor-Duv3WysG.js";const S=4e3,I=3e3,W=.1,z=2,K=5,L=200;function it({onPlaceRequest:h,isPlacementDisabled:f=!1,isPanOnly:p=!1}){const[i,u]=r.useState({x:0,y:0,scale:1}),[a,v]=r.useState({width:0,height:0}),[l,y]=r.useState("idle"),[m,C]=r.useState(!1),[o,R]=r.useState(null),[X,j]=r.useState(null),[M,B]=r.useState(null),w=r.useRef(i),g=r.useRef({clientX:0,clientY:0,viewX:0,viewY:0}),A=r.useRef({dist:0,midX:0,midY:0,initialTransform:{x:0,y:0,scale:1}}),F=r.useRef(0),$=r.useRef(!1);r.useEffect(()=>{w.current=i},[i]);const Y=r.useCallback(t=>{const{width:e,height:n}=a,c=Math.max(W,Math.min(z,t.scale)),s=e>S*c?(e-S*c)/2:Math.max(e-S*c-L,Math.min(L,t.x)),x=n>I*c?(n-I*c)/2:Math.max(n-I*c-L,Math.min(L,t.y));return{x:s,y:x,scale:c}},[a]),E=r.useCallback((t,e)=>{const{x:n,y:c,scale:s}=w.current;return{x:(t-n)/s,y:(e-c)/s}},[]);r.useEffect(()=>{if(M&&(M.width=S,M.height=I,!$.current&&a.width>0&&a.height>0)){const t=Math.min(a.width/S,a.height/I,.8),e=Y({scale:t,x:(a.width-S*t)/2,y:(a.height-I*t)/2});u(e),$.current=!0}},[a,M,Y]),r.useEffect(()=>{$.current&&a.width>0&&a.height>0&&u(t=>Y(t))},[a,Y]),r.useEffect(()=>{if(!X)return;const t=new ResizeObserver(e=>{for(const n of e){const{width:c,height:s}=n.contentRect;v({width:c,height:s})}});return t.observe(X),()=>t.disconnect()},[X]);const _=r.useCallback(t=>{if(t.preventDefault(),t.stopPropagation(),!X)return;const{clientX:e,clientY:n,deltaY:c}=t,s=X.getBoundingClientRect();u(x=>{const k=1-c*.001,V=x.scale*k,b=Math.max(W,Math.min(z,V));if(b===x.scale)return x;const G=(e-s.left-x.x)/x.scale,H=(n-s.top-x.y)/x.scale,O=e-s.left-G*b,T=n-s.top-H*b;return Y({scale:b,x:O,y:T})})},[X,Y]);r.useEffect(()=>{if(X)return X.addEventListener("wheel",_,{passive:!1}),()=>X.removeEventListener("wheel",_)},[X,_]),r.useEffect(()=>{const t=n=>{var c,s;n.code==="Space"&&!n.repeat&&((c=document.activeElement)==null?void 0:c.tagName)!=="INPUT"&&((s=document.activeElement)==null?void 0:s.tagName)!=="TEXTAREA"&&(n.preventDefault(),C(!0))},e=n=>{n.code==="Space"&&(n.preventDefault(),C(!1),l==="panning"&&y("idle"))};return document.addEventListener("keydown",t),document.addEventListener("keyup",e),()=>{document.removeEventListener("keydown",t),document.removeEventListener("keyup",e)}},[l]);const Z=r.useCallback(t=>{if(t.button!==0&&t.button!==1)return;if(m||p||t.button===1||f)y("panning"),g.current={clientX:t.clientX,clientY:t.clientY,viewX:i.x,viewY:i.y};else{y("stamping");const n=t.currentTarget.getBoundingClientRect(),c=E(t.clientX-n.left,t.clientY-n.top);R({start:c,current:c}),g.current={clientX:t.clientX,clientY:t.clientY,viewX:0,viewY:0}}},[m,p,f,i,E]),q=r.useCallback(t=>{if(l==="panning"&&M){const e=t.clientX-g.current.clientX,n=t.clientY-g.current.clientY,c={x:g.current.viewX,y:g.current.viewY,scale:i.scale},s=Y({...c,x:c.x+e,y:c.y+n});w.current=s,M.style.transform=`translate(${s.x}px, ${s.y}px) scale(${s.scale})`}else if(l==="stamping"&&o){const e=t.currentTarget.getBoundingClientRect(),n=E(t.clientX-e.left,t.clientY-e.top);R({...o,current:n})}},[l,i.scale,Y,o,E,M]),U=r.useCallback(t=>{if(l==="panning")u(w.current);else if(l==="stamping"&&o){const e=Math.hypot(t.clientX-g.current.clientX,t.clientY-g.current.clientY);let n=0;if(e>=K){const c=o.current.x-o.start.x,s=o.current.y-o.start.y;n=Math.atan2(s,c)*180/Math.PI}h(o.start.x,o.start.y,n)}y("idle"),R(null)},[l,o,h]),J=r.useCallback(t=>{if(t.touches.length>=2){y("pinching");const e=t.touches[0],n=t.touches[1],c=Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY);A.current={dist:c,midX:(e.clientX+n.clientX)/2,midY:(e.clientY+n.clientY)/2,initialTransform:{...i}};return}if(t.touches.length===1){const e=t.touches[0];if(f||(m||p)){y("panning"),g.current={clientX:e.clientX,clientY:e.clientY,viewX:i.x,viewY:i.y};return}y("stamping");const c=t.currentTarget.getBoundingClientRect(),s=E(e.clientX-c.left,e.clientY-c.top);R({start:s,current:s}),g.current={clientX:e.clientX,clientY:e.clientY,viewX:0,viewY:0},"force"in e&&(F.current=e.force)}},[m,p,f,i,E]),Q=r.useCallback(t=>{if(l==="pinching"&&t.touches.length>=2&&M){const e=t.touches[0],n=t.touches[1],c=(e.clientX+n.clientX)/2,s=(e.clientY+n.clientY)/2,x=Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY),{initialTransform:k,dist:V}=A.current,b=t.currentTarget.getBoundingClientRect(),G=(A.current.midX-b.left-k.x)/k.scale,H=(A.current.midY-b.top-k.y)/k.scale,O=x/V,T=k.scale*O,et=c-b.left-G*T,nt=s-b.top-H*T,D=Y({x:et,y:nt,scale:T});w.current=D,M.style.transform=`translate(${D.x}px, ${D.y}px) scale(${D.scale})`}else if(l==="stamping"&&t.touches.length===1&&o){const e=t.touches[0],n=t.currentTarget.getBoundingClientRect(),c=E(e.clientX-n.left,e.clientY-n.top);R({...o,current:c}),"force"in e&&(F.current=e.force)}else if(l==="panning"&&t.touches.length===1&&M){const e=t.touches[0],n=e.clientX-g.current.clientX,c=e.clientY-g.current.clientY,s={x:g.current.viewX,y:g.current.viewY,scale:i.scale},x=Y({...s,x:s.x+n,y:s.y+c});w.current=x,M.style.transform=`translate(${x.x}px, ${x.y}px) scale(${x.scale})`}},[l,i.scale,Y,o,E,M]),P=r.useCallback(t=>{if(l==="panning"||l==="pinching")u(w.current);else if(l==="stamping"&&t.changedTouches.length===1&&o){const e=t.changedTouches[0],n=Math.hypot(e.clientX-g.current.clientX,e.clientY-g.current.clientY);let c=0;if(n>=K){const s=o.current.x-o.start.x,x=o.current.y-o.start.y;c=Math.atan2(x,s)*180/Math.PI}h(o.start.x,o.start.y,c),F.current=0}t.touches.length<2&&(y("idle"),R(null))},[l,o,h]),tt=r.useCallback(()=>{u(t=>({...t}))},[]);return r.useEffect(()=>()=>{$.current=!1},[]),{viewTransform:i,viewTransformRef:w,viewportSize:a,isPanning:l==="panning"||l==="pinching",isPanMode:m||p,stampPreview:o,containerProps:{onMouseDown:Z,onMouseMove:q,onMouseUp:U,onMouseLeave:U,onTouchStart:J,onTouchMove:Q,onTouchEnd:P},forceCanvasUpdate:tt,containerRef:j,canvasRef:B,canvasNode:M}}const N=160,ct=({mainCanvas:h,viewTransformRef:f,viewportSize:p,canvasWidth:i,canvasHeight:u})=>{const a=r.useRef(null),v=r.useRef(null),l=i/u,y=N/l;return r.useEffect(()=>{if(!h||!a.current)return;const m=a.current.getContext("2d",{alpha:!1});if(!m)return;const C=()=>{if(!p.width||!p.height){v.current=requestAnimationFrame(C);return}m.fillStyle="#f7f3e9",m.fillRect(0,0,N,y),m.drawImage(h,0,0,N,y);const o=f.current;if(!o){v.current=requestAnimationFrame(C);return}const{x:R,y:X,scale:j}=o,M=-R/j*(N/i),B=-X/j*(y/u),w=p.width/j*(N/i),g=p.height/j*(y/u);m.strokeStyle="rgba(0, 150, 255, 1)",m.lineWidth=1.5,m.strokeRect(M,B,w,g),v.current=requestAnimationFrame(C)};return v.current=requestAnimationFrame(C),()=>{v.current&&cancelAnimationFrame(v.current)}},[h,f,p,i,u,y]),d.jsx("div",{className:"absolute bottom-4 right-4 z-20 bg-gray-900/70 backdrop-blur-sm p-1 rounded-lg shadow-lg border border-gray-700 pointer-events-none","aria-hidden":"true",children:d.jsx("canvas",{ref:a,width:N,height:y,className:"rounded-md"})})},st=({stampPreview:h,viewTransform:f})=>{if(!(h!=null&&h.start)||!h.current)return null;const p=h.start.x*f.scale+f.x,i=h.start.y*f.scale+f.y,u=h.current.x*f.scale+f.x,a=h.current.y*f.scale+f.y;return Math.hypot(u-p,a-i)<5?null:d.jsxs("svg",{className:"absolute top-0 left-0 w-full h-full pointer-events-none z-50","aria-hidden":"true",children:[d.jsx("defs",{children:d.jsxs("filter",{id:"glow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[d.jsx("feGaussianBlur",{stdDeviation:"3",result:"coloredBlur"}),d.jsxs("feMerge",{children:[d.jsx("feMergeNode",{in:"coloredBlur"}),d.jsx("feMergeNode",{in:"SourceGraphic"})]})]})}),d.jsxs("g",{style:{filter:"url(#glow)"},children:[d.jsx("circle",{cx:p,cy:i,r:"8",stroke:"rgba(0, 0, 0, 0.5)",strokeWidth:"2",fill:"rgba(255, 255, 255, 0.8)"}),d.jsx("line",{x1:p,y1:i,x2:u,y2:a,stroke:"rgba(255, 255, 255, 0.8)",strokeWidth:"2",strokeDasharray:"4,4"}),d.jsx("circle",{cx:u,cy:a,r:"4",fill:"rgba(255, 255, 255, 0.8)"})]})]})},ot=({canvasRef:h,containerRef:f,canvasNode:p,containerProps:i,viewTransform:u,viewTransformRef:a,viewportSize:v,isPanning:l,stampPreview:y,cursorClass:m,ariaLabel:C})=>d.jsxs(d.Fragment,{children:[d.jsxs("div",{ref:f,className:`relative w-full h-full bg-paper-texture overflow-hidden touch-none ${m} ${l?"cursor-grabbing":""}`,...i,children:[d.jsx("canvas",{ref:h,className:"bg-white shadow-xl","aria-label":C,style:{position:"absolute",top:0,left:0,height:I,width:S,transform:`translate(${u.x}px, ${u.y}px) scale(${u.scale})`,transformOrigin:"0 0",willChange:"transform"}}),d.jsx(ct,{mainCanvas:p,viewTransformRef:a,viewportSize:v,canvasWidth:S,canvasHeight:I})]}),d.jsx(st,{stampPreview:y,viewTransform:u})]});export{ot as I,it as u};
