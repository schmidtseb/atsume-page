import{r as i,j as e,a as A,a1 as R,a2 as k,a3 as S,a4 as D,W as E,w as T,z as v,a5 as _}from"./react-vendor-CFcoa3xO.js";import{u as C,b as I,a as L,q,r as z,t as B,v as M}from"./index-BDiqkb2Y.js";import"./vendor-DF1CirjX.js";import"./maplibre-gl-vendor-Csyg3Y42.js";import"./supabase-vendor-BAWLRfpT.js";const P=({rally:r,onUpdate:t,onDelete:s,onManage:n})=>{const{t:l}=C(),[c,h]=i.useState(!1),[x,g]=i.useState(r.name),[p,b]=i.useState(r.description||""),[j,f]=i.useState(!1),w=()=>{t(r.id,{name:x,description:p}),h(!1)},N=()=>{navigator.clipboard.writeText(r.access_code),f(!0),setTimeout(()=>f(!1),2e3)};return e.jsxs("div",{className:"bg-gray-800 border border-gray-700 rounded-xl p-4 flex flex-col gap-4",children:[c?e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("input",{type:"text",value:x,onChange:a=>g(a.target.value),className:"w-full bg-gray-900 text-white placeholder-gray-500 px-3 py-2 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none"}),e.jsx("textarea",{value:p,onChange:a=>b(a.target.value),rows:2,className:"w-full bg-gray-900 text-white placeholder-gray-500 px-3 py-2 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none"}),e.jsx("button",{onClick:w,className:"bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg",children:l("common.save")})]}):e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold truncate",children:r.name}),e.jsx("p",{className:"text-gray-400 text-sm min-h-[2.5rem]",children:r.description||l("rallyAdmin.noDescription")})]}),e.jsxs("div",{className:"bg-gray-900/50 p-3 rounded-lg flex items-center justify-between gap-2",children:[e.jsxs("span",{className:"text-sm text-gray-400",children:[l("rallyAdmin.accessCode"),":"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-mono text-lg text-blue-400 tracking-widest",children:r.access_code}),e.jsx("button",{onClick:N,className:"p-1 text-gray-400 hover:text-white",children:j?e.jsx(A,{className:"w-4 h-4 text-green-400"}):e.jsx(R,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2 text-sm",children:[e.jsxs("span",{className:"text-gray-400",children:[l("rallyAdmin.status"),":"]}),e.jsxs("button",{onClick:()=>t(r.id,{published:!r.published}),className:`flex items-center gap-1.5 px-2 py-1 rounded-full font-medium transition-colors ${r.published?"bg-green-500/10 text-green-400 hover:bg-green-500/20":"bg-red-500/10 text-red-400 hover:bg-red-500/20"}`,children:[r.published?e.jsx(k,{className:"w-4 h-4"}):e.jsx(S,{className:"w-4 h-4"}),r.published?l("rallyAdmin.published"):l("rallyAdmin.draft")]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 pt-2 border-t border-gray-700",children:[e.jsxs("button",{onClick:()=>n(r),className:"col-span-3 w-full bg-blue-600 hover:bg-blue-700 font-bold py-2.5 px-4 rounded-lg transition-colors flex items-center justify-center gap-2",children:[e.jsx(D,{className:"w-4 h-4"})," ",l("rallyAdmin.manageRally")]}),e.jsx("button",{onClick:()=>h(!c),className:"col-span-2 p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors","aria-label":l("common.edit"),children:e.jsx(E,{className:"w-4 h-4 mx-auto"})}),e.jsx("button",{onClick:()=>s(r.id),className:"p-2 bg-red-900/50 text-red-400 hover:bg-red-900/80 rounded-lg transition-colors","aria-label":l("common.delete"),children:e.jsx(T,{className:"w-4 h-4 mx-auto"})})]})]})},G=({onManageRally:r})=>{const{user:t}=I(),{t:s}=C(),{addToast:n}=L(),[l,c]=i.useState([]),[h,x]=i.useState(!0),[g,p]=i.useState(!1),b=i.useCallback(async()=>{if(!(t!=null&&t.id)){c([]),x(!1);return}try{x(!0);const a=await q(t.id);c(a)}catch(a){console.error(a),n(s("rallyAdmin.loadError"),"error")}finally{x(!1)}},[t==null?void 0:t.id,n,s]);i.useEffect(()=>{b()},[b]);const j=()=>Math.random().toString(36).substring(2,8).toUpperCase(),f=i.useCallback(async()=>{if(t&&!g){p(!0);try{const a={admin_id:t.id,name:s("rallyAdmin.newRallyName",{count:l.length+1}),access_code:j()},u=await z(a);c(o=>[u,...o]),n(s("rallyAdmin.createSuccess"),"success")}catch(a){console.error(a),n(s("rallyAdmin.createError"),"error")}finally{p(!1)}}},[t,l.length,n,s,g]),w=i.useCallback(async(a,u)=>{let o;if(c(m=>(o=m.find(d=>d.id===a),o?m.map(d=>d.id===a?{...d,...u}:d):(console.warn(`Rally with ID ${a} not found for optimistic update. Skipping.`),m))),!(!o||!(t!=null&&t.id)))try{await B(a,u,t.id),n(s("rallyAdmin.updateSuccess"),"success")}catch(m){console.error("Error updating rally in DB, attempting rollback:",m),n(s("rallyAdmin.updateError"),"error"),c(d=>o?(n(s("rallyAdmin.updateRollback"),"info"),d.map(y=>y.id===a?o:y)):d)}},[n,s]),N=i.useCallback(async a=>{if(!window.confirm(s("rallyAdmin.deleteConfirm")))return;const u=l.find(o=>o.id===a);if(u){c(o=>o.filter(m=>m.id!==a));try{await M(a,u.admin_id),n(s("rallyAdmin.deleteSuccess"),"info")}catch(o){console.error(o),n(s("rallyAdmin.deleteError"),"error"),c(m=>[...m,u].sort((d,y)=>new Date(y.created_at||0).getTime()-new Date(d.created_at||0).getTime()))}}},[l,n,s]);return e.jsxs("div",{className:"w-full h-full top-8 absolute bg-gray-900 text-white p-4 sm:p-6 lg:p-8 flex flex-col",children:[e.jsxs("header",{className:"pb-4 border-b border-gray-700",children:[e.jsx("h1",{className:"text-3xl font-bold",children:s("rallyAdmin.title")}),e.jsx("p",{className:"text-gray-400 mt-1",children:s("rallyAdmin.subtitle")})]}),e.jsx("div",{className:"flex-grow overflow-y-auto pt-6 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:h?e.jsx("div",{className:"flex justify-center items-center h-48",children:e.jsx(v,{className:"w-8 h-8 animate-spin"})}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("button",{onClick:f,disabled:g,className:"col-span-1 md:col-span-2 w-full flex items-center justify-center gap-3 p-6 bg-gray-800 border-2 border-dashed border-gray-600 rounded-xl hover:bg-gray-700 hover:border-blue-500 transition-colors text-blue-400 disabled:opacity-50",children:[g?e.jsx(v,{className:"w-6 h-6 animate-spin"}):e.jsx(_,{className:"w-6 h-6"}),e.jsx("span",{className:"text-lg font-semibold",children:s(g?"rallyAdmin.creating":"rallyAdmin.createButton")})]}),l.map(a=>e.jsx(P,{rally:a,onUpdate:w,onDelete:N,onManage:r},a.id))]})})})]})};export{G as default};
