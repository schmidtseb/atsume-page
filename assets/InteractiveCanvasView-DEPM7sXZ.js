import{r as s,j as d}from"./react-vendor-CFcoa3xO.js";const E=4e3,S=3e3,W=.1,z=2,K=5,L=200;function ot({onPlaceRequest:u,isPlacementDisabled:f=!1,isPanOnly:x=!1}){const[r,l]=s.useState({x:0,y:0,scale:1}),[a,v]=s.useState({width:0,height:0}),[h,p]=s.useState("idle"),[m,w]=s.useState(!1),[o,R]=s.useState(null),[X,k]=s.useState(null),[M,B]=s.useState(null),N=s.useRef(r),g=s.useRef({clientX:0,clientY:0,viewX:0,viewY:0}),D=s.useRef({dist:0,midX:0,midY:0,initialTransform:{x:0,y:0,scale:1}}),$=s.useRef(0),T=s.useRef(!1),F=s.useRef(!1);s.useEffect(()=>{N.current=r},[r]);const Y=s.useCallback(t=>{const{width:e,height:n}=a,c=Math.max(W,Math.min(z,t.scale)),i=e>E*c?(e-E*c)/2:Math.max(e-E*c-L,Math.min(L,t.x)),y=n>S*c?(n-S*c)/2:Math.max(n-S*c-L,Math.min(L,t.y));return{x:i,y,scale:c}},[a]),b=s.useCallback((t,e)=>{const{x:n,y:c,scale:i}=N.current;return{x:(t-n)/i,y:(e-c)/i}},[]);s.useEffect(()=>{if(M&&(M.width=E,M.height=S,!T.current&&a.width>0&&a.height>0)){const t=Math.min(a.width/E,a.height/S,.8),e=Y({scale:t,x:(a.width-E*t)/2,y:(a.height-S*t)/2});l(e),T.current=!0}},[a,M,Y]),s.useEffect(()=>{T.current&&a.width>0&&a.height>0&&l(t=>Y(t))},[a,Y]),s.useEffect(()=>{if(!X)return;const t=new ResizeObserver(e=>{for(const n of e){const{width:c,height:i}=n.contentRect;v({width:c,height:i})}});return t.observe(X),()=>t.disconnect()},[X]);const _=s.useCallback(t=>{if(t.preventDefault(),t.stopPropagation(),!X)return;const{clientX:e,clientY:n,deltaY:c}=t,i=X.getBoundingClientRect();l(y=>{const I=1-c*.001,H=y.scale*I,C=Math.max(W,Math.min(z,H));if(C===y.scale)return y;const V=(e-i.left-y.x)/y.scale,G=(n-i.top-y.y)/y.scale,O=e-i.left-V*C,A=n-i.top-G*C;return Y({scale:C,x:O,y:A})})},[X,Y]);s.useEffect(()=>{if(X)return X.addEventListener("wheel",_,{passive:!1}),()=>X.removeEventListener("wheel",_)},[X,_]),s.useEffect(()=>{const t=n=>{var c,i;n.code==="Space"&&!n.repeat&&((c=document.activeElement)==null?void 0:c.tagName)!=="INPUT"&&((i=document.activeElement)==null?void 0:i.tagName)!=="TEXTAREA"&&(n.preventDefault(),w(!0))},e=n=>{n.code==="Space"&&(n.preventDefault(),w(!1),h==="panning"&&p("idle"))};return document.addEventListener("keydown",t),document.addEventListener("keyup",e),()=>{document.removeEventListener("keydown",t),document.removeEventListener("keyup",e)}},[h]);const Z=s.useCallback(t=>{if(F.current){F.current=!1;return}if(t.button!==0&&t.button!==1)return;if(m||x||t.button===1||f)p("panning"),g.current={clientX:t.clientX,clientY:t.clientY,viewX:r.x,viewY:r.y};else{p("stamping");const n=t.currentTarget.getBoundingClientRect(),c=b(t.clientX-n.left,t.clientY-n.top);R({start:c,current:c}),g.current={clientX:t.clientX,clientY:t.clientY,viewX:0,viewY:0}}},[m,x,f,r,b]),q=s.useCallback(t=>{if(h==="panning"){const e=t.clientX-g.current.clientX,n=t.clientY-g.current.clientY,c={x:g.current.viewX,y:g.current.viewY,scale:r.scale},i=Y({...c,x:c.x+e,y:c.y+n});l(i)}else if(h==="stamping"&&o){const e=t.currentTarget.getBoundingClientRect(),n=b(t.clientX-e.left,t.clientY-e.top);R({...o,current:n})}},[h,r.scale,Y,o,b,M]),U=s.useCallback(t=>{if(h==="stamping"&&o){const e=Math.hypot(t.clientX-g.current.clientX,t.clientY-g.current.clientY);let n=0;if(e>=K){const c=o.current.x-o.start.x,i=o.current.y-o.start.y;n=Math.atan2(i,c)*180/Math.PI}u(o.start.x,o.start.y,n)}p("idle"),R(null)},[h,o,u]),J=s.useCallback(t=>{if(t.preventDefault(),t.touches.length>=2){p("pinching");const e=t.touches[0],n=t.touches[1],c=Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY);D.current={dist:c,midX:(e.clientX+n.clientX)/2,midY:(e.clientY+n.clientY)/2,initialTransform:{...r}};return}if(t.touches.length===1){const e=t.touches[0];if(m||x||f){p("panning"),g.current={clientX:e.clientX,clientY:e.clientY,viewX:r.x,viewY:r.y};return}p("stamping");const c=t.currentTarget.getBoundingClientRect(),i=b(e.clientX-c.left,e.clientY-c.top);R({start:i,current:i}),g.current={clientX:e.clientX,clientY:e.clientY,viewX:0,viewY:0},"force"in e&&($.current=e.force)}},[m,x,f,r,b]),Q=s.useCallback(t=>{if(h==="pinching"&&t.touches.length>=2&&M){const e=t.touches[0],n=t.touches[1],c=(e.clientX+n.clientX)/2,i=(e.clientY+n.clientY)/2,y=Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY),{initialTransform:I,dist:H}=D.current,C=t.currentTarget.getBoundingClientRect(),V=(D.current.midX-C.left-I.x)/I.scale,G=(D.current.midY-C.top-I.y)/I.scale,O=y/H,A=I.scale*O,et=c-C.left-V*A,nt=i-C.top-G*A,ct=Y({x:et,y:nt,scale:A});l(ct)}else if(h==="stamping"&&t.touches.length===1&&o){const e=t.touches[0],n=t.currentTarget.getBoundingClientRect(),c=b(e.clientX-n.left,e.clientY-n.top);R({...o,current:c}),"force"in e&&($.current=e.force)}else if(h==="panning"&&t.touches.length===1){const e=t.touches[0],n=e.clientX-g.current.clientX,c=e.clientY-g.current.clientY,i={x:g.current.viewX,y:g.current.viewY,scale:r.scale},y=Y({...i,x:i.x+n,y:i.y+c});l(y)}},[h,r.scale,Y,o,b,M]),P=s.useCallback(t=>{if(h==="stamping"&&t.changedTouches.length===1&&o){const e=t.changedTouches[0],n=Math.hypot(e.clientX-g.current.clientX,e.clientY-g.current.clientY);let c=0;if(n>=K){const i=o.current.x-o.start.x,y=o.current.y-o.start.y;c=Math.atan2(y,i)*180/Math.PI}u(o.start.x,o.start.y,c),$.current=0}t.touches.length<2&&(p("idle"),R(null),setTimeout(()=>{F.current=!1},500))},[h,o,u]),tt=s.useCallback(()=>{l(t=>({...t}))},[]);return s.useEffect(()=>{M&&(M.style.transform=`translate(${r.x}px, ${r.y}px) scale(${r.scale})`)},[r,M]),s.useEffect(()=>()=>{T.current=!1},[]),{viewTransform:r,viewTransformRef:N,viewportSize:a,isPanning:h==="panning"||h==="pinching",isPanMode:m||x,stampPreview:o,containerProps:{onMouseDown:Z,onMouseMove:q,onMouseUp:U,onMouseLeave:U,onTouchStart:J,onTouchMove:Q,onTouchEnd:P},forceCanvasUpdate:tt,containerRef:k,canvasRef:B,canvasNode:M,isInitialized:T.current}}const j=160,st=({mainCanvas:u,viewTransformRef:f,viewportSize:x,canvasWidth:r,canvasHeight:l})=>{const a=s.useRef(null),v=s.useRef(null),h=r/l,p=j/h;return s.useEffect(()=>{if(!u||!a.current)return;const m=a.current.getContext("2d",{alpha:!1});if(!m)return;const w=()=>{if(!x.width||!x.height){v.current=requestAnimationFrame(w);return}m.fillStyle="#f7f3e9",m.fillRect(0,0,j,p),m.drawImage(u,0,0,j,p);const o=f.current;if(!o){v.current=requestAnimationFrame(w);return}const{x:R,y:X,scale:k}=o,M=-R/k*(j/r),B=-X/k*(p/l),N=x.width/k*(j/r),g=x.height/k*(p/l);m.strokeStyle="rgba(0, 150, 255, 1)",m.lineWidth=1.5,m.strokeRect(M,B,N,g),v.current=requestAnimationFrame(w)};return v.current=requestAnimationFrame(w),()=>{v.current&&cancelAnimationFrame(v.current)}},[u,f,x,r,l,p]),d.jsx("div",{className:"absolute bottom-4 right-4 z-20 bg-gray-900/70 backdrop-blur-sm p-1 rounded-lg shadow-lg border border-gray-700 pointer-events-none","aria-hidden":"true",children:d.jsx("canvas",{ref:a,width:j,height:p,className:"rounded-md"})})},rt=({stampPreview:u,viewTransform:f})=>{if(!(u!=null&&u.start)||!u.current)return null;const x=u.start.x*f.scale+f.x,r=u.start.y*f.scale+f.y,l=u.current.x*f.scale+f.x,a=u.current.y*f.scale+f.y;return Math.hypot(l-x,a-r)<5?null:d.jsxs("svg",{className:"absolute top-0 left-0 w-full h-full pointer-events-none z-50","aria-hidden":"true",children:[d.jsx("defs",{children:d.jsxs("filter",{id:"glow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[d.jsx("feGaussianBlur",{stdDeviation:"3",result:"coloredBlur"}),d.jsxs("feMerge",{children:[d.jsx("feMergeNode",{in:"coloredBlur"}),d.jsx("feMergeNode",{in:"SourceGraphic"})]})]})}),d.jsxs("g",{style:{filter:"url(#glow)"},children:[d.jsx("circle",{cx:x,cy:r,r:"8",stroke:"rgba(0, 0, 0, 0.5)",strokeWidth:"2",fill:"rgba(255, 255, 255, 0.8)"}),d.jsx("line",{x1:x,y1:r,x2:l,y2:a,stroke:"rgba(255, 255, 255, 0.8)",strokeWidth:"2",strokeDasharray:"4,4"}),d.jsx("circle",{cx:l,cy:a,r:"4",fill:"rgba(255, 255, 255, 0.8)"})]})]})},at=({canvasRef:u,containerRef:f,canvasNode:x,containerProps:r,viewTransform:l,viewTransformRef:a,viewportSize:v,isPanning:h,stampPreview:p,cursorClass:m,ariaLabel:w,className:o})=>d.jsxs(d.Fragment,{children:[d.jsxs("div",{ref:f,className:`relative w-full h-full bg-paper-texture overflow-hidden touch-none ${m} ${h?"cursor-grabbing":""} ${o}`,...r,children:[d.jsx("canvas",{ref:u,className:"bg-white shadow-xl","aria-label":w,style:{position:"absolute",top:0,left:0,height:S,width:E,transform:`translate(${l.x}px, ${l.y}px) scale(${l.scale})`,transformOrigin:"0 0",willChange:"transform"}}),d.jsx(st,{mainCanvas:x,viewTransformRef:a,viewportSize:v,canvasWidth:E,canvasHeight:S})]}),d.jsx(rt,{stampPreview:p,viewTransform:l})]});export{at as I,ot as u};
