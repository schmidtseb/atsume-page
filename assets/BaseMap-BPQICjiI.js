import{r as u,j as S,K as R,N as _}from"./react-vendor-DJ-QoGxu.js";import{d as v,a as w,u as G,i as x,c as A,j as C,k as I}from"./index-CHHc0UA1.js";import{b as L}from"./maplibre-gl-vendor-Csyg3Y42.js";function j(i){const{user:o}=v(),[r,n]=u.useState([]),[M,p]=u.useState(!0),{addToast:a}=w(),{t:e}=G();u.useEffect(()=>{o!=null&&o.id&&i?(p(!0),x(i).then(t=>n(t)).catch(t=>{console.error("Failed to load geolocations from DB",t),a(e("geolocations.loadErrorToast"),"error")}).finally(()=>p(!1))):(n([]),p(!1))},[o==null?void 0:o.id,i,a,e]);const g=u.useCallback(async t=>{if(!o||!i){a(e("geolocations.loginToast"),"info");return}const d={user_id:o.id,rally_id:i,name:t.name,latitude:t.latitude,longitude:t.longitude,radius:t.radius,description:t.description??null,stamp_id:t.stamp_id??null};n(s=>[...s,{...d,id:"temp-id",created_at:new Date().toISOString()}]);try{const s=await A({user_id:o.id,rally_id:i,name:t.name,latitude:t.latitude,longitude:t.longitude,radius:t.radius,description:t.description??null,stamp_id:t.stamp_id??null});a(e("geolocations.addSuccessToast",{name:s.name}),"success"),n(h=>h.map(m=>m.id==="temp-id"?s:m))}catch(s){console.error("Failed to add geolocation:",s),a(e("geolocations.addErrorToast"),"error"),n(h=>h.filter(m=>m.id!=="temp-id"))}},[o,i,a,e]),c=u.useCallback(async(t,d)=>{const s=[...r];n(h=>h.map(m=>m.id===t?{...m,...d}:m));try{await C(t,d),a(e("geolocations.updateSuccessToast"),"success")}catch(h){console.error("Failed to update geolocation:",h),a(e("geolocations.updateErrorToast"),"error"),n(s)}},[r,a,e]),E=u.useCallback(async t=>{const d=[...r];n(s=>s.filter(h=>h.id!==t));try{await I(t),a(e("geolocations.deleteSuccessToast"),"info")}catch(s){console.error("Failed to delete geolocation:",s),a(e("geolocations.deleteErrorToast"),"error"),n(d)}},[r,a,e]);return{geolocations:r,loading:M,addGeolocation:g,updateGeolocation:c,deleteGeolocation:E}}function B(i,o,r,n){const p=i*Math.PI/180,a=r*Math.PI/180,e=(r-i)*Math.PI/180,g=(n-o)*Math.PI/180,c=Math.sin(e/2)*Math.sin(e/2)+Math.cos(p)*Math.cos(a)*Math.sin(g/2)*Math.sin(g/2);return 6371e3*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function $(i,o,r=64){const[n,M]=i,p={latitude:M,longitude:n},a=o/1e3,e=[],g=a/(111.32*Math.cos(p.latitude*Math.PI/180)),c=a/110.574;let E,t,d;for(let s=0;s<r;s++)E=s/r*(2*Math.PI),t=g*Math.cos(E),d=c*Math.sin(E),e.push([p.longitude+t,p.latitude+d]);return e.push(e[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[e]},properties:{}}}const z=({isVisible:i,onMapLoad:o,onGeolocate:r,onMapClick:n,children:M,className:p="",cursor:a="",mapRef:e})=>{const{addToast:g}=w(),{t:c}=G(),[E,t]=u.useState({longitude:-.09,latitude:51.505,zoom:3}),[d,s]=u.useState(!1),h=u.useRef(null),m=e||h,T=u.useRef(null),y=u.useRef(!1),b=l=>{let f=c("mapEditor.locationError.unknown");switch(l.code){case l.PERMISSION_DENIED:f=c("mapEditor.locationError.denied");break;case l.POSITION_UNAVAILABLE:f=c("mapEditor.locationError.unavailable");break;case l.TIMEOUT:f=c("mapEditor.locationError.timeout");break}g(f,"error")},k=u.useCallback(l=>{y.current||(y.current=!0,g(c("mapEditor.centeredToast"),"success")),r==null||r({latitude:l.coords.latitude,longitude:l.coords.longitude})},[g,c,r]),P=u.useCallback(()=>{d||setTimeout(()=>{if(T.current)try{T.current.trigger(),s(!0)}catch(l){console.warn("Failed to trigger geolocation on load:",l)}},500),o==null||o()},[d,o]);return u.useEffect(()=>{if(i&&m.current){const l=setTimeout(()=>{var f;return(f=m.current)==null?void 0:f.getMap().resize()},1);return()=>clearTimeout(l)}},[i,m]),u.useEffect(()=>{if(!d){const l=setTimeout(()=>{if(T.current)try{T.current.trigger(),s(!0)}catch(f){console.warn("Failed to trigger geolocation on mount:",f),(navigator.userAgent.includes("iPhone")||navigator.userAgent.includes("iPad"))&&g(c("mapEditor.iOSLocationPrompt")||"Tap the location button to center on your position","info")}},1e3);return()=>clearTimeout(l)}},[d,g,c]),S.jsx("div",{className:`relative w-full h-full bg-gray-700 ${a} ${p}`,children:S.jsxs(R,{ref:m,mapLib:L,...E,onMove:l=>t(l.viewState),onClick:n,onLoad:P,mapStyle:"https://tiles.openfreemap.org/styles/positron",style:{width:"100%",height:"100%"},children:[S.jsx(_,{ref:T,positionOptions:{enableHighAccuracy:!0,timeout:1e4,maximumAge:0},trackUserLocation:i,showUserLocation:!0,showAccuracyCircle:!0,fitBoundsOptions:{maxZoom:14},onError:b,onGeolocate:k}),M]})})};export{z as B,$ as c,B as g,j as u};
