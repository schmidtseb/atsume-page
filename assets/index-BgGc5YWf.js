const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/StampRally-DBpPbCEv.js","assets/react-vendor-Duv3WysG.js","assets/vendor-CFJUWez9.js","assets/maplibre-gl-vendor-Csyg3Y42.js","assets/maplibre-gl-vendor-CuCRB34y.css","assets/InteractiveCanvasView-a7SZ1cr0.js","assets/supabase-vendor-BpK5hd46.js","assets/StampEditor-CXaCv9Sz.js","assets/JoinRallyScreen-Zo3ejrq-.js","assets/RallyAdminDashboard-DztCTYqg.js"])))=>i.map(i=>d[i]);
var Ee=Object.defineProperty;var _e=(a,e,o)=>e in a?Ee(a,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):a[e]=o;var O=(a,e,o)=>_e(a,typeof e!="symbol"?e+"":e,o);import{j as t,X as A,I as oe,T as Pe,C as ae,r as f,S as D,L as q,M as Ae,U as Re,A as se,G as Le,a as Fe,b as Ue,c as ze,d as Oe,e as V,f as J,g as B,h as De,i as ne,k as re,l as $e,m as Ge,P as qe,n as Be,o as We,p as Ve,q as Y,s as Je,t as Ye,u as He,v as Xe,w as Ze,x as Ke,y as H,z as Qe,R as _,_ as $,B as et}from"./react-vendor-Duv3WysG.js";import{c as tt}from"./supabase-vendor-BpK5hd46.js";import{b as ot}from"./maplibre-gl-vendor-Csyg3Y42.js";import"./vendor-CFJUWez9.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function o(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=o(r);fetch(r.href,n)}})();const at={success:t.jsx(ae,{className:"w-6 h-6 text-green-400"}),error:t.jsx(Pe,{className:"w-6 h-6 text-red-400"}),info:t.jsx(oe,{className:"w-6 h-6 text-blue-400"})},st=({id:a,message:e,type:o,onClose:s})=>t.jsxs("div",{role:"alert",className:"relative w-full max-w-sm mb-4 rounded-lg shadow-2xl bg-gray-800 border border-gray-700 p-4 flex items-start gap-3",children:[t.jsx("div",{className:"flex-shrink-0 mt-0.5",children:at[o]}),t.jsx("div",{className:"flex-1 text-sm font-medium text-gray-200 break-words",children:e}),t.jsx("button",{onClick:()=>s(a),"aria-label":"Close",className:"p-1 -m-1 rounded-full text-gray-500 hover:bg-gray-700 hover:text-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500 transition-colors",children:t.jsx(A,{className:"h-4 w-4"})})]}),le=f.createContext(void 0),nt=({children:a})=>{const[e,o]=f.useState([]),s=f.useCallback(n=>{o(l=>l.filter(i=>i.id!==n))},[]),r=f.useCallback((n,l)=>{o(i=>{const c=i.findIndex(u=>u.message===n&&u.type===l);if(c>-1){const u=[...i],p=u[c];return u.splice(c,1),[...u,{...p,id:Date.now()+Math.random()}]}else return[...i,{id:Date.now()+Math.random(),message:n,type:l}]}),setTimeout(()=>{o(i=>i.filter(c=>!(c.message===n&&c.type===l)))},3e3)},[]);return t.jsxs(le.Provider,{value:{addToast:r},children:[a,t.jsx("div",{"aria-live":"assertive",className:"pointer-events-none fixed inset-0 flex items-start justify-end p-4 sm:p-6 z-50",children:t.jsx("div",{className:"w-full max-w-sm",children:e.map(n=>t.jsx("div",{className:"pointer-events-auto",children:t.jsx(st,{...n,onClose:s})},n.id))})})]})},U=()=>{const a=f.useContext(le);if(a===void 0)throw new Error("useToast must be used within a ToastProvider");return a},ie="https://ffwekbhvkurimzfihtwt.supabase.co",ce="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmd2VrYmh2a3VyaW16ZmlodHd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMzY5MzcsImV4cCI6MjA2NzkxMjkzN30.MYqd-BVm8icPGQ0a67vaOe4bbamYa4hhahXGaVdWnEo",N=tt(ie,ce);(ie.includes("YOUR_SUPABASE_URL")||ce.includes("YOUR_SUPABASE_ANON_KEY"))&&console.warn("Supabase credentials are not set. Please update YOUR_SUPABASE_URL and YOUR_SUPABASE_ANON_KEY in src/lib/supabaseClient.ts");async function de(a){const e={user_id:a.user_id,name:a.name,thumbnail:a.thumbnail,sourceImageURL:a.sourceImageURL,settings:a.settings},{data:o,error:s}=await N.from("stamps").insert([e]).select().single();if(s)throw console.error("Error adding stamp:",s),s;return o}async function X(){const{data:a,error:e}=await N.from("stamps").select("*").order("created_at",{ascending:!1});if(e)throw console.error("Error fetching stamps:",e),e;if(!a)return[];const o=[];for(const s of a)o.push({id:s.id,user_id:s.user_id,name:s.name,thumbnail:s.thumbnail,sourceImageURL:s.sourceImageURL,settings:s.settings});return o}async function rt(a){const{error:e}=await N.from("stamps").delete().eq("id",a);if(e)throw console.error("Error deleting stamp:",e),e}async function lt(a,e){const{error:o}=await N.from("stamps").update({name:e}).eq("id",a);if(o)throw console.error("Error updating stamp name:",o),o}async function Ma(a){const{data:e,error:o}=await N.from("rallies").insert([a]).select().single();if(o)throw o;return e}async function ka(a){const{data:e,error:o}=await N.from("rallies").select("*").eq("admin_id",a).order("created_at",{ascending:!1});if(o)throw o;return e||[]}async function Ea(a,e){const{error:o}=await N.from("rallies").update(e).eq("id",a);if(o)throw o}async function _a(a){const{error:e}=await N.from("rallies").delete().eq("id",a);if(e)throw e}async function Pa(a){const{data:e,error:o}=await N.from("rallies").select("*").eq("access_code",a).eq("published",!0).maybeSingle();if(o)throw o;return e}async function it(a){const{data:e,error:o}=await N.from("user_rallies").select("*").eq("user_id",a);if(o)throw o;return e||[]}async function Aa(a){const{error:e}=await N.from("user_rallies").insert([a]);if(e)throw e}async function ue(a){const{data:e,error:o}=await N.from("geolocations").insert([a]).select().single();if(o)throw console.error("Error adding geolocation:",o),o;return e}async function ct(a){const{data:e,error:o}=await N.from("geolocations").select("*").eq("rally_id",a).order("created_at",{ascending:!1});if(o)throw o;return e||[]}async function dt(a,e){const{error:o}=await N.from("geolocations").update(e).eq("id",a);if(o)throw o}async function ut(a){const{error:e}=await N.from("geolocations").delete().eq("id",a);if(e)throw e}async function Ra(a){const{data:e,error:o}=await N.from("collections").select("*").eq("rally_id",a);if(o)throw o;return e||[]}async function La(a){const{data:e,error:o}=await N.from("collections").insert([a]).select().single();if(o)throw o;return e}async function Fa(a,e){const{error:o}=await N.from("collections").update(e).eq("id",a);if(o)throw o}async function Ua(a){const{error:e}=await N.from("collections").delete().eq("id",a);if(e)throw e}const me=f.createContext(void 0),mt=({children:a})=>{const[e,o]=f.useState(null),[s,r]=f.useState(null),[n,l]=f.useState(null),[i,c]=f.useState(null),[u,p]=f.useState(!0),d=async v=>{var j;o(v);const w=(v==null?void 0:v.user)??null;if(r(w),w)try{const{data:T,error:y}=await N.from("profiles").select("role").eq("id",w.id).single();if(y&&y.code!=="PGRST116")throw y;const S=(T==null?void 0:T.role)||"user";if(l(S),S==="user"){const I=await it(w.id);c(((j=I[0])==null?void 0:j.rally_id)||null)}else c(null)}catch(T){console.error("Error fetching profile or rally status:",T),l("user"),c(null)}else l(null),c(null)};f.useEffect(()=>{const w=(async()=>{p(!0);const{data:{session:j}}=await N.auth.getSession();await d(j),p(!1);const{data:{subscription:T}}=N.auth.onAuthStateChange(async(y,S)=>{await d(S)});return T})();return()=>{w.then(j=>{j==null||j.unsubscribe()})}},[]);const b={session:e,user:s,role:n,activeRallyId:i,setActiveRallyId:c,signInWithGoogle:async()=>{await N.auth.signInWithOAuth({provider:"google",options:{redirectTo:window.location.origin+"/atsume-page/"}})},signInWithPassword:async(v,w)=>{const{error:j}=await N.auth.signInWithPassword({email:v,password:w});return{error:j}},signUpWithEmail:async(v,w)=>{const{error:j}=await N.auth.signUp({email:v,password:w,options:{emailRedirectTo:window.location.origin+"/atsume-page/"}});return{error:j}},logout:async()=>{await N.auth.signOut()},loading:u};return t.jsx(me.Provider,{value:b,children:a})},z=()=>{const a=f.useContext(me);if(a===void 0)throw new Error("useAuth must be used within an AuthProvider");return a},gt={save:"Save",cancel:"Cancel",delete:"Delete",edit:"Edit",add:"Add",close:"Close",confirm:"Confirm",submit:"Submit",submitting:"Submitting...",loading:"Loading...",error:"Error",success:"Success",info:"Info",name:"Name",description:"Description",optional:"optional"},pt={title:"Atsume",subtitle:"スタンプ集め",googleTab:"Google",emailTab:"Email",signInWithGoogle:"Sign In with Google",googleDescription:"Redirects to Google to sign in securely.",signInTitle:"Sign In",createAccountTitle:"Create Account",emailPlaceholder:"your@email.com",passwordPlaceholder:"Password",confirmPasswordPlaceholder:"Confirm Password",passwordMismatchError:"Passwords do not match.",signUpSuccessToast:"Account created! Please check your email to confirm your account.",signIn:"Sign In",signUp:"Sign Up",toggle:{toSignUp:"Don't have an account? Sign Up",toSignIn:"Already have an account? Sign In"},userMenu:"Open user menu",signedInAs:"Signed in as",logout:"Log Out"},ht={authenticating:"Authenticating...",pleaseWait:"Please wait a moment."},ft={title:"Atsume",subtitle:"スタンプ集め",tagline:"The interactive stamp pad.",description:"Turn any image into a work of art with a realistic stamp effect.",cta:"Get Started",version:"0.12.0",close:"Close splash screen"},xt={stamp:"Stamp Editor",map:"Map Editor",rally:"Stamp Rally",admin:"Admin"},bt={title:"Stamp Parameters",close:"Close parameters panel",canvasControls:"Canvas Controls",changeImage:"Change Image",uploadImage:"Upload Image",addToGallery:"Add to Gallery",addToGalleryTooltip:"Saves the last stamp you made to the gallery",clear:"Clear",download:"Download",resetParameters:"Reset Parameters"},yt={label:"Presets"},wt={posterization:{title:"Posterization & Shape",colors:"Colors",colorsTooltip:"The number of distinct color layers. 'Auto' detects prominent colors automatically.",auto:"Auto",backgroundThreshold:"Background Threshold",backgroundThresholdTooltip:"Pixels brighter than this value are treated as background and ignored.",shapeShrink:"Shape Shrink",shapeShrinkTooltip:"Shrinks each color layer to create gaps and a more distinct layered effect."},registration:{title:"Registration Errors",shift:"Shift",shiftAmountTooltip:"Average amount of horizontal/vertical misalignment between layers.",rotation:"Rotation",rotationAmountTooltip:"Average rotational misalignment between layers.",amount:"Amount",variation:"Variation",variationTooltip:"Randomness in the misalignment amount."},edge:{title:"Edge Effects",width:"Edge Width",widthTooltip:"The thickness of the border area around shapes that can be boosted.",boost:"Edge Boost",boostTooltip:"Increases ink density at the edges of shapes to simulate ink buildup."},wear:{title:"Wear & Tear",intensity:"Wear Intensity",noiseScale:"Noise Scale",inkDepletion:"Ink Depletion",inkDepletionAmountTooltip:"How faded the 'worn out' patches appear.",numPatches:"Num Patches",numPatchesAmountTooltip:"The number of 'worn out' patches.",patchSize:"Patch size",min:"Min",max:"Max"},splats:{title:"Ink Splats",density:"Splat Density",densityTooltip:"Controls the number of ink splats used to draw the image.",size:"Splat size",bleeding:"Bleeding Factor",bleedingTooltip:"Simulates ink bleeding into the paper just outside the stamp's edge."}},jt={pressureToast:"Pressure sensitivity enabled!",stampingErrorToast:"An error occurred while stamping. See console for details.",canvasClearedToast:"Canvas cleared",downloadErrorToast:"Nothing to download.",loadedStampToast:'Loaded stamp "{{name}}".',newStampToast:"Ready to create a new stamp.",generatingToast:"Generating stamp...",panMode:"Pan Mode Active",galleryToggle:"Open Stamp Gallery",settingsToggle:"Open Parameters Panel",toolbarToggle:"Open Brush Controls",stampingArea:"Stamping area"},St={title:"Stamp Gallery",close:"Close gallery panel",createNew:"Create New Stamp",empty:"Your gallery is empty.",emptySubtext:"Create a stamp and add it from the parameters panel.",rename:"Rename {{name}}",confirmDelete:"Confirm delete {{name}}",cancelDelete:"Cancel delete"},vt={title:"Stamp brush controls",hide:"Hide brush controls",size:"Size",sizeTooltip:"Controls the size of the stamp.",intensity:"Intensity",intensityTooltip:"Controls the ink density of the stamp.",pressureMessage:"Intensity is controlled by touch pressure."},Tt={invalidFileToast:"Invalid file type. Please upload an image.",loadedToast:"Image loaded. Click on the paper to stamp!",loadUrlErrorToast:"Failed to load image from URL."},Nt={resetToast:"Settings have been reset to default.",loadedPresetToast:'Loaded settings for "{{name}}".'},It={loginToast:"Please log in to save stamps to your gallery.",loadErrorToast:"Could not load your stamp gallery.",addSuccessToast:'"{{name}}" added to your gallery.',addErrorToast:"Could not save stamp.",deleteSuccessToast:"Stamp deleted from gallery.",deleteErrorToast:"Could not delete stamp. Restoring...",renameSuccessToast:'Stamp renamed to "{{name}}".',renameErrorToast:'Could not rename stamp. Reverting to "{{oldName}}".'},Ct={loginToast:"Please log in to save locations.",loadErrorToast:"Could not load your map locations.",addSuccessToast:'Location "{{name}}" saved.',addErrorToast:"Could not save location.",updateSuccessToast:"Location updated.",updateErrorToast:"Could not update location.",deleteSuccessToast:"Location deleted.",deleteErrorToast:"Could not delete location."},Mt={loginToast:"Please log in to collect stamps.",loadErrorToast:"Could not load your collection progress.",addSuccessToast:"Stamp collected! Place it in your log-book.",addErrorToast:"Could not save collection progress.",updateSuccessToast:"Stamp placed in log-book!",updateErrorToast:"Could not save stamp placement.",placementCancelledToast:"Placement cancelled. Open the log-book to place the stamp later.",removePlacementSuccessToast:"Last placement undone. You can place the stamp again.",removePlacementErrorToast:"Could not undo placement."},kt={addLocation:"Add Location",placeOnMap:"Place on Map",byCoordinates:"By Coordinates",fromOSM:"From OpenStreetMap",batchUpload:"Batch Upload",addLocationToast:"Click on the map to place a new location.",centeredToast:"Map centered on your location.",deleteConfirm:"Are you sure you want to delete this location?",viewLocation:"View {{name}}",noRallySelectedTitle:"No Rally Selected",noRallySelectedSubtitle:"Please select a rally from the Admin Dashboard to edit its map.",iOSLocationPrompt:"Tap the location button to center on your position",locationError:{denied:"Location access was denied. Please enable it in your browser settings to see your location on the map.",unavailable:"Your location is currently unavailable. Please check your signal and try again.",timeout:"Failed to get your location in time. Please try again.",unknown:"An unknown error occurred while trying to get your location."}},Et={title:"Batch Upload Locations",dragDrop:"Drag & drop your JSON file here",orClick:"or click to select file",selectedFile:"Selected file",noFileSelected:"No file selected.",invalidFileType:"Invalid file type. Please upload a JSON file.",uploadButton:"Upload",readingFile:"Reading file...",processingItems:"Processing items...",uploadComplete:"Upload complete!",partialSuccess:"{{success}} of {{total}} items uploaded with some errors.",success:"Successfully uploaded {{count}} items.",invalidJson:"Invalid JSON format",uploadFailed:"Upload failed",loginRequired:"Please log in to batch upload locations."},_t={title:"Enter Coordinates",latitude:"Latitude",longitude:"Longitude",latitudePlaceholder:"e.g., 51.5074",longitudePlaceholder:"e.g., -0.1278",validation:{latRequired:"Latitude is required.",lonRequired:"Longitude is required.",latInvalid:"Latitude must be between -90 and 90.",lonInvalid:"Longitude must be between -180 and 180."},next:"Next"},Pt={title:"Import from OpenStreetMap",idLabel:"OpenStreetMap ID",idPlaceholder:"e.g., 236578444 or R146656",helpText:"Enter an ID from OSM. For nodes, you can enter just the number (e.g., `236578444`). For ways/relations, include the prefix (e.g., `R146656`).",import:"Import",importing:"Importing...",error:{invalidId:"Invalid ID. Must be a number, or start with N, W, or R followed by numbers.",notFound:"Location not found for this ID. Please check the ID and try again.",network:"Could not connect to the OpenStreetMap API. Please check your internet connection."}},At={titleAdd:"Add New Location",titleEdit:"Edit Location",namePlaceholder:"Location Name",validationError:"Please enter a name for the location.",radius:"Collection Radius",radiusTooltip:"The distance within which this stamp can be 'collected'.",assignStamp:"Assign a Stamp",noStamp:"No Stamp",loadingStamps:"Loading stamps..."},Rt={collected:"Collected",locationStatus:"Status for {{name}}",progress:"{{collectedCount}} / {{totalCount}} Collected",logbookToggle:"Open Log-book",flyingToast:"Flying to {{name}}...",nearbyStamp:"There is a stamp nearby!",iOSLocationPrompt:"Tap the location button to center on your position",selectRallyToTestTitle:"Select a Rally to Test",selectRallyToTestSubtitle:"Please go to the Admin Dashboard to choose a rally to test.",locationError:{denied:"Location access was denied. The Stamp Rally requires location to work. Please enable it in your browser settings.",unavailable:"Your location is currently unavailable. Please check your signal and try again.",timeout:"Failed to get your location in time. Please try again.",unknown:"An unknown error occurred while trying to get your location."}},Lt={close:"Close Log-book",preparingStamp:"Preparing stamp...",pendingPlacement:"Place your newly collected stamp:",pendingPlacementSubtext:"Click to place, or click and drag to rotate.",panMode:"Pan Mode Active",clickToView:"Click to view details",stampingArea:"Log-book Stamping Area",prepareErrorToast:"Could not prepare stamp image.",placeErrorToast:"Failed to place stamp",placedToast:'Placed "{{name}}"',redo:"Redo"},Ft={collected:"Stamp Collected!",noImage:"No Stamp Image"},Ut={stampDesign:"Stamp Design",location:"Location",dateCollected:"Date Collected",goToLocation:"Go to {{name}} on the map"},zt={title:"Locations",toggle:"Toggle Location List",empty:"No locations created yet.",emptySubtext:"Click the '+' button to add your first location.",selectLocation:"View {{name}} on map"},Ot={title:"Rally Dashboard",subtitle:"Create and manage your Stamp Rallies.",createButton:"Create New Rally",creating:"Creating...",newRallyName:"New Rally #{{count}}",loadError:"Failed to load rallies.",createSuccess:"New rally created.",createError:"Failed to create rally.",updateError:"Failed to update rally.",deleteConfirm:"Are you sure you want to delete this rally and all its locations? This cannot be undone.",deleteSuccess:"Rally deleted.",deleteError:"Failed to delete rally.",noDescription:"No description provided.",accessCode:"Access Code",status:"Status",published:"Published",draft:"Draft",manageRally:"Manage",backToDashboard:"Back to Dashboard",editing:"Editing",selectRallyPromptTitle:"Select a Rally",selectRallyPromptSubtitle:"Choose a rally from the dashboard to edit its map or test it."},Dt={title:"Join a Rally",subtitle:"Enter an access code to get started.",placeholder:"ABCDEF",findButton:"Find Rally",joinButton:"Join Rally",joinSuccess:'Successfully joined "{{name}}"!',error:{notFound:"No published rally found with that code.",network:"Could not connect to the server. Please try again.",joinFailed:"Failed to join the rally.",alreadyJoined:"You have already joined this rally."}},$t={duration:"Duration",infinite:"Infinite"},Gt={common:gt,auth:pt,loadingScreen:ht,splashScreen:ft,modeToggle:xt,rightSidebar:bt,presetSelector:yt,settingsSections:wt,stampEditor:jt,stampGallery:St,stampToolbar:vt,imageLoader:Tt,stampSettings:Nt,gallery:It,geolocations:Ct,collections:Mt,mapEditor:kt,batchUpload:Et,coordInputModal:_t,osmImportModal:Pt,locationEditModal:At,rally:Rt,logbook:Lt,stampDetailModal:Ft,collectionDetailModal:Ut,locationList:zt,rallyAdmin:Ot,joinRally:Dt,rallyJoinCard:$t},qt={save:"保存",cancel:"キャンセル",delete:"削除",edit:"編集",add:"追加",close:"閉じる",confirm:"確認",submit:"送信",submitting:"送信中...",loading:"読み込み中...",error:"エラー",success:"成功",info:"情報",name:"名前",description:"説明",optional:"任意"},Bt={title:"Atsume",subtitle:"スタンプ集め",googleTab:"Google",emailTab:"メール",signInWithGoogle:"Googleでサインイン",googleDescription:"Googleにリダイレクトして安全にサインインします。",signInTitle:"サインイン",createAccountTitle:"アカウント作成",emailPlaceholder:"メールアドレス",passwordPlaceholder:"パスワード",confirmPasswordPlaceholder:"パスワード（確認）",passwordMismatchError:"パスワードが一致しません。",signUpSuccessToast:"アカウントが作成されました！メールを確認してアカウントを有効化してください。",signIn:"サインイン",signUp:"サインアップ",toggle:{toSignUp:"アカウントをお持ちでないですか？ サインアップ",toSignIn:"すでにアカウントをお持ちですか？ サインイン"},userMenu:"ユーザーメニューを開く",signedInAs:"サインイン中:",logout:"ログアウト"},Wt={authenticating:"認証中...",pleaseWait:"しばらくお待ちください。"},Vt={title:"Atsume",subtitle:"スタンプ集め",tagline:"インタラクティブ・スタンプパッド",description:"どんな画像もリアルなスタンプ効果でアート作品に変身させます。",cta:"はじめる",version:"バージョン {{version}}",close:"スプラッシュスクリーンを閉じる"},Jt={stamp:"スタンプエディター",map:"マップエディター",rally:"スタンプラリー",admin:"管理"},Yt={title:"スタンプ設定",close:"設定パネルを閉じる",canvasControls:"キャンバス操作",changeImage:"画像を変更",uploadImage:"画像をアップロード",addToGallery:"ギャラリーに追加",addToGalleryTooltip:"最後に作成したスタンプをギャラリーに保存します",clear:"クリア",download:"ダウンロード",resetParameters:"設定をリセット"},Ht={label:"プリセット"},Xt={posterization:{title:"ポスタリゼーションと形状",colors:"色数",colorsTooltip:"個別のカラーレイヤーの数。「自動」は主要な色を自動的に検出します。",auto:"自動",backgroundThreshold:"背景のしきい値",backgroundThresholdTooltip:"この値より明るいピクセルは背景として無視されます。",shapeShrink:"形状の縮小",shapeShrinkTooltip:"各カラーレイヤーを縮小して隙間を作り、より明確なレイヤー効果を生み出します。"},registration:{title:"版ズレ",shift:"ずれ",shiftAmountTooltip:"レイヤー間の水平/垂直方向のずれの平均量。",rotation:"回転",rotationAmountTooltip:"レイヤー間の回転のずれの平均量。",amount:"量",variation:"ばらつき",variationTooltip:"ずれの量のランダム性。"},edge:{title:"エッジ効果",width:"エッジの幅",widthTooltip:"形状の境界線の太さ。この範囲が強調されます。",boost:"エッジの強調",boostTooltip:"形状の端のインク濃度を上げて、インクの溜まりをシミュレートします。"},wear:{title:"かすれ",intensity:"かすれの強さ",noiseScale:"ノイズのスケール",inkDepletion:"インクの枯渇",inkDepletionAmountTooltip:"「使い古された」パッチがどれだけ色褪せて見えるか。",numPatches:"パッチの数",numPatchesAmountTooltip:"「使い古された」パッチの数。",patchSize:"パッチのサイズ",min:"最小",max:"最大"},splats:{title:"インクの飛び散り",density:"インクの密度",densityTooltip:"画像の描画に使用されるインクの点の数を制御します。",size:"インクのサイズ",bleeding:"にじみ",bleedingTooltip:"スタンプの端の外側でインクが紙ににじむのをシミュレートします。"}},Zt={pressureToast:"筆圧感知が有効になりました！",stampingErrorToast:"スタンプ作成中にエラーが発生しました。詳細はコンソールを確認してください。",canvasClearedToast:"キャンバスをクリアしました",downloadErrorToast:"ダウンロードするものがありません。",loadedStampToast:"スタンプ「{{name}}」を読み込みました。",newStampToast:"新しいスタンプを作成する準備ができました。",generatingToast:"スタンプを生成中...",panMode:"パンモード有効",galleryToggle:"スタンプギャラリーを開く",settingsToggle:"設定パネルを開く",toolbarToggle:"ブラシコントロールを開く",stampingArea:"スタンプエリア"},Kt={title:"スタンプギャラリー",close:"ギャラリーパネルを閉じる",createNew:"新しいスタンプを作成",empty:"ギャラリーは空です。",emptySubtext:"スタンプを作成し、設定パネルから追加してください。",rename:"{{name}}の名前を変更",confirmDelete:"{{name}}の削除を確認",cancelDelete:"削除をキャンセル"},Qt={title:"スタンプブラシコントロール",hide:"ブラシコントロールを隠す",size:"サイズ",sizeTooltip:"スタンプのサイズを制御します。",intensity:"インク濃度",intensityTooltip:"スタンプのインク濃度を制御します。",pressureMessage:"インク濃度は筆圧で制御されます。"},eo={invalidFileToast:"無効なファイルタイプです。画像をアップロードしてください。",loadedToast:"画像を読み込みました。紙の上をクリックしてスタンプしてください！",loadUrlErrorToast:"URLからの画像の読み込みに失敗しました。"},to={resetToast:"設定をデフォルトにリセットしました。",loadedPresetToast:"「{{name}}」の設定を読み込みました。"},oo={loginToast:"ギャラリーにスタンプを保存するにはログインしてください。",loadErrorToast:"スタンプギャラリーの読み込みに失敗しました。",addSuccessToast:"「{{name}}」をギャラリーに追加しました。",addErrorToast:"スタンプを保存できませんでした。",deleteSuccessToast:"ギャラリーからスタンプを削除しました。",deleteErrorToast:"スタンプを削除できませんでした。元に戻しています...",renameSuccessToast:"スタンプ名を「{{name}}」に変更しました。",renameErrorToast:"スタンプ名を変更できませんでした。「{{oldName}}」に戻しています。"},ao={loginToast:"場所を保存するにはログインしてください。",loadErrorToast:"マップの場所の読み込みに失敗しました。",addSuccessToast:"場所「{{name}}」を保存しました。",addErrorToast:"場所を保存できませんでした。",updateSuccessToast:"場所を更新しました。",updateErrorToast:"場所を更新できませんでした。",deleteSuccessToast:"場所を削除しました。",deleteErrorToast:"場所を削除できませんでした。"},so={loginToast:"スタンプを収集するにはログインしてください。",loadErrorToast:"収集の進捗の読み込みに失敗しました。",addSuccessToast:"スタンプを収集しました！ログブックに配置してください。",addErrorToast:"収集の進捗を保存できませんでした。",updateSuccessToast:"スタンプをログブックに配置しました！",updateErrorToast:"スタンプの配置を保存できませんでした。",placementCancelledToast:"配置がキャンセルされました。後でログブックを開いてスタンプを配置してください。",removePlacementSuccessToast:"最後の配置を取り消しました。スタンプを再度配置できます。",removePlacementErrorToast:"配置の取り消しに失敗しました。"},no={addLocation:"場所を追加",placeOnMap:"地図上で配置",byCoordinates:"座標で入力",fromOSM:"OpenStreetMapから",batchUpload:"一括アップロード",addLocationToast:"マップをクリックして新しい場所を配置してください。",centeredToast:"あなたの位置にマップを中央揃えしました。",deleteConfirm:"この場所を本当に削除しますか？",viewLocation:"{{name}}を表示",noRallySelectedTitle:"ラリーが選択されていません",noRallySelectedSubtitle:"管理ダッシュボードからラリーを選択して、その地図を編集してください。",iOSLocationPrompt:"位置情報ボタンをタップして現在地に中央揃えしてください",locationError:{denied:"位置情報へのアクセスが拒否されました。マップ上であなたの位置を表示するには、ブラウザの設定で有効にしてください。",unavailable:"現在、あなたの位置は利用できません。電波状況を確認して再試行してください。",timeout:"時間内にあなたの位置を取得できませんでした。再試行してください。",unknown:"位置情報の取得中に不明なエラーが発生しました。"}},ro={title:"場所の一括アップロード",dragDrop:"JSONファイルをここにドラッグ＆ドロップ",orClick:"またはクリックしてファイルを選択",selectedFile:"選択されたファイル",noFileSelected:"ファイルが選択されていません。",invalidFileType:"無効なファイルタイプです。JSONファイルをアップロードしてください。",uploadButton:"アップロード",readingFile:"ファイルを読み込み中...",processingItems:"アイテムを処理中...",uploadComplete:"アップロード完了！",partialSuccess:"{{total}}件中{{success}}件のアイテムがエラーありでアップロードされました。",success:"{{count}}件のアイテムが正常にアップロードされました。",invalidJson:"無効なJSON形式",uploadFailed:"アップロードに失敗しました",loginRequired:"場所を一括アップロードするにはログインしてください。"},lo={title:"座標を入力",latitude:"緯度",longitude:"経度",latitudePlaceholder:"例: 35.6895",longitudePlaceholder:"例: 139.6917",validation:{latRequired:"緯度は必須です。",lonRequired:"経度は必須です。",latInvalid:"緯度は-90から90の間でなければなりません。",lonInvalid:"経度は-180から180の間でなければなりません。"},next:"次へ"},io={title:"OpenStreetMapからインポート",idLabel:"OpenStreetMap ID",idPlaceholder:"例: 236578444 または R146656",helpText:"OSMのIDを入力します。ノードの場合は数字のみ入力できます (例: `236578444`)。ウェイ/リレーションの場合は接頭辞を含めてください (例: `R146656`)。",import:"インポート",importing:"インポート中...",error:{invalidId:"無効なIDです。数字、またはN、W、Rで始まり数字が続く形式で入力してください。",notFound:"このIDの場所が見つかりませんでした。IDを確認して再試行してください。",network:"OpenStreetMap APIに接続できませんでした。インターネット接続を確認してください。"}},co={titleAdd:"新しい場所を追加",titleEdit:"場所を編集",namePlaceholder:"場所の名前",validationError:"場所の名前を入力してください。",radius:"収集半径",radiusTooltip:"このスタンプを「収集」できる距離。",assignStamp:"スタンプを割り当て",noStamp:"スタンプなし",loadingStamps:"スタンプを読み込み中..."},uo={collected:"収集済み",locationStatus:"{{name}}のステータス",progress:"収集済み {{collectedCount}} / {{totalCount}}",logbookToggle:"ログブックを開く",flyingToast:"{{name}}へ移動中...",nearbyStamp:"近くにスタンプがあります！",iOSLocationPrompt:"位置情報ボタンをタップして現在地に中央揃えしてください",selectRallyToTestTitle:"テストするラリーを選択",selectRallyToTestSubtitle:"管理ダッシュボードからテストしたいラリーを選択してください。",locationError:{denied:"位置情報へのアクセスが拒否されました。スタンプラリーは位置情報が必要です。ブラウザの設定で有効にしてください。",unavailable:"現在、あなたの位置は利用できません。電波状況を確認して再試行してください。",timeout:"時間内にあなたの位置を取得できませんでした。再試行してください。",unknown:"位置情報の取得中に不明なエラーが発生しました。"}},mo={close:"ログブックを閉じる",preparingStamp:"スタンプを準備中...",pendingPlacement:"新しく収集したスタンプを配置してください：",pendingPlacementSubtext:"クリックで配置、クリック＆ドラッグで回転します。",panMode:"パンモード有効",clickToView:"クリックして詳細を表示",stampingArea:"ログブックのスタンプエリア",prepareErrorToast:"スタンプ画像を準備できませんでした。",placeErrorToast:"スタンプを配置できませんでした。",placedToast:"「{{name}}」を配置しました",redo:"やり直し"},go={collected:"スタンプ収集済み！",noImage:"スタンプ画像なし"},po={stampDesign:"スタンプデザイン",location:"場所",dateCollected:"収集日",goToLocation:"マップで{{name}}に移動"},ho={title:"場所リスト",toggle:"場所リストの表示/非表示",empty:"まだ場所が作成されていません。",emptySubtext:"「+」ボタンをクリックして最初の場所を追加してください。",selectLocation:"マップで「{{name}}」を表示"},fo={title:"ラリー管理ダッシュボード",subtitle:"スタンプラリーを作成・管理します。",createButton:"新しいラリーを作成",creating:"作成中...",newRallyName:"新しいラリー #{{count}}",loadError:"ラリーの読み込みに失敗しました。",createSuccess:"新しいラリーが作成されました。",createError:"ラリーの作成に失敗しました。",updateError:"ラリーの更新に失敗しました。",deleteConfirm:"このラリーとそのすべての場所を本当に削除しますか？この操作は元に戻せません。",deleteSuccess:"ラリーを削除しました。",deleteError:"ラリーの削除に失敗しました。",noDescription:"説明がありません。",accessCode:"参加コード",status:"ステータス",published:"公開中",draft:"下書き",manageRally:"管理",backToDashboard:"ダッシュボードに戻る",editing:"編集中",selectRallyPromptTitle:"ラリーを選択",selectRallyPromptSubtitle:"ダッシュボードからラリーを選択して、地図を編集したりテストしたりします。"},xo={title:"ラリーに参加",subtitle:"参加コードを入力して始めましょう。",placeholder:"ABCDEF",findButton:"ラリーを探す",joinButton:"ラリーに参加",joinSuccess:"「{{name}}」に無事参加しました！",error:{notFound:"そのコードの公開ラリーが見つかりませんでした。",network:"サーバーに接続できませんでした。もう一度お試しください。",joinFailed:"ラリーへの参加に失敗しました。",alreadyJoined:"すでにこのラリーに参加しています。"}},bo={duration:"開催期間",infinite:"無期限"},yo={common:qt,auth:Bt,loadingScreen:Wt,splashScreen:Vt,modeToggle:Jt,rightSidebar:Yt,presetSelector:Ht,settingsSections:Xt,stampEditor:Zt,stampGallery:Kt,stampToolbar:Qt,imageLoader:eo,stampSettings:to,gallery:oo,geolocations:ao,collections:so,mapEditor:no,batchUpload:ro,coordInputModal:lo,osmImportModal:io,locationEditModal:co,rally:uo,logbook:mo,stampDetailModal:go,collectionDetailModal:po,locationList:ho,rallyAdmin:fo,joinRally:xo,rallyJoinCard:bo},wo={en:Gt,ja:yo},jo=(a,e)=>e.split(".").reduce((o,s)=>o&&o[s],a)||e,ge=f.createContext(void 0),So=()=>{if(typeof window<"u"){const a=localStorage.getItem("atsume-locale");if(a==="en"||a==="ja")return a;if(navigator.language.split(/[-_]/)[0]==="ja")return"ja"}return"en"},vo=({children:a})=>{const[e,o]=f.useState(So()),s=n=>{o(n),typeof window<"u"&&localStorage.setItem("atsume-locale",n)},r=f.useCallback((n,l)=>{let i=jo(wo[e],n);return l&&Object.keys(l).forEach(c=>{i=i.replace(`{{${c}}}`,String(l[c]))}),i},[e]);return t.jsx(ge.Provider,{value:{locale:e,setLocale:s,t:r},children:a})},C=()=>{const a=f.useContext(ge);if(a===void 0)throw new Error("useLocale must be used within a LocaleProvider");return a},To=()=>{const{signInWithGoogle:a,signInWithPassword:e,signUpWithEmail:o}=z(),[s,r]=f.useState("email"),[n,l]=f.useState("signIn"),[i,c]=f.useState(""),[u,p]=f.useState(""),[d,m]=f.useState(""),[g,h]=f.useState(null),[x,b]=f.useState(!1),{addToast:v}=U(),{t:w}=C(),j=()=>{c(""),p(""),m(""),h(null)},T=async S=>{if(S.preventDefault(),!(x||!i||!u)){if(b(!0),h(null),n==="signUp"){if(u!==d){h(w("auth.passwordMismatchError")),b(!1);return}const{error:I}=await o(i,u);I?h(I.message):(v(w("auth.signUpSuccessToast"),"success"),l("signIn"),j())}else{const{error:I}=await e(i,u);I&&h(I.message)}b(!1)}},y=({method:S,children:I})=>t.jsx("button",{onClick:()=>{r(S),j()},className:`w-full text-center text-sm font-medium py-2 px-3 rounded-md transition-colors duration-200 flex items-center justify-center gap-2 ${s===S?"bg-gray-700 text-white":"bg-transparent text-gray-400 hover:bg-gray-700/50"}`,children:I});return t.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center p-4",children:t.jsxs("div",{className:"w-full max-w-md",children:[t.jsxs("div",{className:"flex flex-col items-center mb-8",children:[t.jsx("div",{className:"p-3 bg-blue-600/20 border-2 border-blue-500 rounded-full mb-4",children:t.jsx(D,{className:"w-12 h-12 text-blue-400"})}),t.jsx("h1",{className:"text-4xl font-bold text-white",children:w("auth.title")}),t.jsx("h2",{className:"text-lg font-light text-gray-300 tracking-widest",children:w("auth.subtitle")})]}),t.jsxs("div",{className:"bg-gray-800 rounded-xl p-6 sm:p-8 border border-gray-700",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-1 bg-gray-900/50 p-1 rounded-lg mb-6",children:[t.jsxs(y,{method:"google",children:[t.jsx(q,{className:"w-4 h-4"})," ",w("auth.googleTab")]}),t.jsxs(y,{method:"email",children:[t.jsx(Ae,{className:"w-4 h-4"})," ",w("auth.emailTab")]})]}),t.jsxs("div",{children:[s==="google"&&t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsxs("button",{onClick:a,className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2",children:[t.jsx(q,{className:"w-5 h-5"}),w("auth.signInWithGoogle")]}),t.jsx("p",{className:"text-xs text-center text-gray-500 pt-2",children:w("auth.googleDescription")})]}),s==="email"&&t.jsxs("form",{onSubmit:T,className:"flex flex-col gap-4",children:[t.jsx("h3",{className:"text-xl font-semibold text-center text-white",children:w(n==="signIn"?"auth.signInTitle":"auth.createAccountTitle")}),t.jsx("label",{htmlFor:"email",className:"sr-only",children:w("auth.emailTab")}),t.jsx("input",{id:"email",type:"email",value:i,onChange:S=>c(S.target.value),placeholder:w("auth.emailPlaceholder"),required:!0,className:"w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition"}),t.jsx("label",{htmlFor:"password_1",className:"sr-only",children:w("auth.passwordPlaceholder")}),t.jsx("input",{id:"password_1",type:"password",value:u,onChange:S=>p(S.target.value),placeholder:w("auth.passwordPlaceholder"),required:!0,className:"w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition"}),n==="signUp"&&t.jsxs(t.Fragment,{children:[t.jsx("label",{htmlFor:"password_2",className:"sr-only",children:w("auth.confirmPasswordPlaceholder")}),t.jsx("input",{id:"password_2",type:"password",value:d,onChange:S=>m(S.target.value),placeholder:w("auth.confirmPasswordPlaceholder"),required:!0,className:"w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition"})]}),g&&t.jsx("p",{className:"text-red-400 text-sm text-center",children:g}),t.jsxs("button",{type:"submit",disabled:x,className:"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2",children:[n==="signIn"?t.jsx(q,{className:"w-5 h-5"}):t.jsx(Re,{className:"w-5 h-5"}),w(x?"common.submitting":n==="signIn"?"auth.signIn":"auth.signUp")]}),t.jsx("p",{className:"text-center text-sm",children:t.jsx("button",{type:"button",onClick:()=>{l(n==="signIn"?"signUp":"signIn"),j()},className:"text-gray-400 hover:text-white underline",children:w(n==="signIn"?"auth.toggle.toSignUp":"auth.toggle.toSignIn")})})]})]})]})]})})},L=()=>{const{t:a}=C();return t.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"}),t.jsx("h1",{className:"text-2xl font-semibold text-white mb-2",children:a("loadingScreen.authenticating")}),t.jsx("p",{className:"text-gray-400",children:a("loadingScreen.pleaseWait")})]})})},No=({onClose:a})=>{const{t:e}=C();return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm animate-fade-in","aria-modal":"true",role:"dialog",children:t.jsxs("div",{className:"relative w-full max-w-lg m-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-8 text-center text-white transform animate-scale-in",children:[t.jsx("button",{onClick:a,className:"absolute top-4 right-4 p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors","aria-label":e("splashScreen.close"),children:t.jsx(A,{className:"w-6 h-6"})}),t.jsxs("div",{className:"flex flex-col items-center",children:[t.jsx("div",{className:"p-4 bg-blue-600/20 border-2 border-blue-500 rounded-full mb-6",children:t.jsx(D,{className:"w-16 h-16 text-blue-400"})}),t.jsx("h1",{className:"text-5xl font-bold mb-1",children:e("splashScreen.title")}),t.jsx("h2",{className:"text-xl font-light text-gray-300 mb-6 tracking-widest",children:e("splashScreen.subtitle")}),t.jsxs("p",{className:"text-gray-400 mb-8",children:[e("splashScreen.tagline"),t.jsx("br",{}),e("splashScreen.description")]}),t.jsxs("button",{onClick:a,className:"w-full max-w-xs bg-blue-600 hover:bg-blue-700 font-bold py-4 px-8 rounded-xl transition-all duration-200 flex items-center justify-center gap-3 text-xl shadow-lg hover:shadow-blue-500/50 transform hover:scale-105",children:[e("splashScreen.cta"),t.jsx(se,{className:"w-6 h-6"})]}),t.jsx("div",{className:"mt-8 text-xs text-gray-500",children:e("splashScreen.version",{version:"0.10.0"})})]})]})})},Io=()=>{const{locale:a,setLocale:e}=C(),[o,s]=f.useState(!1),r=f.useRef(null),n={en:"English",ja:"日本語"};f.useEffect(()=>{const i=c=>{r.current&&!r.current.contains(c.target)&&s(!1)};return document.addEventListener("mousedown",i),()=>document.removeEventListener("mousedown",i)},[]);const l=i=>{e(i),s(!1)};return t.jsxs("div",{ref:r,className:"relative",children:[t.jsxs("button",{onClick:()=>s(!o),className:"flex items-center gap-2 w-full px-3 py-2 text-sm text-left text-gray-200 hover:bg-gray-700 rounded-md transition-colors","aria-haspopup":"true","aria-expanded":o,children:[t.jsx(Le,{className:"w-4 h-4 text-gray-400"}),t.jsx("span",{className:"flex-grow",children:n[a]}),t.jsx("svg",{className:`w-4 h-4 text-gray-400 transition-transform duration-200 ${o?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),o&&t.jsx("div",{className:"absolute right-0 bottom-full mb-2 w-40 bg-gray-800 border border-gray-700 rounded-lg shadow-lg py-1 z-10",role:"menu",children:Object.keys(n).map(i=>t.jsxs("button",{onClick:()=>l(i),className:"w-full flex items-center justify-between px-3 py-2 text-sm text-left text-gray-200 hover:bg-gray-700",role:"menuitem",children:[n[i],a===i&&t.jsx(Fe,{className:"w-4 h-4 text-blue-400"})]},i))})]})},Co=()=>{const{user:a,logout:e}=z(),{t:o}=C(),[s,r]=f.useState(!1),n=f.useRef(null);return f.useEffect(()=>{const l=i=>{n.current&&!n.current.contains(i.target)&&r(!1)};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[]),a?t.jsxs("div",{ref:n,className:"relative",children:[t.jsx("button",{onClick:()=>r(!s),className:"flex items-center justify-center w-10 h-10 bg-gray-700/50 hover:bg-gray-700 rounded-full transition-colors","aria-label":o("auth.userMenu"),title:a.email||"",children:t.jsx(Ue,{className:"w-5 h-5 text-white"})}),s&&t.jsxs("div",{className:"absolute bottom-full mb-4 left-0 mt-2 w-64 bg-gray-800 border border-gray-700 rounded-xl shadow-lg z-50 p-2 flex flex-col gap-1",children:[t.jsxs("div",{className:"px-3 py-2 border-b border-gray-700 mb-1",children:[t.jsx("p",{className:"text-sm font-medium text-white truncate",children:o("auth.signedInAs")}),t.jsx("p",{className:"text-xs text-gray-400 truncate",children:a.email})]}),t.jsx(Io,{}),t.jsxs("button",{onClick:e,className:"flex items-center gap-2 w-full px-3 py-2 text-sm text-left text-red-400 hover:bg-red-500/10 hover:text-red-300 rounded-md transition-colors",children:[t.jsx(ze,{className:"w-4 h-4"}),o("auth.logout")]})]})]}):null},Mo=({mode:a,setMode:e,isAdmin:o,isManaging:s})=>{const{t:r}=C(),n="flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-colors duration-200",l="bg-blue-600 text-white",i="bg-gray-700/50 text-gray-300 hover:bg-gray-700",c=[{name:"admin",icon:Oe,title:r("modeToggle.admin"),disabled:!1},{name:"stamp",icon:D,title:r("modeToggle.stamp"),disabled:!1},{name:"map",icon:V,title:r("modeToggle.map"),disabled:!0},{name:"rally",icon:J,title:r("modeToggle.rally"),disabled:!0}],u=[{name:"map",icon:V,title:r("modeToggle.map"),disabled:!1},{name:"rally",icon:J,title:r("modeToggle.rally"),disabled:!1},{name:"stamp",icon:D,title:r("modeToggle.stamp"),disabled:!1}],p=s?u:c;return o?t.jsx("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 z-30 bg-gray-900/70 backdrop-blur-sm p-1 rounded-xl shadow-lg flex items-center gap-1",children:p.map(d=>t.jsx("button",{onClick:()=>e(d.name),className:`${n} ${a===d.name?l:i} ${d.disabled?"text-gray-500 hover:bg-gray-700/50 cursor-not-allowed":""}`,"aria-pressed":a===d.name,title:d.disabled?r("rallyAdmin.selectRallyPromptSubtitle"):d.title,disabled:d.disabled,children:t.jsx(d.icon,{className:"w-4 h-4"})},d.name))}):null},ko=({onSelect:a})=>{const{t:e}=C(),o=[{method:"map",icon:B,label:e("mapEditor.placeOnMap")},{method:"coords",icon:De,label:e("mapEditor.byCoordinates")},{method:"osm",icon:ne,label:e("mapEditor.fromOSM")},{method:"batch",icon:re,label:e("mapEditor.batchUpload")}];return t.jsx("div",{className:"flex flex-col items-stretch gap-1 bg-gray-900/80 backdrop-blur-sm p-2 rounded-xl shadow-lg w-48",children:o.map((s,r)=>t.jsxs("button",{onClick:()=>a(s.method),className:"flex items-center gap-3 w-full text-left p-2 rounded-lg text-white hover:bg-blue-600 transition-colors animate-fade-in",style:{animationDelay:`${r*50}ms`},title:s.label,children:[t.jsx(s.icon,{className:"w-5 h-5 flex-shrink-0"}),t.jsx("span",{className:"text-sm font-medium",children:s.label})]},s.method))})},Eo=({mode:a,setMode:e,isAdmin:o,isManaging:s,managedRally:r,handleExitManagement:n,isLocationListOpen:l,setIsLocationListOpen:i,addMenuOpen:c,setAddMenuOpen:u,handleSelectAddMethod:p,setIsPlacingOnMap:d,children:m})=>{const{t:g}=C();return t.jsx("div",{className:"h-screen w-screen bg-gray-900 text-white font-sans overflow-hidden",children:t.jsxs("main",{className:"relative w-full h-full",children:[t.jsxs("div",{className:"absolute bottom-4 left-4 z-30 flex items-center gap-4",children:[t.jsx(Co,{}),o&&s&&r&&t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:n,className:"flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg bg-gray-900/70 backdrop-blur-sm text-gray-300 hover:bg-gray-700 hover:text-white transition-colors",children:[t.jsx($e,{className:"w-4 h-4"}),g("rallyAdmin.backToDashboard")]}),t.jsxs("div",{className:"text-white bg-gray-900/70 backdrop-blur-sm px-3 py-2 rounded-lg hidden sm:block",children:[t.jsxs("span",{className:"text-gray-400",children:[g("rallyAdmin.editing"),":"]})," ",t.jsx("span",{className:"font-bold",children:r.name})]})]})]}),a==="map"&&!l&&t.jsx("div",{className:"absolute top-4 left-4 z-30",children:t.jsxs("button",{onClick:()=>i(!0),className:"flex items-center gap-2 px-3 py-2 text-sm font-semibold rounded-lg bg-gray-900/70 backdrop-blur-sm text-gray-300 hover:bg-gray-700 hover:text-white transition-colors","aria-label":g("locationList.open"),children:[t.jsx(Ge,{className:"w-4 h-4"}),g("locationList.title")]})}),t.jsx(Mo,{mode:a,setMode:e,isAdmin:o,isManaging:s}),m,a==="map"&&t.jsx("div",{className:"absolute bottom-6 right-6 z-10",children:t.jsxs("div",{className:"relative",children:[c&&t.jsx("div",{className:"absolute bottom-full right-0 mb-3",children:t.jsx(ko,{onSelect:p})}),t.jsx("button",{onClick:()=>{u(h=>!h),d(!1)},className:"bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-transform hover:scale-110","aria-label":g("mapEditor.addLocation"),"aria-expanded":c,children:t.jsx(qe,{className:`w-6 h-6 transition-transform duration-300 ${c?"rotate-45":""}`})})]})})]})})},P=(a=0,e=1)=>{const o=Math.random(),s=Math.random();return Math.sqrt(-2*Math.log(o))*Math.cos(2*Math.PI*s)*e+a};class k{constructor(e,o,s){O(this,"data");O(this,"width");O(this,"height");this.width=o,this.height=e;const r=o*e;if(s instanceof Float32Array){if(s.length!==r)throw new Error("Data array does not match matrix dimensions");this.data=s}else this.data=new Float32Array(r),typeof s=="number"&&this.data.fill(s)}static ones(e,o){return new k(e,o,1)}static zeros(e,o){return new k(e,o,0)}get(e,o){return e<0||e>=this.height||o<0||o>=this.width?0:this.data[e*this.width+o]}set(e,o,s){e>=0&&e<this.height&&o>=0&&o<this.width&&(this.data[e*this.width+o]=s)}clone(){return new k(this.height,this.width,new Float32Array(this.data))}getBilinear(e,o){const s=Math.floor(e),r=Math.floor(o),n=Math.ceil(e),l=Math.ceil(o);if(s<0||n>=this.height||r<0||l>=this.width)return 0;const i=this.get(s,r),c=this.get(s,l),u=this.get(n,r),p=this.get(n,l),d=e-s,m=o-r,g=i*(1-m)+c*m,h=u*(1-m)+p*m;return g*(1-d)+h*d}}function pe(a,e){const o=k.zeros(a.height,a.width);for(let s=0;s<a.data.length;s++)o.data[s]=a.data[s]*e.data[s];return o}function _o(a,e,o,s,r){const n=k.zeros(a.height,a.width);for(let l=0;l<a.data.length;l++)n.data[l]=a.data[l]*e+o.data[l]*s+r;return n}function he(a){const e=a.clone();let o=1/0,s=-1/0;for(let n=0;n<e.data.length;n++)e.data[n]<o&&(o=e.data[n]),e.data[n]>s&&(s=e.data[n]);const r=s-o;if(r>0)for(let n=0;n<e.data.length;n++)e.data[n]=(e.data[n]-o)/r;return e}function Po(a){let e=0;for(let o=0;o<a.data.length;o++)a.data[o]!==0&&e++;return e}const F=240,Ao=10,Ro=1;function Lo(a,e){const o=[];for(let s=0;s<a.length;s+=3){const r=a[s],n=a[s+1],l=a[s+2],i=(r+n+l)/3,c=r>F&&n>F&&l>F;i>e&&!c&&o.push(r,n,l)}return new Float32Array(o)}function Z(a,e){return Math.sqrt((a[0]-e[0])**2+(a[1]-e[1])**2+(a[2]-e[2])**2)}function Fo(a,e){if(a.length===0||e===0)return{colors:[],labels:new Int32Array(0)};const o=a.length/3,s=[];for(let c=0;c<a.length;c+=3)s.push([a[c],a[c+1],a[c+2]]);o<e&&(e=o);let r=[];const n=new Set;for(;r.length<e;){const c=Math.floor(Math.random()*o);n.has(c)||(r.push([...s[c]]),n.add(c))}const l=new Int32Array(o);for(let c=0;c<Ao;c++){for(let m=0;m<o;m++){let g=1/0,h=0;for(let x=0;x<r.length;x++){const b=Z(s[m],r[x]);b<g&&(g=b,h=x)}l[m]=h}const u=Array(r.length).fill(0).map(()=>[0,0,0]),p=new Array(r.length).fill(0);for(let m=0;m<o;m++){const g=l[m];u[g][0]+=s[m][0],u[g][1]+=s[m][1],u[g][2]+=s[m][2],p[g]++}let d=!0;for(let m=0;m<r.length;m++){if(p[m]>0)u[m][0]/=p[m],u[m][1]/=p[m],u[m][2]/=p[m];else{const g=Math.floor(Math.random()*o);u[m]=[...s[g]]}Z(u[m],r[m])>Ro&&(d=!1)}if(r=u,d)break}return{colors:r.map(c=>c.map(Math.round)),labels:l}}function Uo(a,e){const o=k.zeros(a.height,a.width),s=Math.floor(e/2);for(let r=0;r<a.height;r++)for(let n=0;n<a.width;n++){let l=255;for(let i=-s;i<=s;i++)for(let c=-s;c<=s;c++)l=Math.min(l,a.get(r+i,n+c));o.set(r,n,l)}return o}function zo(a,e,o,s,r,n){const l=new Array(s*r).fill(-1);let i=0;for(let u=0;u<a.length;u+=3){const p=a[u],d=a[u+1],m=a[u+2],g=(p+d+m)/3,h=p>F&&d>F&&m>F;g>n.background_threshold&&!h&&(l[u/3]=o[i],i++)}const c=[];for(let u=0;u<e.length;u++){const p=new Float32Array(s*r);for(let m=0;m<l.length;m++)p[m]=l[m]===u?255:0;let d=new k(r,s,p);n.color_shape_shrink>0&&(d=Uo(d,n.color_shape_shrink)),c.push(d)}return c}function Oo(a,e,o){const s=e*Math.PI/180,r=o*Math.cos(s),n=o*Math.sin(s);return[r,n,(1-r)*a.x-n*a.y,-n,r,n*a.x+(1-r)*a.y]}function Do(a,e,o,s){const r=k.zeros(s,o),[n,l,i,c,u,p]=e,d=n*u-l*c;if(Math.abs(d)<1e-6)return r;const m=1/d,g=u*m,h=-l*m,x=(l*p-u*i)*m,b=-c*m,v=n*m,w=(c*i-n*p)*m;for(let j=0;j<s;j++)for(let T=0;T<o;T++){const y=g*T+h*j+x,S=b*T+v*j+w,I=a.getBilinear(S,y);r.set(j,T,I)}return r}function $o(a,e,o,s,r){return a.map(n=>{const l=P(...s),i=P(...s),c=P(...r),u=Oo({x:e/2,y:o/2},c,1);return u[2]+=l,u[5]+=i,Do(n,u,e,o)})}function fe(a){var c;const e=a.length,o=((c=a[0])==null?void 0:c.length)||0,s=Array(e).fill(null).map(()=>Array(o));for(let u=0;u<e;u++)for(let p=0;p<o;p++)s[u][p]=a[u][p]>127;const r=Array(e).fill(null).map(()=>Array(o));for(let u=0;u<e;u++)Go(s[u],r[u]);const n=Array(e).fill(null).map(()=>Array(o)),l=Array(e),i=Array(e);for(let u=0;u<o;u++){for(let p=0;p<e;p++)l[p]=r[p][u];qo(l,i);for(let p=0;p<e;p++)n[p][u]=Math.sqrt(i[p])}return n}function Go(a,e){const o=a.length;let s=1/0;for(let r=0;r<o;r++)a[r]?s++:s=0,e[r]=s*s;s=1/0;for(let r=o-1;r>=0;r--)a[r]?s++:s=0,e[r]=Math.min(e[r],s*s)}function qo(a,e){const o=a.length;if(o===0)return;const s=Array(o),r=Array(o+1);let n=0;s[0]=0,r[0]=-1/0,r[1]=1/0;for(let l=1;l<o;l++){let i=(a[l]+l*l-(a[s[n]]+s[n]*s[n]))/(2*l-2*s[n]);for(;i<=r[n];)n--,i=(a[l]+l*l-(a[s[n]]+s[n]*s[n]))/(2*l-2*s[n]);n++,s[n]=l,r[n]=i,r[n+1]=1/0}n=0;for(let l=0;l<o;l++){for(;r[n+1]<l;)n++;e[l]=(l-s[n])*(l-s[n])+a[s[n]]}}function Bo(a,e,o){const s=Array(o).fill(null).map(()=>Array(e));for(let r=0;r<o;r++)for(let n=0;n<e;n++)s[r][n]=a.get(r,n);return fe(s)}function Wo(a,e,o,s,r){return a.map(n=>{const l=Array(o).fill(0).map(()=>Array(e).fill(0));for(let u=0;u<o;u++)for(let p=0;p<e;p++)l[u][p]=n.get(u,p);const i=fe(l),c=k.ones(o,e);for(let u=0;u<o;u++)for(let p=0;p<e;p++){const d=i[u][p];for(let m=1;m<=s;m++)if(d>m-1&&d<=m){const g=r*(s-m+1)/s;c.set(u,p,g);break}}return c})}function Vo(a,e,o){const s=k.zeros(e,a);for(let r=0;r<3;r++){const n=2**r,l=1/n,i=1/n;for(let c=0;c<e;c++)for(let u=0;u<a;u++){const p=i*Math.sin(u*l*2*Math.PI/o)*Math.sin(c*l*2*Math.PI/o),d=s.get(c,u);s.set(c,u,d+p)}}return he(s)}function Jo(a,e,o,s,r){const n=k.ones(e,a);if(r<=0||o<=0)return n;for(let l=0;l<o;l++){const i=Math.random()*(s[1]-s[0])+s[0],c=Math.random()*a,u=Math.random()*e,p=Math.max(0,Math.floor(c-i)),d=Math.min(a,Math.ceil(c+i)),m=Math.max(0,Math.floor(u-i)),g=Math.min(e,Math.ceil(u+i));for(let h=m;h<g;h++)for(let x=p;x<d;x++){const b=Math.sqrt((x-c)**2+(h-u)**2);if(b<i){const w=1-(b/i)**2,j=1-r*w;n.get(h,x)>j&&n.set(h,x,j)}}}return n}function Yo(a,e,o,s){const r=[];for(let n=0;n<a;n++){const l=P(...s.noise_scale),i=Vo(e,o,l),c=Math.round(P(...s.num_patches)),u=P(...s.ink_depletion_intensity),p=Jo(e,o,c,s.patch_size_range,u),d=P(...s.wear_intensity),m=k.ones(o,e);let g=_o(i,d,m,1-d,0);g=pe(g,p),g=he(g),r.push(g)}return r}function Ho(a,e){const o=[];let s=0;for(let r=0;r<a.length;r++){const n=e>0?a[r].density/e:1/a.length;s+=n,o.push(s)}return o.length>0&&(o[o.length-1]=1),o}function Xo(a){const e=Math.random();let o=0,s=a.length-1;if(a.length===0)return-1;if(e<=a[0])return 0;if(e>=a[a.length-1])return a.length-1;for(;o<s;){const r=Math.floor((o+s)/2);a[r]<e?o=r+1:s=r}return o}function Zo(a,e,o,s,r,n){const l=pe(e,o);let i=null;n.bleeding_factor>0&&(i=Bo(a,s,r));const c=[];let u=0;for(let g=0;g<r;g++)for(let h=0;h<s;h++)if(a.get(g,h)>127){const x=l.get(g,h);c.push({x:h,y:g,density:x}),u+=x}if(c.length===0)return[];const p=Ho(c,u),d=Math.floor(n.splat_density*c.length),m=[];for(let g=0;g<d;g++){const h=Xo(p);if(h<0)continue;const x=c[h],{x:b,y:v,density:w}=x,T=(Math.random()*(n.splat_size_range[1]-n.splat_size_range[0])+n.splat_size_range[0])*(.5+.5*w);let y=0;n.bleeding_factor>0&&i&&i[v][b]<5&&(y=-Math.log(Math.random())*n.bleeding_factor);const S=T+y,I=Math.min(255,Math.floor(100+155*w));m.push({x:b,y:v,size:S,opacity:I})}return m}function Ko(a,e,o,s,r,n=!1){const l=document.createElement("canvas");l.width=o,l.height=s;const i=l.getContext("2d");if(!n){const[c,u,p]=r;i.fillStyle=`rgb(${c}, ${u}, ${p})`,i.fillRect(0,0,o,s)}return a.forEach((c,u)=>{const[p,d,m]=e[u],g=c.sort((h,x)=>x.size-h.size);for(const h of g)i.fillStyle=`rgba(${p}, ${d}, ${m}, ${h.opacity/255})`,i.beginPath(),i.ellipse(h.x,h.y,h.size/2,h.size/2,0,0,2*Math.PI),i.fill()}),i.getImageData(0,0,o,s)}function Qo(a,e){const{data:o,width:s,height:r}=a,n=new Uint8ClampedArray(s*r*3);for(let y=0,S=0;y<o.length;y+=4,S+=3)n[S]=o[y],n[S+1]=o[y+1],n[S+2]=o[y+2];const l=Lo(n,e.background_threshold),i=e.num_colors==="auto"?15:e.num_colors,{colors:c,labels:u}=Fo(l,i),p=zo(n,c,u,s,r,e),d=240,m=y=>y[0]>d&&y[1]>d&&y[2]>d,g=p.map((y,S)=>({mask:y,color:c[S],size:Po(y)})).filter(y=>!m(y.color)).sort((y,S)=>S.size-y.size);if(g.length===0){const y=document.createElement("canvas");return y.width=s,y.height=r,y.getContext("2d").getImageData(0,0,s,r)}const h=g.map(y=>y.mask),x=g.map(y=>y.color),b=$o(h,s,r,e.shift,e.rotation),v=Wo(b,s,r,e.edge_width,e.edge_boost),w=Yo(x.length,s,r,e),j=[];for(let y=0;y<b.length;y++){const S=Zo(b[y],v[y],w[y],s,r,e);j.push(S)}return Ko(j,x,s,r,e.background_color,!0)}const ea={stamp_size:512,num_colors:"auto",background_threshold:5,color_shape_shrink:5,shift:[0,1],rotation:[0,1],edge_width:4,edge_boost:3,wear_intensity:[.1,.05],noise_scale:[50,5],rotation_angle:[0,0],ink_depletion_intensity:[.3,.05],num_patches:[2,1],patch_size_range:[20,100],splat_density:.75,splat_size_range:[1,2],bleeding_factor:.1,background_color:[255,255,255]};function ta(a,e){const o=document.createElement("canvas"),s=o.getContext("2d");if(!s)throw new Error("Could not create canvas context");const r=a.width/a.height,n=r>=1?e:e*r,l=r<1?e:e/r;return o.width=Math.ceil(n),o.height=Math.ceil(l),s.drawImage(a,0,0,o.width,o.height),o}async function za(a,e){return new Promise((o,s)=>{setTimeout(()=>{try{const r=Qo(a,e);o(r)}catch(r){s(r)}},0)})}function K(a){return new Promise(e=>{const o=new Image;o.src=a,o.onload=()=>e(),o.onerror=s=>{console.error("Failed to preload image:",a,s),e()}})}const Q=128;async function oa(a){const e=document.createElement("canvas"),o=a.width/a.height;e.width=Q,e.height=Q/o;const s=e.getContext("2d");return s?(s.drawImage(a,0,0,e.width,e.height),e.toDataURL("image/jpeg",.7)):""}function G(){const{user:a}=z(),[e,o]=f.useState([]),[s,r]=f.useState(!0),{addToast:n}=U(),{t:l}=C();f.useEffect(()=>{a!=null&&a.id?(r(!0),X().then(async d=>{const m=d.flatMap(g=>[g.sourceImageURL,g.thumbnail]);await Promise.all(m.map(K)),o(d)}).catch(d=>{console.error("Failed to load stamps from DB",d),n(l("gallery.loadErrorToast"),"error")}).finally(()=>{r(!1)})):(o([]),r(!1))},[a==null?void 0:a.id,n,l]);const i=f.useCallback(()=>{a!=null&&a.id&&(r(!0),X().then(async d=>{const m=d.flatMap(g=>[g.sourceImageURL,g.thumbnail]);await Promise.all(m.map(K)),o(d)}).catch(d=>{console.error("Failed to load stamps from DB",d),n(l("gallery.loadErrorToast"),"error")}).finally(()=>{r(!1)}))},[a==null?void 0:a.id,n,l]),c=f.useCallback(async(d,m,g)=>{if(!a){n(l("gallery.loginToast"),"info");return}try{const h=ta(d,m.stamp_size),x=h.toDataURL("image/jpeg",.7),b=await oa(h),v={user_id:a.id,name:g,thumbnail:b,settings:m,sourceImageURL:x},w=await de(v);o(j=>[w,...j]),n(l("gallery.addSuccessToast",{name:g}),"success"),i()}catch(h){console.error("Failed to add stamp to gallery:",h),n(l("gallery.addErrorToast"),"error"),o(x=>x.filter(b=>b.user_id===a.id))}},[n,a,l]),u=f.useCallback(async d=>{const m=e;o(g=>g.filter(h=>h.id!==d));try{await rt(d),n(l("gallery.deleteSuccessToast"),"info")}catch(g){console.error("Failed to delete stamp:",g),n(l("gallery.deleteErrorToast"),"error"),o(m)}},[n,e,l]),p=f.useCallback(async(d,m)=>{const g=[...e],h=e.find(b=>b.id===d);if(!h)return;const x=h.name;o(b=>b.map(v=>v.id===d?{...v,name:m}:v));try{await lt(d,m),n(l("gallery.renameSuccessToast",{name:m}),"success")}catch(b){console.error("Failed to rename stamp:",b),n(l("gallery.renameErrorToast",{oldName:x}),"error"),o(g)}},[n,e,l]);return{stamps:e,loading:s,addStampToGallery:c,deleteStampFromGallery:u,renameStampInGallery:p,refreshStamps:i}}function Oa(a,e,o,s){const n=a*Math.PI/180,l=o*Math.PI/180,i=(o-a)*Math.PI/180,c=(s-e)*Math.PI/180,u=Math.sin(i/2)*Math.sin(i/2)+Math.cos(n)*Math.cos(l)*Math.sin(c/2)*Math.sin(c/2);return 6371e3*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))}function aa(a,e,o=64){const[s,r]=a,n={latitude:r,longitude:s},l=e/1e3,i=[],c=l/(111.32*Math.cos(n.latitude*Math.PI/180)),u=l/110.574;let p,d,m;for(let g=0;g<o;g++)p=g/o*(2*Math.PI),d=c*Math.cos(p),m=u*Math.sin(p),i.push([n.longitude+d,n.latitude+m]);return i.push(i[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[i]},properties:{}}}const sa=({isVisible:a,onMapLoad:e,onGeolocate:o,onMapClick:s,children:r,className:n="",cursor:l="",mapRef:i})=>{const{addToast:c}=U(),{t:u}=C(),[p,d]=f.useState({longitude:-.09,latitude:51.505,zoom:3}),[m,g]=f.useState(!1),h=f.useRef(null),x=i||h,b=f.useRef(null),v=f.useRef(!1),w=y=>{let S=u("mapEditor.locationError.unknown");switch(y.code){case y.PERMISSION_DENIED:S=u("mapEditor.locationError.denied");break;case y.POSITION_UNAVAILABLE:S=u("mapEditor.locationError.unavailable");break;case y.TIMEOUT:S=u("mapEditor.locationError.timeout");break}c(S,"error")},j=f.useCallback(y=>{v.current||(v.current=!0,c(u("mapEditor.centeredToast"),"success")),o==null||o({latitude:y.coords.latitude,longitude:y.coords.longitude})},[c,u,o]),T=f.useCallback(()=>{m||setTimeout(()=>{if(b.current)try{b.current.trigger(),g(!0)}catch(y){console.warn("Failed to trigger geolocation on load:",y)}},500),e==null||e()},[m,e]);return f.useEffect(()=>{if(a&&x.current){const y=setTimeout(()=>{var S;return(S=x.current)==null?void 0:S.getMap().resize()},1);return()=>clearTimeout(y)}},[a,x]),f.useEffect(()=>{if(!m){const y=setTimeout(()=>{if(b.current)try{b.current.trigger(),g(!0)}catch(S){console.warn("Failed to trigger geolocation on mount:",S),(navigator.userAgent.includes("iPhone")||navigator.userAgent.includes("iPad"))&&c(u("mapEditor.iOSLocationPrompt")||"Tap the location button to center on your position","info")}},1e3);return()=>clearTimeout(y)}},[m,c,u]),t.jsx("div",{className:`relative w-full h-full bg-gray-700 ${l} ${n}`,children:t.jsxs(Be,{ref:x,mapLib:ot,...p,onMove:y=>d(y.viewState),onClick:s,onLoad:T,mapStyle:"https://tiles.openfreemap.org/styles/positron",style:{width:"100%",height:"100%"},children:[t.jsx(We,{ref:b,positionOptions:{enableHighAccuracy:!0,timeout:1e4,maximumAge:0},trackUserLocation:!0,showUserLocation:!0,showAccuracyCircle:!0,fitBoundsOptions:{maxZoom:15},onError:w,onGeolocate:j}),r]})})},na=({isVisible:a,selectedLocation:e,setSelectedLocation:o,geolocations:s,setEditingLocation:r,newLocationCoords:n,setNewLocationCoords:l,isPlacingOnMap:i,setIsPlacingOnMap:c,deleteGeolocation:u})=>{const{stamps:p}=G(),{t:d}=C(),m=f.useRef(null),g=f.useMemo(()=>({type:"FeatureCollection",features:s.map(b=>{const v=aa([b.longitude,b.latitude],b.radius);return v.properties={id:b.id},v})}),[s]),h=b=>{if(i){const{lng:v,lat:w}=b.lngLat;l({latitude:w,longitude:v}),c(!1)}e&&o(null)},x=f.useMemo(()=>e!=null&&e.stamp_id&&p.find(b=>b.id===e.stamp_id)||null,[e,p]);return f.useEffect(()=>{n&&(r(null),o(null))},[n,o,r]),t.jsx(t.Fragment,{children:t.jsxs(sa,{isVisible:a,onMapClick:h,cursor:i?"cursor-add":"",mapRef:m,children:[t.jsxs(Ve,{id:"radius-circles",type:"geojson",data:g,children:[t.jsx(Y,{id:"radius-circles-fill",type:"fill",paint:{"fill-color":"#ef4444","fill-opacity":.25}}),t.jsx(Y,{id:"radius-circles-stroke",type:"line",paint:{"line-color":"#ef4444","line-width":1.5,"line-dasharray":[2,2]}})]}),s.map(b=>t.jsx(Je,{longitude:b.longitude,latitude:b.latitude,style:{zIndex:20},children:t.jsx("button",{onClick:v=>{v.stopPropagation(),o(b)},"aria-label":d("mapEditor.viewLocation",{name:b.name}),children:t.jsx(B,{className:"text-red-500 w-8 h-8 drop-shadow-lg",strokeWidth:1.5})})},b.id)),e&&t.jsx(Ye,{longitude:e.longitude,latitude:e.latitude,onClose:()=>o(null),closeOnClick:!1,anchor:"bottom",offset:35,style:{zIndex:20},children:t.jsxs("div",{className:"flex flex-col",children:[x&&t.jsx("img",{src:x.thumbnail,alt:x.name,className:"w-full h-32 object-contain bg-gray-900/50 rounded-t-md"}),t.jsxs("div",{className:"p-3",children:[t.jsx("h3",{className:"font-bold text-lg text-white mb-1",children:e.name}),t.jsx("p",{className:"text-sm text-gray-300 mb-3",children:e.description}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("button",{onClick:()=>{r(e),o(null)},className:"flex-1 bg-blue-600 text-white px-2 py-1.5 text-xs rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-1.5",children:[t.jsx(He,{className:"w-3 h-3"})," ",d("common.edit")]}),t.jsxs("button",{onClick:()=>u(e.id),className:"flex-1 bg-red-600 text-white px-2 py-1.5 text-xs rounded-md hover:bg-red-700 transition-colors flex items-center justify-center gap-1.5",children:[t.jsx(Xe,{className:"w-3 h-3"})," ",d("common.delete")]})]})]})]})})]})})},ra=({isOpen:a,onClose:e,locations:o,selectedLocationId:s,onSelectLocation:r})=>{const{t:n}=C(),l=i=>{r(i),e()};return t.jsx("aside",{className:`fixed top-0 left-0 h-full bg-gray-800 flex-shrink-0 transition-transform duration-300 ease-in-out z-40 w-full max-w-sm border-r-2 border-gray-700 shadow-2xl ${a?"translate-x-0":"-translate-x-full"}`,"aria-hidden":!a,children:t.jsxs("div",{className:"h-full flex flex-col",children:[t.jsxs("div",{className:"p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0",children:[t.jsx("h1",{className:"text-xl font-bold",children:n("locationList.title")}),t.jsx("button",{onClick:e,className:"p-2 rounded-full hover:bg-gray-700","aria-label":n("common.close"),children:t.jsx(A,{className:"w-5 h-5"})})]}),t.jsx("div",{className:"flex-grow overflow-y-auto p-2 no-scrollbar",children:o.length===0?t.jsxs("div",{className:"text-center text-gray-400 mt-8 px-4",children:[t.jsx("p",{children:n("locationList.empty")}),t.jsx("p",{className:"text-sm mt-1",children:n("locationList.emptySubtext")})]}):t.jsx("ul",{className:"flex flex-col gap-2",children:o.map(i=>t.jsx("li",{children:t.jsxs("button",{onClick:()=>l(i),className:`w-full flex items-center gap-3 text-left p-2 rounded-lg transition-colors duration-200 ${s===i.id?"bg-blue-600 text-white":"text-gray-200 hover:bg-gray-700"}`,"aria-label":n("locationList.selectLocation",{name:i.name}),"aria-current":s===i.id,children:[t.jsx("div",{className:"w-10 h-10 flex-shrink-0 bg-gray-900/50 rounded-md flex items-center justify-center",children:i.stamp?t.jsx("img",{src:i.stamp.thumbnail,alt:i.stamp.name,className:"w-full h-full object-contain"}):t.jsx(B,{className:"w-6 h-6 text-gray-500"})}),t.jsx("span",{className:"flex-grow font-medium truncate",children:i.name})]})},i.id))})})]})})},la=({isVisible:a,isPlacingOnMap:e,setIsPlacingOnMap:o,newLocationCoords:s,setNewLocationCoords:r,setEditingLocation:n,isLocationListOpen:l,setIsLocationListOpen:i,geolocations:c,deleteGeolocation:u})=>{const[p,d]=f.useState(null),{addToast:m}=U(),{stamps:g}=G(),{t:h}=C();f.useEffect(()=>{e&&m(h("mapEditor.addLocationToast"),"info")},[e,m,h]);const x=f.useMemo(()=>c.map(w=>({...w,stamp:g.find(j=>j.id===w.stamp_id)||null})).sort((w,j)=>w.created_at&&j.created_at?new Date(j.created_at).getTime()-new Date(w.created_at).getTime():0),[c,g]),b=async w=>{window.confirm(h("mapEditor.deleteConfirm"))&&(await u(w),d(null))},v=w=>{d(w)};return f.useEffect(()=>{s&&(n(null),d(null))},[s,d,n]),t.jsxs("div",{className:`w-full h-full ${a?"block":"hidden"}`,children:[t.jsx(na,{isVisible:a,selectedLocation:p,setSelectedLocation:d,geolocations:c,setEditingLocation:n,setNewLocationCoords:r,isPlacingOnMap:e,setIsPlacingOnMap:o,deleteGeolocation:b,newLocationCoords:s}),t.jsx(ra,{isOpen:l,onClose:()=>i(!1),locations:x,selectedLocationId:(p==null?void 0:p.id)||null,onSelectLocation:v})]})},ia=({text:a})=>t.jsxs("div",{className:"relative group flex items-center",children:[t.jsx(oe,{className:"w-4 h-4 text-gray-500 cursor-help"}),t.jsx("div",{className:"absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-max max-w-xs p-2 text-xs text-white bg-gray-900 border border-gray-600 rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10",children:a})]});function ca({label:a,name:e,value:o,min:s,max:r,step:n,unit:l="",tooltip:i,disabled:c=!1,onChange:u}){const p=m=>{var g;return n<1?m.toFixed(((g=n.toString().split(".")[1])==null?void 0:g.length)||2):m.toString()},d=(o-s)/(r-s)*100;return t.jsxs("div",{className:"pt-3 flex-1",children:[a&&t.jsxs("div",{className:"flex justify-between items-center mb-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{htmlFor:e,className:`text-sm font-medium ${c?"text-gray-500":"text-gray-300"}`,children:a}),i&&t.jsx(ia,{text:i})]}),t.jsxs("span",{className:`text-sm font-mono ${c?"text-gray-500":"text-blue-400"}`,children:[p(o),l]})]}),t.jsx("input",{type:"range",id:e,name:e,min:s,max:r,step:n,value:o,onChange:u,disabled:c,className:"w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer slider disabled:cursor-not-allowed",style:{background:c?"#4b5563":`linear-gradient(to right, #3b82f6 0%, #3b82f6 ${d}%, #4b5563 ${d}%, #4b5563 100%)`}})]})}const da=({initialData:a,onSave:e,onClose:o})=>{const[s,r]=f.useState(a.name||""),[n,l]=f.useState(a.description||""),[i,c]=f.useState(a.radius||100),[u,p]=f.useState(a.stamp_id||null),{stamps:d,loading:m}=G(),{t:g}=C(),h=()=>{if(!s.trim()){alert(g("locationEditModal.validationError"));return}e({name:s,description:n,radius:i,latitude:a.latitude,longitude:a.longitude,stamp_id:u})};return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm animate-fade-in","aria-modal":"true",role:"dialog",onClick:o,children:t.jsxs("div",{className:"relative w-full max-w-lg m-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-white transform animate-scale-in flex flex-col gap-6",onClick:x=>x.stopPropagation(),children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("h2",{className:"text-2xl font-bold",children:a.id?g("locationEditModal.titleEdit"):g("locationEditModal.titleAdd")}),t.jsx("button",{onClick:o,className:"p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors","aria-label":g("common.close"),children:t.jsx(A,{className:"w-6 h-6"})})]}),t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsx("input",{type:"text",placeholder:g("locationEditModal.namePlaceholder"),value:s,onChange:x=>r(x.target.value),className:"w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition"}),t.jsx("textarea",{placeholder:`${g("common.description")} (${g("common.optional")})`,value:n||"",onChange:x=>l(x.target.value),rows:3,className:"w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition resize-none"}),t.jsx(ca,{label:g("locationEditModal.radius"),name:"radius",value:i,min:10,max:1e3,step:10,unit:"m",onChange:x=>c(parseInt(x.target.value,10)),tooltip:g("locationEditModal.radiusTooltip")})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold mb-3",children:g("locationEditModal.assignStamp")}),t.jsx("div",{className:"h-48 bg-gray-900/50 rounded-lg p-3 overflow-y-auto no-scrollbar border border-gray-700",children:m?t.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:g("locationEditModal.loadingStamps")}):t.jsxs("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-3",children:[t.jsxs("button",{onClick:()=>p(null),className:`w-full aspect-square rounded-lg flex flex-col items-center justify-center text-gray-400 transition-all duration-200 focus:outline-none ring-offset-2 ring-offset-gray-800 focus:ring-2 ${u===null?"ring-2 ring-blue-500 bg-blue-500/10":"ring-1 ring-gray-600 hover:ring-blue-500 bg-gray-700"}`,children:[t.jsx(Ze,{className:"w-8 h-8"}),t.jsx("span",{className:"text-xs mt-1",children:g("locationEditModal.noStamp")})]}),d.map(x=>t.jsx("button",{onClick:()=>p(x.id),className:`w-full aspect-square rounded-lg overflow-hidden transition-all duration-200 focus:outline-none ring-offset-2 ring-offset-gray-800 focus:ring-2 ${u===x.id?"ring-2 ring-blue-500":"ring-1 ring-gray-700 hover:ring-blue-500"}`,children:t.jsx("img",{src:x.thumbnail,alt:x.name,className:"w-full h-full object-contain bg-gray-900/50"})},x.id))]})})]}),t.jsxs("div",{className:"flex gap-4",children:[t.jsx("button",{onClick:o,className:"w-full bg-gray-600 hover:bg-gray-500 font-medium py-3 px-4 rounded-lg transition-colors",children:g("common.cancel")}),t.jsxs("button",{onClick:h,className:"w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2",children:[t.jsx(Ke,{className:"w-5 h-5"}),g("common.save")]})]})]})})},ua=({onSave:a,onClose:e})=>{const{t:o}=C(),[s,r]=f.useState(""),[n,l]=f.useState(""),[i,c]=f.useState({}),u=()=>{const d={},m=parseFloat(s),g=parseFloat(n);return s?(isNaN(m)||m<-90||m>90)&&(d.lat=o("coordInputModal.validation.latInvalid")):d.lat=o("coordInputModal.validation.latRequired"),n?(isNaN(g)||g<-180||g>180)&&(d.lon=o("coordInputModal.validation.lonInvalid")):d.lon=o("coordInputModal.validation.lonRequired"),c(d),Object.keys(d).length===0},p=d=>{d.preventDefault(),u()&&a({latitude:parseFloat(s),longitude:parseFloat(n)})};return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm animate-fade-in","aria-modal":"true",role:"dialog",onClick:e,children:t.jsxs("div",{className:"relative w-full max-w-md m-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-white transform animate-scale-in flex flex-col gap-6",onClick:d=>d.stopPropagation(),children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("h2",{className:"text-2xl font-bold",children:o("coordInputModal.title")}),t.jsx("button",{onClick:e,className:"p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors","aria-label":o("common.close"),children:t.jsx(A,{className:"w-6 h-6"})})]}),t.jsxs("form",{onSubmit:p,className:"flex flex-col gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{htmlFor:"latitude",className:"block text-sm font-medium text-gray-300 mb-1",children:o("coordInputModal.latitude")}),t.jsx("input",{id:"latitude",type:"number",step:"any",placeholder:o("coordInputModal.latitudePlaceholder"),value:s,onChange:d=>r(d.target.value),className:`w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border ${i.lat?"border-red-500":"border-gray-600"} focus:ring-2 focus:ring-blue-500 focus:outline-none transition`}),i.lat&&t.jsx("p",{className:"text-red-400 text-xs mt-1",children:i.lat})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"longitude",className:"block text-sm font-medium text-gray-300 mb-1",children:o("coordInputModal.longitude")}),t.jsx("input",{id:"longitude",type:"number",step:"any",placeholder:o("coordInputModal.longitudePlaceholder"),value:n,onChange:d=>l(d.target.value),className:`w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border ${i.lon?"border-red-500":"border-gray-600"} focus:ring-2 focus:ring-blue-500 focus:outline-none transition`}),i.lon&&t.jsx("p",{className:"text-red-400 text-xs mt-1",children:i.lon})]}),t.jsxs("div",{className:"flex gap-4 pt-2",children:[t.jsx("button",{type:"button",onClick:e,className:"w-full bg-gray-600 hover:bg-gray-500 font-medium py-3 px-4 rounded-lg transition-colors",children:o("common.cancel")}),t.jsxs("button",{type:"submit",className:"w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2",children:[o("coordInputModal.next"),t.jsx(se,{className:"w-5 h-5"})]})]})]})]})})},ma=({onImport:a,onClose:e})=>{const{t:o}=C(),[s,r]=f.useState(""),[n,l]=f.useState(!1),[i,c]=f.useState(null),u=async()=>{if(c(null),!/^([NWR]\d+|\d+)$/i.test(s)){c("invalidId");return}l(!0);let g=s;/^\d+$/.test(s)&&(g=`N${s}`);try{const h=await fetch(`https://nominatim.openstreetmap.org/lookup?osm_ids=${g.toUpperCase()}&format=json`);if(!h.ok)throw new Error("Network response was not ok");const x=await h.json();x&&x.length>0?a({latitude:parseFloat(x[0].lat),longitude:parseFloat(x[0].lon)}):c("notFound")}catch(h){console.error("OSM Import Error:",h),c("network")}finally{l(!1)}},p=m=>{m.preventDefault(),u()},d={invalidId:o("osmImportModal.error.invalidId"),notFound:o("osmImportModal.error.notFound"),network:o("osmImportModal.error.network")};return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm animate-fade-in","aria-modal":"true",role:"dialog",onClick:e,children:t.jsxs("div",{className:"relative w-full max-w-md m-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-white transform animate-scale-in flex flex-col gap-6",onClick:m=>m.stopPropagation(),children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("h2",{className:"text-2xl font-bold",children:o("osmImportModal.title")}),t.jsx("button",{onClick:e,className:"p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors","aria-label":o("common.close"),children:t.jsx(A,{className:"w-6 h-6"})})]}),t.jsxs("form",{onSubmit:p,className:"flex flex-col gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{htmlFor:"osmId",className:"block text-sm font-medium text-gray-300 mb-1",children:o("osmImportModal.idLabel")}),t.jsx("input",{id:"osmId",type:"text",placeholder:o("osmImportModal.idPlaceholder"),value:s,onChange:m=>r(m.target.value),className:`w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border ${i?"border-red-500":"border-gray-600"} focus:ring-2 focus:ring-blue-500 focus:outline-none transition`}),t.jsx("p",{className:"text-xs text-gray-400 mt-2",children:o("osmImportModal.helpText")})]}),i&&t.jsx("p",{className:"text-red-400 text-xs mt-1",children:d[i]}),t.jsxs("div",{className:"flex gap-4 pt-2",children:[t.jsx("button",{type:"button",onClick:e,className:"w-full bg-gray-600 hover:bg-gray-500 font-medium py-3 px-4 rounded-lg transition-colors",children:o("common.cancel")}),t.jsx("button",{type:"submit",disabled:n||!s,className:"w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:bg-gray-600 disabled:cursor-not-allowed",children:n?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),o("osmImportModal.importing")]}):t.jsxs(t.Fragment,{children:[t.jsx(ne,{className:"w-5 h-5"}),o("osmImportModal.import")]})})]})]})]})})},ga=[{name:"Default",settings:{}},{name:"Gritty",settings:{edge_boost:5,wear_intensity:[.4,.2],noise_scale:[30,10],ink_depletion_intensity:[.5,.1],splat_density:.9}},{name:"Faded",settings:{edge_boost:1,wear_intensity:[.7,.1],noise_scale:[100,5],ink_depletion_intensity:[.8,.05],splat_density:.5,bleeding_factor:.2}},{name:"Clean",settings:{color_shape_shrink:1,shift:[.5,.2],rotation:[.2,.1],edge_width:2,edge_boost:1,wear_intensity:[.05,.01],ink_depletion_intensity:[.1,.01],splat_density:1.2,bleeding_factor:.05}}];async function pa(a,e,o,s){const r={successCount:0,totalCount:o.length,errors:[]};for(let n=0;n<o.length;n++){const l=o[n];try{const i=ga.find(p=>p.name===l.preset),c={...ea,...i?i.settings:{}},u=await de({user_id:a,name:l.name,thumbnail:"data:image/jpeg;base64,"+l.image,sourceImageURL:"data:image/jpeg;base64,"+l.image,settings:c});await ue({user_id:a,rally_id:e,stamp_id:u.id,name:l.name,description:l.description,latitude:l.coordinates[0],longitude:l.coordinates[1],radius:l.collection_radius}),r.successCount++}catch(i){console.error(`Error processing item ${l.name}:`,i),r.errors.push({item:l,error:i.message})}s(Math.round((n+1)/o.length*100))}return r}const ha=({isOpen:a,onClose:e,rallyId:o})=>{const{t:s}=C(),{addToast:r}=U(),{user:n}=z(),{refreshStamps:l}=G(),[i,c]=f.useState(null),[u,p]=f.useState(0),[d,m]=f.useState("idle"),[g,h]=f.useState(null),x=f.useRef(null),b=j=>{if(j.target.files&&j.target.files[0]){const T=j.target.files[0];T.type==="application/json"?(c(T),m("idle"),h(null),p(0)):(c(null),m("error"),h(s("batchUpload.invalidFileType")),r(s("batchUpload.invalidFileType"),"error"))}},v=async()=>{if(!i){h(s("batchUpload.noFileSelected")),r(s("batchUpload.noFileSelected"),"error");return}if(!n){h(s("batchUpload.loginRequired")),r(s("batchUpload.loginRequired"),"error");return}m("uploading"),h(null);try{const j=new FileReader;j.onload=async T=>{var y;try{const S=(y=T.target)==null?void 0:y.result,I=JSON.parse(S);m("processing");const E=await pa(n.id,o,I,R=>{p(R)});E.errors.length>0?(m("error"),h(s("batchUpload.partialSuccess",{success:E.successCount,total:E.totalCount})),r(s("batchUpload.partialSuccess",{success:E.successCount,total:E.totalCount}),"info")):(m("success"),r(s("batchUpload.success",{count:E.successCount}),"success"),l())}catch(S){m("error"),h(s("batchUpload.invalidJson")+`: ${S.message}`),r(s("batchUpload.invalidJson"),"error")}},j.readAsText(i)}catch(j){m("error"),h(s("batchUpload.uploadFailed")+`: ${j.message}`),r(s("batchUpload.uploadFailed")+`: ${j.message}`,"error")}},w=()=>{c(null),p(0),m("idle"),h(null),x.current&&(x.current.value=""),e()};return a?t.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"#1f2937",padding:"20px",borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",zIndex:20,width:"90%",maxWidth:"425px",border:"1px solid #374151"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px"},children:[t.jsx("h2",{style:{fontSize:"1.25rem",fontWeight:"600",color:"#f9fafb"},children:s("batchUpload.title")}),t.jsx("button",{onClick:w,style:{background:"none",border:"none",cursor:"pointer",color:"#9ca3af"},children:t.jsx(A,{size:20})})]}),t.jsxs("div",{style:{marginBottom:"15px"},children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"24px",border:"2px dashed #4b5563",borderRadius:"8px",color:"#9ca3af"},children:[t.jsx("input",{id:"json-upload",type:"file",accept:".json",onChange:b,style:{display:"none"},ref:x}),t.jsxs("label",{htmlFor:"json-upload",style:{cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center"},children:[t.jsx(re,{size:48,style:{marginBottom:"8px"}}),t.jsx("p",{style:{fontSize:"0.875rem",marginBottom:"4px"},children:s("batchUpload.dragDrop")}),t.jsx("p",{style:{fontSize:"0.75rem",color:"#6b7280"},children:s("batchUpload.orClick")})]}),i&&t.jsxs("p",{style:{marginTop:"8px",fontSize:"0.875rem",color:"#f9fafb"},children:[s("batchUpload.selectedFile"),": ",i.name]})]}),d==="uploading"&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#60a5fa",marginTop:"15px"},children:[t.jsx(H,{size:20,style:{animation:"spin 1s linear infinite"}}),t.jsx("span",{children:s("batchUpload.readingFile")})]}),d==="processing"&&t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"8px",marginTop:"15px"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#60a5fa"},children:[t.jsx(H,{size:20,style:{animation:"spin 1s linear infinite"}}),t.jsx("span",{children:s("batchUpload.processingItems")})]}),t.jsx("div",{style:{width:"100%",height:"8px",backgroundColor:"#4b5563",borderRadius:"4px",overflow:"hidden"},children:t.jsx("div",{style:{width:`${u}%`,height:"100%",backgroundColor:"#60a5fa",transition:"width 0.3s ease-in-out"}})}),t.jsxs("p",{style:{fontSize:"0.875rem",color:"#9ca3af",textAlign:"center"},children:[u,"%"]})]}),d==="success"&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#4ade80",marginTop:"15px"},children:[t.jsx(ae,{size:20}),t.jsx("span",{children:s("batchUpload.uploadComplete")})]}),d==="error"&&g&&t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#ef4444",marginTop:"15px"},children:[t.jsx(Qe,{size:20}),t.jsx("span",{children:g})]}),t.jsx("button",{onClick:v,disabled:!i||d==="uploading"||d==="processing",style:{marginTop:"15px",width:"100%",padding:"10px 15px",backgroundColor:"#60a5fa",color:"#f9fafb",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"1rem",fontWeight:"500",opacity:!i||d==="uploading"||d==="processing"?.5:1,transition:"opacity 0.2s ease-in-out"},children:s(d==="processing"?"common.submitting":"batchUpload.uploadButton")})]})]}):null},fa=({editingLocation:a,newLocationCoords:e,setEditingLocation:o,setNewLocationCoords:s,coordInputOpen:r,setCoordInputOpen:n,osmImportOpen:l,setOsmImportOpen:i,isBatchUploadModalOpen:c,setIsBatchUploadModalOpen:u,managedRally:p,handleSaveLocation:d})=>t.jsxs(t.Fragment,{children:[(a||e)&&!r&&!l&&t.jsx(da,{initialData:a||e,onSave:d,onClose:()=>{o(null),s(null)}}),r&&t.jsx(ua,{onSave:m=>{n(!1),s(m)},onClose:()=>n(!1)}),l&&t.jsx(ma,{onImport:m=>{i(!1),s(m)},onClose:()=>i(!1)}),c&&p&&t.jsx(ha,{isOpen:c,onClose:()=>u(!1),rallyId:p.id})]});function xa(a){const{user:e}=z(),[o,s]=f.useState([]),[r,n]=f.useState(!0),{addToast:l}=U(),{t:i}=C();f.useEffect(()=>{if(!(e!=null&&e.id)||!a){s([]),n(!1);return}n(!0);const m=(async()=>{try{const h=await ct(a);s(h)}catch(h){console.error("Failed to load geolocations from DB",h),l(i("geolocations.loadErrorToast"),"error")}finally{n(!1)}const g=N.channel(`geolocations_rally_${a}`).on("postgres_changes",{event:"*",schema:"public",table:"geolocations",filter:`rally_id=eq.${a}`},h=>{h.eventType==="INSERT"?s(x=>[...x,h.new]):h.eventType==="UPDATE"?s(x=>x.map(b=>b.id===h.old.id?h.new:b)):h.eventType==="DELETE"&&s(x=>x.filter(b=>b.id!==h.old.id))}).subscribe();return()=>{N.removeChannel(g)}})();return()=>{m.then(g=>g&&g())}},[e==null?void 0:e.id,a,l,i]);const c=f.useCallback(async d=>{if(!e||!a){l(i("geolocations.loginToast"),"info");return}const m={user_id:e.id,rally_id:a,name:d.name,latitude:d.latitude,longitude:d.longitude,radius:d.radius,description:d.description??null,stamp_id:d.stamp_id??null},g=`temp-${Date.now()}`;s(h=>[...h,{...m,id:g,created_at:new Date().toISOString()}]);try{const h=await ue({user_id:e.id,rally_id:a,name:d.name,latitude:d.latitude,longitude:d.longitude,radius:d.radius,description:d.description??null,stamp_id:d.stamp_id??null});l(i("geolocations.addSuccessToast",{name:h.name}),"success"),s(x=>x.map(b=>b.id===g?h:b))}catch(h){console.error("Failed to add geolocation:",h),l(i("geolocations.addErrorToast"),"error"),s(x=>x.filter(b=>b.id!==g))}},[e,a,l,i]),u=f.useCallback(async(d,m)=>{const g=[...o];s(h=>h.map(x=>x.id===d?{...x,...m}:x));try{await dt(d,m),l(i("geolocations.updateSuccessToast"),"success")}catch(h){console.error("Failed to update geolocation:",h),l(i("geolocations.updateErrorToast"),"error"),s(g)}},[o,l,i]),p=f.useCallback(async d=>{const m=[...o];s(g=>g.filter(h=>h.id!==d));try{await ut(d),l(i("geolocations.deleteSuccessToast"),"info")}catch(g){console.error("Failed to delete geolocation:",g),l(i("geolocations.deleteErrorToast"),"error"),s(m)}},[o,l,i]);return{geolocations:o,loading:r,addGeolocation:c,updateGeolocation:u,deleteGeolocation:p}}const ee=_.lazy(()=>$(()=>import("./StampRally-DBpPbCEv.js"),__vite__mapDeps([0,1,2,3,4,5,6]))),ba=_.lazy(()=>$(()=>import("./StampEditor-CXaCv9Sz.js"),__vite__mapDeps([7,1,2,3,4,5,6]))),ya=_.lazy(()=>$(()=>import("./JoinRallyScreen-Zo3ejrq-.js"),__vite__mapDeps([8,1,2,3,4,6]))),wa=_.lazy(()=>$(()=>import("./RallyAdminDashboard-DztCTYqg.js"),__vite__mapDeps([9,1,2,3,4,6])));function ja(){const{user:a,loading:e,role:o,activeRallyId:s}=z(),[r,n]=f.useState("admin"),[l,i]=f.useState(!1),[c,u]=f.useState(null),[p,d]=f.useState(!1),[m,g]=f.useState(!1),[h,x]=f.useState(null),[b,v]=f.useState(null),[w,j]=f.useState(!1),[T,y]=f.useState(!1),[S,I]=f.useState(!1),[E,R]=f.useState(!1),{addGeolocation:xe,updateGeolocation:be,geolocations:ye,deleteGeolocation:we}=xa((c==null?void 0:c.id)||null),je=async M=>{"id"in M&&M.id?await be(M.id,M):await xe(M),x(null),v(null)},Se=M=>{switch(I(!1),M){case"map":R(!0);break;case"coords":j(!0);break;case"osm":y(!0);break;case"batch":i(!0);break}};f.useEffect(()=>{sessionStorage.getItem("splashSeen")||d(!0)},[]),f.useEffect(()=>{o&&!c&&n(o==="user"?"rally":"admin")},[o,c]);const ve=()=>{d(!1),sessionStorage.setItem("splashSeen","true")},Te=M=>{u(M),n("map")},Ne=()=>{u(null),n("admin")},Ie=()=>{if(o==="user")return t.jsx(_.Suspense,{fallback:t.jsx(L,{}),children:t.jsx(ee,{})});if(o==="admin"){const M=!!c,Ce=!M&&r==="admin",Me=M&&r==="map",W=M&&r==="rally",ke=r==="stamp";return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:`w-full h-full ${Ce?"block":"hidden"}`,children:t.jsx(_.Suspense,{fallback:t.jsx(L,{}),children:t.jsx(wa,{onManageRally:Te})})}),t.jsx(la,{isVisible:Me,isPlacingOnMap:E,setIsPlacingOnMap:R,newLocationCoords:b,setNewLocationCoords:v,setEditingLocation:x,isLocationListOpen:m,setIsLocationListOpen:g,geolocations:ye,deleteGeolocation:we}),t.jsx("div",{className:`w-full h-full ${W?"block":"hidden"}`,children:t.jsx(ee,{adminTestingRallyId:(c==null?void 0:c.id)||null,isVisible:W})}),t.jsx("div",{className:`w-full h-full ${ke?"block":"hidden"}`,children:t.jsx(_.Suspense,{fallback:t.jsx(L,{}),children:t.jsx(ba,{})})})]})}return t.jsx(L,{})};return e?t.jsx(L,{}):a?o==="user"&&!s?t.jsx(_.Suspense,{fallback:t.jsx(L,{}),children:t.jsx(ya,{})}):t.jsxs(Eo,{mode:r,setMode:n,isAdmin:o==="admin",isManaging:!!c,managedRally:c,handleExitManagement:Ne,isLocationListOpen:m,setIsLocationListOpen:g,addMenuOpen:S,setAddMenuOpen:I,handleSelectAddMethod:Se,setIsPlacingOnMap:R,children:[Ie(),p&&t.jsx(No,{onClose:ve}),t.jsx(fa,{editingLocation:h,newLocationCoords:b,setEditingLocation:x,setNewLocationCoords:v,coordInputOpen:w,setCoordInputOpen:j,osmImportOpen:T,setOsmImportOpen:y,isBatchUploadModalOpen:l,setIsBatchUploadModalOpen:i,managedRally:c,handleSaveLocation:je})]}):t.jsx(To,{})}function Sa(){return t.jsx(nt,{children:t.jsx(mt,{children:t.jsx(vo,{children:t.jsx(ja,{})})})})}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(a=>{console.log("ServiceWorker registration successful with scope: ",a.scope)}).catch(a=>{console.log("ServiceWorker registration failed: ",a)})});const te=document.getElementById("root");te?et.createRoot(te).render(t.jsx(_.StrictMode,{children:t.jsx(Sa,{})})):console.error('Fatal error: The root element with ID "root" was not found in the DOM. React cannot be mounted.');export{sa as B,ca as S,ia as T,U as a,C as b,La as c,Fa as d,Ua as e,ta as f,Ra as g,za as h,xa as i,G as j,Oa as k,aa as l,ea as m,ga as n,Pa as o,K as p,Aa as q,ka as r,Ma as s,Ea as t,z as u,_a as v};
