import{r as l,j as e,X as se,m as we,W as Se,x as ae,Y as Ne,Q as Ce,Z as te,J as Pe,O as ke,$ as Te,a0 as _e,a1 as De,K as Ie}from"./react-vendor-XTfPaM14.js";import{B as T,u as Ee,I as ze}from"./Button-BKuiEg7y.js";import{C as Re,u as _,T as Ge,k as v,s as K,c as Le,b as ne,a as L,D as Oe,l as Fe,m as Ue,n as $e,o as Ae,p as M,q as H,f as qe,d as Be,g as Me}from"./index-M2HUoeYB.js";import"./vendor-DoV0xLrY.js";import"./maplibre-gl-vendor-BKez82u8.js";import"./supabase-vendor-BmfpuRp6.js";function E({title:s,icon:a,children:t,defaultOpen:r=!1}){const[c,o]=l.useState(r);return e.jsxs("div",{className:"bg-gray-700 rounded-xl overflow-hidden",children:[e.jsx(Re,{isOpen:c,setIsOpen:o,className:"w-full px-4 py-3 text-left flex items-center justify-between hover:bg-gray-600 transition-colors duration-200",iconClassName:"w-5 h-5 text-gray-400",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:a}),e.jsx("span",{className:"font-medium text-white",children:s})]})}),c&&e.jsx("div",{className:"flex flex-col px-4 pb-4 border-t border-gray-600",children:t})]})}function He({settings:s,handleSettingChange:a}){const{t}=_();return e.jsxs(e.Fragment,{children:[e.jsxs(E,{title:t("settingsSections.posterization.title"),icon:"🎨",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center pt-3 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{htmlFor:"num_colors",className:`text-sm font-medium ${s.num_colors==="auto"?"text-gray-500":"text-gray-300"}`,children:t("settingsSections.posterization.colors")}),e.jsx(Ge,{text:t("settingsSections.posterization.colorsTooltip")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{htmlFor:"auto_color_toggle",className:"text-sm font-medium text-gray-300 cursor-pointer",children:t("settingsSections.posterization.auto")}),e.jsx("input",{id:"auto_color_toggle",type:"checkbox",className:"form-checkbox h-5 w-5 rounded bg-gray-600 border-gray-500 text-blue-600 focus:ring-blue-500 cursor-pointer",checked:s.num_colors==="auto",onChange:r=>{const c={target:{name:"num_colors",value:r.target.checked?"auto":"5",type:"text"}};a(c)}})]})]}),e.jsx(v,{name:"num_colors",value:typeof s.num_colors=="number"?s.num_colors:5,min:1,max:15,step:1,disabled:s.num_colors==="auto",onChange:a})]}),e.jsx(v,{label:t("settingsSections.posterization.backgroundThreshold"),name:"background_threshold",value:s.background_threshold,min:0,max:254,step:1,onChange:a,tooltip:t("settingsSections.posterization.backgroundThresholdTooltip")}),e.jsx(v,{label:t("settingsSections.posterization.shapeShrink"),name:"color_shape_shrink",value:s.color_shape_shrink,min:0,max:10,step:1,unit:"px",onChange:a,tooltip:t("settingsSections.posterization.shapeShrinkTooltip")})]}),e.jsxs(E,{title:t("settingsSections.registration.title"),icon:"📐",children:[e.jsx("span",{className:"text-sm pt-2",children:t("settingsSections.registration.shift")}),e.jsxs("div",{className:"flex gap-x-4 justify-between",children:[e.jsx(v,{label:t("settingsSections.registration.amount"),name:"shift.0",value:s.shift[0],min:0,max:10,step:.1,unit:"px",onChange:a,tooltip:t("settingsSections.registration.shiftAmountTooltip")}),e.jsx(v,{label:t("settingsSections.registration.variation"),name:"shift.1",value:s.shift[1],min:0,max:5,step:.1,onChange:a,tooltip:t("settingsSections.registration.variationTooltip")})]}),e.jsx("span",{className:"text-sm pt-2",children:t("settingsSections.registration.rotation")}),e.jsxs("div",{className:"flex gap-x-4 justify-between",children:[e.jsx(v,{label:t("settingsSections.registration.amount"),name:"rotation.0",value:s.rotation[0],min:-5,max:5,step:.1,unit:"°",onChange:a,tooltip:t("settingsSections.registration.rotationAmountTooltip")}),e.jsx(v,{label:t("settingsSections.registration.variation"),name:"rotation.1",value:s.rotation[1],min:0,max:3,step:.1,onChange:a,tooltip:t("settingsSections.registration.variationTooltip")})]})]}),e.jsxs(E,{title:t("settingsSections.edge.title"),icon:"✨",children:[e.jsx(v,{label:t("settingsSections.edge.width"),name:"edge_width",value:s.edge_width,min:0,max:20,step:1,unit:"px",onChange:a,tooltip:t("settingsSections.edge.widthTooltip")}),e.jsx(v,{label:t("settingsSections.edge.boost"),name:"edge_boost",value:s.edge_boost,min:0,max:10,step:.1,onChange:a,tooltip:t("settingsSections.edge.boostTooltip")})]}),e.jsxs(E,{title:t("settingsSections.wear.title"),icon:"🔧",children:[e.jsx("span",{className:"text-sm pt-2",children:t("settingsSections.wear.intensity")}),e.jsxs("div",{className:"flex gap-x-4 justify-between",children:[e.jsx(v,{label:t("settingsSections.registration.amount"),name:"wear_intensity.0",value:s.wear_intensity[0],min:0,max:1,step:.05,onChange:a}),e.jsx(v,{label:t("settingsSections.registration.variation"),name:"wear_intensity.1",value:s.wear_intensity[1],min:0,max:1,step:.05,onChange:a})]}),e.jsx("span",{className:"text-sm pt-2",children:t("settingsSections.wear.noiseScale")}),e.jsxs("div",{className:"flex gap-x-4 justify-between",children:[e.jsx(v,{label:t("settingsSections.registration.amount"),name:"noise_scale.0",value:s.noise_scale[0],min:1,max:200,step:1,onChange:a}),e.jsx(v,{label:t("settingsSections.registration.variation"),name:"noise_scale.1",value:s.noise_scale[1],min:1,max:10,step:.1,onChange:a})]}),e.jsx("span",{className:"text-sm pt-2",children:t("settingsSections.wear.inkDepletion")}),e.jsxs("div",{className:"flex gap-x-4 justify-between",children:[e.jsx(v,{label:t("settingsSections.registration.amount"),name:"ink_depletion_intensity.0",value:s.ink_depletion_intensity[0],min:0,max:1,step:.05,onChange:a,tooltip:t("settingsSections.wear.inkDepletionAmountTooltip")}),e.jsx(v,{label:t("settingsSections.registration.variation"),name:"ink_depletion_intensity.1",value:s.ink_depletion_intensity[1],min:0,max:.2,step:.01,onChange:a})]}),e.jsx("span",{className:"text-sm pt-2",children:t("settingsSections.wear.numPatches")}),e.jsxs("div",{className:"flex gap-x-4 justify-between",children:[e.jsx(v,{label:t("settingsSections.registration.amount"),name:"num_patches.0",value:s.num_patches[0],min:0,max:15,step:1,onChange:a,tooltip:t("settingsSections.wear.numPatchesAmountTooltip")}),e.jsx(v,{label:t("settingsSections.registration.variation"),name:"num_patches.1",value:s.num_patches[1],min:0,max:5,step:1,onChange:a})]}),e.jsx("span",{className:"text-sm pt-2",children:t("settingsSections.wear.patchSize")}),e.jsxs("div",{className:"flex gap-x-4 justify-between",children:[e.jsx(v,{label:t("settingsSections.wear.min"),name:"patch_size_range.0",value:s.patch_size_range[0],min:1,max:200,step:1,unit:"px",onChange:a}),e.jsx(v,{label:t("settingsSections.wear.max"),name:"patch_size_range.1",value:s.patch_size_range[1],min:1,max:500,step:1,unit:"px",onChange:a})]})]}),e.jsxs(E,{title:t("settingsSections.splats.title"),icon:"💧",defaultOpen:!0,children:[e.jsx(v,{label:t("settingsSections.splats.density"),name:"splat_density",value:s.splat_density,min:.005,max:2,step:.005,onChange:a,tooltip:t("settingsSections.splats.densityTooltip")}),e.jsx("span",{className:"text-sm pt-2",children:t("settingsSections.splats.size")}),e.jsxs("div",{className:"flex gap-x-4 justify-between",children:[e.jsx(v,{label:t("settingsSections.wear.min"),name:"splat_size_range.0",value:s.splat_size_range[0],min:1,max:5,step:.1,onChange:a}),e.jsx(v,{label:t("settingsSections.wear.max"),name:"splat_size_range.1",value:s.splat_size_range[1],min:.1,max:10,step:.1,onChange:a})]}),e.jsx(v,{label:t("settingsSections.splats.bleeding"),name:"bleeding_factor",value:s.bleeding_factor,min:0,max:1,step:.05,onChange:a,tooltip:t("settingsSections.splats.bleedingTooltip")})]})]})}const V=async s=>{const{data:a,error:t}=await K.from("user_presets").select("name, settings").eq("user_id",s);return t?(console.error("Failed to load custom presets from Supabase:",t),[]):a.map(r=>({name:r.name,settings:r.settings}))},Ke=async(s,a,t)=>{const{error:r}=await K.from("user_presets").insert({user_id:s,name:a,settings:t});if(r)throw console.error("Failed to add custom preset to Supabase:",r),r;return V(s)},Ve=async(s,a)=>{const{error:t}=await K.from("user_presets").delete().eq("user_id",s).eq("name",a);if(t)throw console.error("Failed to delete custom preset from Supabase:",t),t;return V(s)},re=l.forwardRef(({className:s,type:a,...t},r)=>e.jsx("input",{type:a,className:Le("flex h-10 w-full rounded-md border border-gray-800 bg-gray-950 px-3 py-2 text-sm ring-offset-gray-900 file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-gray-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-300 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),ref:r,...t}));re.displayName="Input";const We=({staticPresets:s,activePreset:a,currentSettings:t,onSelectPreset:r})=>{const{t:c}=_(),{user:o}=ne(),{addToast:f}=L(),[S,w]=l.useState([]),[p,h]=l.useState(""),[j,b]=l.useState(!1);l.useEffect(()=>{(async()=>{if(o!=null&&o.id){const u=await V(o.id);w(u)}else w([])})()},[o]);const n=[...s,...S],y=async()=>{if(p.trim()===""||!(o!=null&&o.id)){f(c("presetSelector.savePresetError"),"error");return}try{const i=await Ke(o.id,p,t);w(i),h(""),f(c("presetSelector.savePresetSuccess",{name:p}),"success")}catch(i){console.error("Failed to save preset:",i),f(c("presetSelector.savePresetError"),"error")}},g=async i=>{if(!(o!=null&&o.id)){f(c("presetSelector.deletePresetError"),"error");return}try{const u=await Ve(o.id,i);w(u),f(c("presetSelector.deletePresetSuccess",{name:i}),"success")}catch(u){console.error("Failed to delete preset:",u),f(c("presetSelector.deletePresetError"),"error")}};return e.jsxs(Oe,{open:j,onOpenChange:b,children:[e.jsx(Fe,{asChild:!0,children:e.jsx(T,{variant:"secondary",className:"w-full justify-start text-left",children:c("presetSelector.managePresets")})}),e.jsxs(Ue,{className:"sm:max-w-[425px]",children:[e.jsx($e,{children:e.jsx(Ae,{children:c("presetSelector.managePresets")})}),e.jsx("div",{className:"grid gap-2 py-4 max-h-60 overflow-y-auto",children:n.map(i=>e.jsxs("div",{className:"relative flex items-center group",children:[e.jsx("button",{onClick:()=>{r(i),b(!1)},className:`flex-grow text-left text-sm font-medium py-4 px-3 rounded-2xl transition-colors duration-200
                  ${a===i.name?"bg-blue-600 text-white shadow-md":"bg-gray-700 text-gray-300 hover:bg-gray-600"}
                `,children:i.name}),S.some(u=>u.name===i.name)&&e.jsx(T,{variant:"ghost",size:"sm",className:"absolute right-0 p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity",onClick:u=>{u.stopPropagation(),g(i.name)},children:"✕"})]},i.name))}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-700",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:c("presetSelector.savePresetLabel")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(re,{type:"text",placeholder:c("presetSelector.newPresetNamePlaceholder"),value:p,onChange:i=>h(i.target.value),className:"flex-grow"}),e.jsx(T,{onClick:y,disabled:p.trim()==="",children:c("presetSelector.saveButton")})]})]})]})]})};function Je(){const[s,a]=l.useState(null),[t,r]=l.useState(!1),c=l.useRef(null),{addToast:o}=L(),{t:f}=_(),S=l.useCallback((n,y)=>{const g=new Image;g.onload=()=>{a(g),y&&o(y,"success")},g.onerror=()=>{o(f("imageLoader.loadUrlErrorToast"),"error")},g.src=n},[o,f]),w=l.useCallback(n=>{if(!n)return;if(!n.type.startsWith("image/")){o(f("imageLoader.invalidFileToast"),"error");return}const y=URL.createObjectURL(n);S(y,f("imageLoader.loadedToast"))},[o,S,f]),p=l.useCallback(n=>{var y;w(((y=n.target.files)==null?void 0:y[0])||null),n.target&&(n.target.value="")},[w]);return{sourceImage:s,isDragging:t,fileInputRef:c,handleDragOver:n=>{n.preventDefault(),n.stopPropagation(),r(!0)},handleDragLeave:n=>{n.preventDefault(),n.stopPropagation(),r(!1)},handleDrop:n=>{var y;n.preventDefault(),n.stopPropagation(),r(!1),w(((y=n.dataTransfer.files)==null?void 0:y[0])||null)},handleImageUpload:p,onUploadClick:()=>{var n;return(n=c.current)==null?void 0:n.click()},setSourceImageFromUrl:S}}function Qe(){const[s,a]=l.useState(M),[t,r]=l.useState("Default"),{addToast:c}=L(),{t:o}=_(),f=l.useCallback(p=>{const{name:h,value:j,type:b}=p.target;let n;if(j==="auto")n="auto";else{const y=parseFloat(j);b==="range"||j.trim()!==""&&!isNaN(y)?n=y:n=j}a(y=>{const g={...y},i=h.split(".");if(i.length>1){const u=i[0],k=parseInt(i[1],10),m=g[u];if(typeof n!="number")return console.error(`Invalid value type for tuple property ${u}: Expected number, got ${typeof n}`),g;if(Array.isArray(m)&&(m.length===2||m.length===3)){const x=[...m];x[k]=n,(m.length===2||m.length===3)&&(g[u]=x)}else console.error(`Attempted to update non-tuple or invalid index for property: ${u}`)}else{const u=h;if(u in g)if(u==="num_colors")n==="auto"||typeof n=="number"?g[u]=n:console.error(`Invalid value type for num_colors: ${typeof n}`);else if(typeof n=="number"){const k=typeof g[u];k==="number"?g[u]=n:console.error(`Attempted to assign a single number to a non-number property (${k}): ${u}`)}else console.error(`Invalid value type for property ${u}: ${typeof n}`);else console.error(`Unknown property: ${u}`)}return g}),r("Custom")},[]),S=l.useCallback(()=>{a(M),r("Default"),c(o("stampSettings.resetToast"),"info")},[c,o]),w=l.useCallback(p=>{a({...M,...p.settings}),r(p.name),c(o("stampSettings.loadedPresetToast",{name:p.name}),"info")},[c,o]);return{settings:s,activePreset:t,staticPresets:H,handleSettingChange:f,handleResetSettings:S,handleSelectPreset:w}}const oe=l.createContext(void 0),Xe=({children:s})=>{const{addToast:a}=L(),{t}=_(),{sourceImage:r,isDragging:c,fileInputRef:o,handleImageUpload:f,onUploadClick:S,setSourceImageFromUrl:w,...p}=Je(),{settings:h,activePreset:j,staticPresets:b,handleSettingChange:n,handleResetSettings:y,handleSelectPreset:g}=Qe(),{stamps:i,addStampToGallery:u,deleteStampFromGallery:k,renameStampInGallery:m}=qe(),{user:x,selectedRallyId:F}=ne(),[le,U]=l.useState(!1),[z,$]=l.useState(null),[A,W]=l.useState(null),[J,ie]=l.useState(!1),[ce,de]=l.useState(!1),[me,ue]=l.useState(!0),[q,Q]=l.useState(!1),R=l.useRef(null);l.useEffect(()=>{const d=new Audio("/atsume-page/stamp-sound.mp3");d.load(),R.current=d},[]),l.useEffect(()=>{const d=P=>{P.touches[0]&&"force"in P.touches[0]&&P.touches[0].force>0&&(ie(!0),a(t("stampEditor.pressureToast"),"info")),window.removeEventListener("touchstart",d)};return window.addEventListener("touchstart",d,{once:!0}),()=>window.removeEventListener("touchstart",d)},[a,t]);const G=l.useRef(null),pe=l.useCallback((d,P,I)=>{var D;(D=G.current)==null||D.call(G,d,P,I)},[]),N=Ee({onPlaceRequest:pe,isPlacementDisabled:!r||q}),X=l.useCallback(async(d,P,I)=>{if(!(!r||q)){Q(!0);try{const D=Be(r,h.stamp_size),Y=D.getContext("2d",{willReadFrequently:!0});if(!Y)throw new Error("Could not get context from resized canvas");const je=Y.getImageData(0,0,D.width,D.height),Z={...h},ee=await Me(je,Z),B=await createImageBitmap(ee);if(N.canvasNode){const C=N.canvasNode.getContext("2d");C==null||C.save(),C==null||C.translate(d,P),C==null||C.rotate(I*Math.PI/180),C==null||C.drawImage(B,-B.width/2,-B.height/2),C==null||C.restore()}R.current&&(R.current.currentTime=0,R.current.play().catch(console.warn)),W({imageData:ee,settings:Z}),N.forceCanvasUpdate()}catch(D){console.error("Error generating stamp:",D),a(t("stampEditor.stampingErrorToast"),"error")}finally{Q(!1)}}},[r,h,J,a,t,N.canvasNode,N.forceCanvasUpdate]);l.useEffect(()=>{G.current=X},[X]);const ge=l.useCallback(()=>{if(N.canvasNode){const d=N.canvasNode.getContext("2d");d==null||d.clearRect(0,0,N.canvasNode.width,N.canvasNode.height),N.forceCanvasUpdate(),a(t("stampEditor.canvasClearedToast"),"info")}},[a,N.canvasNode,N.forceCanvasUpdate,t]),xe=l.useCallback(()=>{if(!N.canvasNode){a(t("stampEditor.downloadErrorToast"),"info");return}const d=document.createElement("a");d.download="stamped-creation.png",d.href=N.canvasNode.toDataURL("image/png"),d.click()},[a,N.canvasNode,t]),fe=()=>{if(!A||!r||!x||!F)return;const d=`Stamp #${i.length+1}`;u(r,A.settings,d,F),W(null)},he=d=>{const P={name:d.name,settings:d.settings};g(P),w(d.sourceImageURL,t("stampEditor.loadedStampToast",{name:d.name})),$(d),U(!1)},be=()=>{const d=H.find(P=>P.name==="Default");d&&g(d),$(null),U(!1),a(t("stampEditor.newStampToast"),"info"),S()},ve=d=>{if(x){if((z==null?void 0:z.id)===d){const P=H.find(I=>I.name==="Default");P&&g(P),$(null)}k(d,x.id)}},ye={sourceImage:r,isDragging:c,fileInputRef:o,onUploadClick:S,imageLoaderProps:{handleDragOver:p.handleDragOver,handleDragLeave:p.handleDragLeave,handleDrop:p.handleDrop,handleImageUpload:f},settings:h,activePreset:j,staticPresets:b,handleSettingChange:n,handleResetSettings:y,handleSelectPreset:g,stamps:i,renameStampInGallery:m,isProcessing:q,isPanMode:N.isPanMode,lastGeneratedStamp:A,interactiveCanvas:N,isGalleryOpen:le,setIsGalleryOpen:U,isSettingsOpen:ce,setIsSettingsOpen:de,isToolbarOpen:me,setIsToolbarOpen:ue,supportsForce:J,handleClearCanvas:ge,handleDownloadImage:xe,handleAddToGallery:fe,handleSelectStamp:he,handleCreateNew:be,handleDeleteStamp:ve,selectedGalleryStamp:z,user:x,selectedRallyId:F};return e.jsx(oe.Provider,{value:ye,children:s})},O=()=>{const s=l.useContext(oe);if(s===void 0)throw new Error("useStampEditorContext must be used within a StampEditorProvider");return s};function Ye({isOpen:s,onClose:a}){const{t}=_(),{settings:r,sourceImage:c,isProcessing:o,staticPresets:f,activePreset:S,handleSettingChange:w,onUploadClick:p,handleResetSettings:h,handleSelectPreset:j,handleClearCanvas:b,handleDownloadImage:n,lastGeneratedStamp:y,handleAddToGallery:g,selectedRallyId:i}=O(),u=!y||o||!i,k=t(i?"rightSidebar.addToGalleryTooltip":"rightSidebar.selectRallyToAddStamp");return e.jsx("aside",{className:`fixed top-0 right-0 h-full bg-gray-800 flex-shrink-0 transition-transform duration-300 ease-in-out z-40 w-full max-w-sm border-l-2 border-gray-700 shadow-2xl ${s?"translate-x-0":"translate-x-full"}`,"aria-hidden":!s,children:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0",children:[e.jsx("h1",{className:"text-xl font-bold",children:t("rightSidebar.title")}),e.jsx(T,{variant:"ghost",size:"icon",onClick:a,className:"rounded-full","aria-label":t("rightSidebar.close"),children:e.jsx(se,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-grow overflow-y-auto p-4 no-scrollbar",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-col gap-3 bg-gray-900/50 p-4 rounded-xl border border-gray-700",children:[e.jsx("h2",{className:"text-lg font-semibold text-white",children:t("rightSidebar.canvasControls")}),e.jsxs(T,{onClick:p,className:"w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-2.5 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2",children:[e.jsx(we,{className:"w-5 h-5"}),t(c?"rightSidebar.changeImage":"rightSidebar.uploadImage")]}),e.jsxs(T,{onClick:g,disabled:u,className:"w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:text-gray-400 disabled:cursor-not-allowed text-white font-medium py-2.5 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2",title:k,children:[e.jsx(Se,{className:"w-5 h-5"}),t("rightSidebar.addToGallery")]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(T,{onClick:b,disabled:o,variant:"destructive",className:"w-full disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-medium py-2.5 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2",children:[e.jsx(ae,{className:"w-4 h-4"})," ",t("rightSidebar.clear")]}),e.jsxs(T,{onClick:n,disabled:o,className:"w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-medium py-2.5 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4"})," ",t("rightSidebar.download")]})]})]}),e.jsx(We,{staticPresets:f,activePreset:S,currentSettings:r,onSelectPreset:j}),e.jsxs(T,{onClick:()=>h(),disabled:o,className:"w-full bg-gray-700 hover:bg-gray-600 disabled:bg-gray-600 disabled:cursor-not-allowed text-gray-300 font-medium py-3 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center gap-2",children:[e.jsx(Ce,{className:"w-4 h-4"}),t("rightSidebar.resetParameters")]}),e.jsx(He,{settings:r,handleSettingChange:w})]})})]})})}const Ze=({isOpen:s,onClose:a})=>{const{stamps:t,selectedGalleryStamp:r,handleSelectStamp:c,handleDeleteStamp:o,renameStampInGallery:f,handleCreateNew:S,user:w}=O(),[p,h]=l.useState(null),[j,b]=l.useState(null),[n,y]=l.useState(""),g=l.useRef(null),{t:i}=_(),u=(m,x)=>{x.stopPropagation(),h(null),b(m.id),y(m.name)},k=()=>{if(j&&n.trim()){const m=t.find(x=>x.id===j);m&&m.name!==n.trim()&&w&&f(j,n.trim(),w.id)}b(null)};return l.useEffect(()=>{j&&g.current&&(g.current.focus(),g.current.select())},[j]),l.useEffect(()=>{s&&(h(null),b(null))},[s]),e.jsx("aside",{className:`fixed top-0 left-0 h-full bg-gray-800 flex-shrink-0 transition-transform duration-300 ease-in-out z-40 w-full max-w-sm border-r-2 border-gray-700 shadow-2xl ${s?"translate-x-0":"-translate-x-full"}`,"aria-hidden":!s,children:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0",children:[e.jsx("h1",{className:"text-xl font-bold",children:i("stampGallery.title")}),e.jsx("button",{onClick:a,className:"p-2 rounded-full hover:bg-gray-700","aria-label":i("stampGallery.close"),children:e.jsx(se,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-grow overflow-y-auto p-4 no-scrollbar",children:[e.jsxs("button",{onClick:S,className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center gap-2 mb-4",children:[e.jsx(te,{className:"w-5 h-5"}),i("stampGallery.createNew")]}),t.length===0?e.jsxs("div",{className:"text-center text-gray-400 mt-8",children:[e.jsx("p",{children:i("stampGallery.empty")}),e.jsx("p",{className:"text-sm mt-1",children:i("stampGallery.emptySubtext")})]}):e.jsx("div",{className:"grid grid-cols-2 gap-4",children:t.map(m=>e.jsxs("div",{className:"relative group",children:[e.jsxs("button",{onClick:()=>{p!==m.id&&j!==m.id&&c(m)},className:`w-full aspect-square rounded-lg overflow-hidden transition-all duration-200 focus:outline-none ring-offset-2 ring-offset-gray-800 focus:ring-2 ${(r==null?void 0:r.id)===m.id&&!j?"ring-2 ring-blue-500":"ring-1 ring-gray-700 hover:ring-blue-500"}`,children:[e.jsx("img",{src:m.thumbnail,alt:m.name,className:"w-full h-full object-contain bg-gray-900/50 p-1"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs text-center p-1 truncate",children:j===m.id?e.jsx("input",{ref:g,type:"text",value:n,className:"w-full bg-gray-900 text-white text-center text-xs p-0 border-none outline-none ring-1 ring-blue-500 rounded-sm",onChange:x=>y(x.target.value),onBlur:k,onKeyDown:x=>{x.key==="Enter"&&k(),x.key==="Escape"&&b(null)},onClick:x=>x.stopPropagation()}):m.name})]}),e.jsx("div",{className:"absolute top-1 right-1 z-10",children:p===m.id?e.jsxs("div",{className:"flex items-center gap-1.5 p-1 bg-gray-900/80 rounded-lg backdrop-blur-sm",children:[e.jsx("button",{onClick:x=>{x.stopPropagation(),o(m.id),h(null)},className:"text-xs font-bold text-red-400 hover:text-red-300 px-1","aria-label":i("stampGallery.confirmDelete",{name:m.name}),children:i("common.confirm")}),e.jsx("button",{onClick:x=>{x.stopPropagation(),h(null)},className:"text-xs text-gray-300 hover:text-white px-1","aria-label":i("stampGallery.cancelDelete"),children:i("common.cancel")})]}):j!==m.id?e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:x=>u(m,x),className:"bg-blue-600/80 text-white p-1 rounded-full hover:bg-blue-500","aria-label":i("stampGallery.rename",{name:m.name}),children:e.jsx(te,{className:"w-3 h-3"})}),e.jsx("button",{onClick:x=>{x.stopPropagation(),b(null),h(m.id)},className:"bg-red-600/80 text-white p-1 rounded-full hover:bg-red-500","aria-label":i("common.delete"),children:e.jsx(ae,{className:"w-3 h-3"})})]}):null})]},m.id))})]})]})})},et=({isOpen:s,onClose:a})=>{const{t}=_(),{settings:r,handleSettingChange:c,supportsForce:o,sourceImage:f,isProcessing:S,selectedRallyId:w}=O(),p=!f||S,h=p||!w;return e.jsx("div",{className:`absolute bottom-4 left-1/2 -translate-x-1/2 z-20 w-11/12 max-w-lg transition-all duration-300 ease-in-out ${s?"opacity-100 translate-y-0":"opacity-0 translate-y-full pointer-events-none"}`,"aria-label":t("stampToolbar.title"),"aria-hidden":!s,children:e.jsx("div",{className:`transition-opacity duration-300 ${h?"opacity-70":"opacity-100"}`,children:e.jsxs("div",{className:"relative flex flex-col sm:flex-row items-center justify-center gap-4 rounded-xl bg-gray-900/90 backdrop-blur-sm p-3 shadow-lg ring-1 ring-white/10",children:[e.jsx("button",{onClick:a,"aria-label":t("stampToolbar.hide"),className:"absolute top-1 right-1 z-10 p-1 text-gray-400 rounded-full hover:bg-white/10 hover:text-white transition-colors",children:e.jsx(Pe,{className:"w-5 h-5"})}),e.jsx("div",{className:"w-full sm:w-48",children:e.jsx(v,{label:t("stampToolbar.size"),name:"stamp_size",value:r.stamp_size,min:500,max:1500,step:1,unit:"px",onChange:c,tooltip:t("stampToolbar.sizeTooltip"),disabled:p})}),!o&&e.jsx("div",{className:"w-full sm:w-48",children:e.jsx(v,{label:t("stampToolbar.intensity"),name:"splat_density",value:r.splat_density,min:.1,max:2,step:.05,onChange:c,tooltip:t("stampToolbar.intensityTooltip"),disabled:p})}),o&&e.jsx("div",{className:"text-center text-sm text-gray-300 p-2 whitespace-nowrap",children:t("stampToolbar.pressureMessage")})]})})})},tt=()=>{const{imageLoaderProps:s,fileInputRef:a,interactiveCanvas:t,isGalleryOpen:r,setIsGalleryOpen:c,isSettingsOpen:o,setIsSettingsOpen:f,isToolbarOpen:S,setIsToolbarOpen:w,isProcessing:p,isPanMode:h,sourceImage:j}=O(),{t:b}=_(),n=h?"cursor-grab":j?"cursor-crosshair":"cursor-default";return e.jsxs("div",{className:"relative w-full h-full bg-gray-700",onDragOver:s.handleDragOver,onDragLeave:s.handleDragLeave,onDrop:s.handleDrop,children:[e.jsx("input",{type:"file",ref:a,accept:"image/*",onChange:s.handleImageUpload,className:"hidden","aria-hidden":"true"}),e.jsx(ze,{canvasRef:t.canvasRef,containerRef:t.containerRef,canvasNode:t.canvasNode,containerProps:t.containerProps,viewTransform:t.viewTransform,viewTransformRef:t.viewTransformRef,viewportSize:t.viewportSize,isPanning:t.isPanning,isPanMode:h,stampPreview:t.stampPreview,cursorClass:n,ariaLabel:b("stampEditor.stampingArea")}),e.jsx(Ze,{isOpen:r,onClose:()=>c(!1)}),e.jsx(et,{isOpen:S,onClose:()=>w(!1)}),e.jsx(Ye,{isOpen:o,onClose:()=>f(!1)}),p&&e.jsxs("div",{className:"absolute inset-0 bg-black/60 flex items-center justify-center text-white text-lg z-50 pointer-events-none","aria-live":"polite",children:[e.jsx(ke,{className:"w-6 h-6 mr-3 animate-pulse"}),b("stampEditor.generatingToast")]}),e.jsxs(e.Fragment,{children:[!r&&e.jsx("button",{onClick:()=>c(!0),className:"fixed top-1/2 -translate-y-1/2 left-0 z-30 py-4 px-1 bg-gray-900/70 hover:bg-gray-800/90 backdrop-blur-sm rounded-r-lg shadow-lg transition-colors","aria-label":b("stampEditor.galleryToggle"),title:b("stampEditor.galleryToggle"),children:e.jsx(Te,{className:"w-5 h-5"})}),!o&&e.jsx("button",{onClick:()=>f(!0),className:"fixed top-1/2 -translate-y-1/2 right-0 z-30 py-4 px-1 bg-gray-900/70 hover:bg-gray-800/90 backdrop-blur-sm rounded-l-lg shadow-lg transition-colors","aria-label":b("stampEditor.settingsToggle"),title:b("stampEditor.settingsToggle"),children:e.jsx(_e,{className:"w-5 h-5"})}),!S&&e.jsx("button",{onClick:()=>w(!0),className:"fixed bottom-0 left-1/2 -translate-x-1/2 z-30 p-1 px-4 bg-gray-900/70 hover:bg-gray-800/90 backdrop-blur-sm rounded-t-lg shadow-lg transition-colors","aria-label":b("stampEditor.toolbarToggle"),title:b("stampEditor.toolbarToggle"),children:e.jsx(De,{className:"w-5 h-5"})}),h&&e.jsxs("div",{className:"fixed bottom-20 left-1/2 -translate-x-1/2 z-30 bg-gray-900/80 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2 pointer-events-none",children:[e.jsx(Ie,{className:"w-4 h-4"})," ",b("stampEditor.panMode")]})]})]})};function it(){return e.jsx(Xe,{children:e.jsx(tt,{})})}export{it as default};
