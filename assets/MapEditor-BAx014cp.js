import{r as n,j as e,X as C,i as K,k as Q,l as O,m as V,n as _,o as Y,A as Z,p as ee,q as z,s as te,P as ae,t as le,u as se,v as oe,w as ne}from"./react-vendor-BpF3ZOKC.js";import{u as w,a as re}from"./index-BQP-UfdX.js";import{u as ie,c as de,B as ce}from"./BaseMap-KMQMtKEe.js";import{u as R}from"./useGallery-D_sL6_Kp.js";import{S as ue}from"./SliderControl-B5_7fqb_.js";import me from"./BatchUploadModal-CNsAMeDt.js";import"./vendor-CFJUWez9.js";import"./maplibre-gl-vendor-Csyg3Y42.js";import"./supabase-vendor-DfscHDRx.js";import"./stamp-D6e6GvNL.js";import"./presets-CtbnJzjA.js";const xe=({initialData:d,onSave:c,onClose:a})=>{const[l,p]=n.useState(d.name||""),[u,h]=n.useState(d.description||""),[s,m]=n.useState(d.radius||100),[b,j]=n.useState(d.stamp_id||null),{stamps:r,loading:g}=R(),{t:o}=w(),y=()=>{if(!l.trim()){alert(o("locationEditModal.validationError"));return}c({name:l,description:u,radius:s,latitude:d.latitude,longitude:d.longitude,stamp_id:b})};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm animate-fade-in","aria-modal":"true",role:"dialog",onClick:a,children:e.jsxs("div",{className:"relative w-full max-w-lg m-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-white transform animate-scale-in flex flex-col gap-6",onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:d.id?o("locationEditModal.titleEdit"):o("locationEditModal.titleAdd")}),e.jsx("button",{onClick:a,className:"p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors","aria-label":o("common.close"),children:e.jsx(C,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("input",{type:"text",placeholder:o("locationEditModal.namePlaceholder"),value:l,onChange:i=>p(i.target.value),className:"w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition"}),e.jsx("textarea",{placeholder:`${o("common.description")} (${o("common.optional")})`,value:u||"",onChange:i=>h(i.target.value),rows:3,className:"w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition resize-none"}),e.jsx(ue,{label:o("locationEditModal.radius"),name:"radius",value:s,min:10,max:1e3,step:10,unit:"m",onChange:i=>m(parseInt(i.target.value,10)),tooltip:o("locationEditModal.radiusTooltip")})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:o("locationEditModal.assignStamp")}),e.jsx("div",{className:"h-48 bg-gray-900/50 rounded-lg p-3 overflow-y-auto no-scrollbar border border-gray-700",children:g?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-400",children:o("locationEditModal.loadingStamps")}):e.jsxs("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-3",children:[e.jsxs("button",{onClick:()=>j(null),className:`w-full aspect-square rounded-lg flex flex-col items-center justify-center text-gray-400 transition-all duration-200 focus:outline-none ring-offset-2 ring-offset-gray-800 focus:ring-2 ${b===null?"ring-2 ring-blue-500 bg-blue-500/10":"ring-1 ring-gray-600 hover:ring-blue-500 bg-gray-700"}`,children:[e.jsx(K,{className:"w-8 h-8"}),e.jsx("span",{className:"text-xs mt-1",children:o("locationEditModal.noStamp")})]}),r.map(i=>e.jsx("button",{onClick:()=>j(i.id),className:`w-full aspect-square rounded-lg overflow-hidden transition-all duration-200 focus:outline-none ring-offset-2 ring-offset-gray-800 focus:ring-2 ${b===i.id?"ring-2 ring-blue-500":"ring-1 ring-gray-700 hover:ring-blue-500"}`,children:e.jsx("img",{src:i.thumbnail,alt:i.name,className:"w-full h-full object-contain bg-gray-900/50"})},i.id))]})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:a,className:"w-full bg-gray-600 hover:bg-gray-500 font-medium py-3 px-4 rounded-lg transition-colors",children:o("common.cancel")}),e.jsxs("button",{onClick:y,className:"w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),o("common.save")]})]})]})})},ge=({onSelect:d})=>{const{t:c}=w(),a=[{method:"map",icon:O,label:c("mapEditor.placeOnMap")},{method:"coords",icon:V,label:c("mapEditor.byCoordinates")},{method:"osm",icon:_,label:c("mapEditor.fromOSM")},{method:"batch",icon:Y,label:c("mapEditor.batchUpload")}];return e.jsx("div",{className:"flex flex-col items-stretch gap-1 bg-gray-900/80 backdrop-blur-sm p-2 rounded-xl shadow-lg w-48",children:a.map((l,p)=>e.jsxs("button",{onClick:()=>d(l.method),className:"flex items-center gap-3 w-full text-left p-2 rounded-lg text-white hover:bg-blue-600 transition-colors animate-fade-in",style:{animationDelay:`${p*50}ms`},title:l.label,children:[e.jsx(l.icon,{className:"w-5 h-5 flex-shrink-0"}),e.jsx("span",{className:"text-sm font-medium",children:l.label})]},l.method))})},pe=({onSave:d,onClose:c})=>{const{t:a}=w(),[l,p]=n.useState(""),[u,h]=n.useState(""),[s,m]=n.useState({}),b=()=>{const r={},g=parseFloat(l),o=parseFloat(u);return l?(isNaN(g)||g<-90||g>90)&&(r.lat=a("coordInputModal.validation.latInvalid")):r.lat=a("coordInputModal.validation.latRequired"),u?(isNaN(o)||o<-180||o>180)&&(r.lon=a("coordInputModal.validation.lonInvalid")):r.lon=a("coordInputModal.validation.lonRequired"),m(r),Object.keys(r).length===0},j=r=>{r.preventDefault(),b()&&d({latitude:parseFloat(l),longitude:parseFloat(u)})};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm animate-fade-in","aria-modal":"true",role:"dialog",onClick:c,children:e.jsxs("div",{className:"relative w-full max-w-md m-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-white transform animate-scale-in flex flex-col gap-6",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:a("coordInputModal.title")}),e.jsx("button",{onClick:c,className:"p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors","aria-label":a("common.close"),children:e.jsx(C,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:j,className:"flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"latitude",className:"block text-sm font-medium text-gray-300 mb-1",children:a("coordInputModal.latitude")}),e.jsx("input",{id:"latitude",type:"number",step:"any",placeholder:a("coordInputModal.latitudePlaceholder"),value:l,onChange:r=>p(r.target.value),className:`w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border ${s.lat?"border-red-500":"border-gray-600"} focus:ring-2 focus:ring-blue-500 focus:outline-none transition`}),s.lat&&e.jsx("p",{className:"text-red-400 text-xs mt-1",children:s.lat})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"longitude",className:"block text-sm font-medium text-gray-300 mb-1",children:a("coordInputModal.longitude")}),e.jsx("input",{id:"longitude",type:"number",step:"any",placeholder:a("coordInputModal.longitudePlaceholder"),value:u,onChange:r=>h(r.target.value),className:`w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border ${s.lon?"border-red-500":"border-gray-600"} focus:ring-2 focus:ring-blue-500 focus:outline-none transition`}),s.lon&&e.jsx("p",{className:"text-red-400 text-xs mt-1",children:s.lon})]}),e.jsxs("div",{className:"flex gap-4 pt-2",children:[e.jsx("button",{type:"button",onClick:c,className:"w-full bg-gray-600 hover:bg-gray-500 font-medium py-3 px-4 rounded-lg transition-colors",children:a("common.cancel")}),e.jsxs("button",{type:"submit",className:"w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2",children:[a("coordInputModal.next"),e.jsx(Z,{className:"w-5 h-5"})]})]})]})]})})},fe=({onImport:d,onClose:c})=>{const{t:a}=w(),[l,p]=n.useState(""),[u,h]=n.useState(!1),[s,m]=n.useState(null),b=async()=>{if(m(null),!/^([NWR]\d+|\d+)$/i.test(l)){m("invalidId");return}h(!0);let o=l;/^\d+$/.test(l)&&(o=`N${l}`);try{const y=await fetch(`https://nominatim.openstreetmap.org/lookup?osm_ids=${o.toUpperCase()}&format=json`);if(!y.ok)throw new Error("Network response was not ok");const i=await y.json();i&&i.length>0?d({latitude:parseFloat(i[0].lat),longitude:parseFloat(i[0].lon)}):m("notFound")}catch(y){console.error("OSM Import Error:",y),m("network")}finally{h(!1)}},j=g=>{g.preventDefault(),b()},r={invalidId:a("osmImportModal.error.invalidId"),notFound:a("osmImportModal.error.notFound"),network:a("osmImportModal.error.network")};return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-gray-900/80 backdrop-blur-sm animate-fade-in","aria-modal":"true",role:"dialog",onClick:c,children:e.jsxs("div",{className:"relative w-full max-w-md m-4 bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-white transform animate-scale-in flex flex-col gap-6",onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:a("osmImportModal.title")}),e.jsx("button",{onClick:c,className:"p-2 text-gray-400 rounded-full hover:bg-gray-700 hover:text-white transition-colors","aria-label":a("common.close"),children:e.jsx(C,{className:"w-6 h-6"})})]}),e.jsxs("form",{onSubmit:j,className:"flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"osmId",className:"block text-sm font-medium text-gray-300 mb-1",children:a("osmImportModal.idLabel")}),e.jsx("input",{id:"osmId",type:"text",placeholder:a("osmImportModal.idPlaceholder"),value:l,onChange:g=>p(g.target.value),className:`w-full bg-gray-900 text-white placeholder-gray-500 px-4 py-2.5 rounded-lg border ${s?"border-red-500":"border-gray-600"} focus:ring-2 focus:ring-blue-500 focus:outline-none transition`}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:a("osmImportModal.helpText")})]}),s&&e.jsx("p",{className:"text-red-400 text-xs mt-1",children:r[s]}),e.jsxs("div",{className:"flex gap-4 pt-2",children:[e.jsx("button",{type:"button",onClick:c,className:"w-full bg-gray-600 hover:bg-gray-500 font-medium py-3 px-4 rounded-lg transition-colors",children:a("common.cancel")}),e.jsx("button",{type:"submit",disabled:u||!l,className:"w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:bg-gray-600 disabled:cursor-not-allowed",children:u?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),a("osmImportModal.importing")]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-5 h-5"}),a("osmImportModal.import")]})})]})]})]})})},he=({isOpen:d,onClose:c,locations:a,selectedLocationId:l,onSelectLocation:p})=>{const{t:u}=w(),h=s=>{p(s),c()};return e.jsx("aside",{className:`fixed top-0 left-0 h-full bg-gray-800 flex-shrink-0 transition-transform duration-300 ease-in-out z-40 w-full max-w-sm border-r-2 border-gray-700 shadow-2xl ${d?"translate-x-0":"-translate-x-full"}`,"aria-hidden":!d,children:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0",children:[e.jsx("h1",{className:"text-xl font-bold",children:u("locationList.title")}),e.jsx("button",{onClick:c,className:"p-2 rounded-full hover:bg-gray-700","aria-label":u("common.close"),children:e.jsx(C,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-grow overflow-y-auto p-2 no-scrollbar",children:a.length===0?e.jsxs("div",{className:"text-center text-gray-400 mt-8 px-4",children:[e.jsx("p",{children:u("locationList.empty")}),e.jsx("p",{className:"text-sm mt-1",children:u("locationList.emptySubtext")})]}):e.jsx("ul",{className:"flex flex-col gap-2",children:a.map(s=>e.jsx("li",{children:e.jsxs("button",{onClick:()=>h(s),className:`w-full flex items-center gap-3 text-left p-2 rounded-lg transition-colors duration-200 ${l===s.id?"bg-blue-600 text-white":"text-gray-200 hover:bg-gray-700"}`,"aria-label":u("locationList.selectLocation",{name:s.name}),"aria-current":l===s.id,children:[e.jsx("div",{className:"w-10 h-10 flex-shrink-0 bg-gray-900/50 rounded-md flex items-center justify-center",children:s.stamp?e.jsx("img",{src:s.stamp.thumbnail,alt:s.stamp.name,className:"w-full h-full object-contain"}):e.jsx(O,{className:"w-6 h-6 text-gray-500"})}),e.jsx("span",{className:"flex-grow font-medium truncate",children:s.name})]})},s.id))})})]})})},Le=({editingRallyId:d,isVisible:c})=>{const{addToast:a}=re(),{geolocations:l,addGeolocation:p,updateGeolocation:u,deleteGeolocation:h}=ie(d),{stamps:s}=R(),{t:m}=w(),[b,j]=n.useState(!1),[r,g]=n.useState(!1),[o,y]=n.useState(!1),[i,L]=n.useState(!1),[F,P]=n.useState(!1),[$,T]=n.useState(!0),[x,N]=n.useState(null),[M,S]=n.useState(null),[I,v]=n.useState(null),k=n.useRef(null),A=n.useMemo(()=>l.map(t=>({...t,stamp:s.find(f=>f.id===t.stamp_id)||null})).sort((t,f)=>t.created_at&&f.created_at?new Date(f.created_at).getTime()-new Date(t.created_at).getTime():0),[l,s]),G=n.useMemo(()=>({type:"FeatureCollection",features:l.map(t=>{const f=de([t.longitude,t.latitude],t.radius);return f.properties={id:t.id},f})}),[l]),U=t=>{if(b){const{lng:f,lat:H}=t.lngLat;v({latitude:H,longitude:f}),j(!1)}x&&N(null)},q=t=>{M?u(M.id,t):p(t),S(null),v(null)},B=t=>{window.confirm(m("mapEditor.deleteConfirm"))&&(h(t),N(null))},E=n.useMemo(()=>x!=null&&x.stamp_id&&s.find(t=>t.id===x.stamp_id)||null,[x,s]),D=t=>{switch(g(!1),t){case"map":j(!0),a(m("mapEditor.addLocationToast"),"info");break;case"coords":y(!0);break;case"osm":L(!0);break;case"batch":P(!0);break}},W=t=>{y(!1),v(t)},J=t=>{L(!1),v(t),k.current&&k.current.flyTo({center:[t.longitude,t.latitude],zoom:15})},X=t=>{k.current&&k.current.flyTo({center:[t.longitude,t.latitude],zoom:15,speed:1.2}),N(t)};return n.useEffect(()=>{I&&S(null)},[I]),e.jsxs(e.Fragment,{children:[e.jsx(he,{isOpen:$,onClose:()=>T(!1),locations:A,selectedLocationId:(x==null?void 0:x.id)||null,onSelectLocation:X}),e.jsxs(ce,{isVisible:c,onMapClick:U,cursor:b?"cursor-add":"",mapRef:k,children:[e.jsxs(ee,{id:"radius-circles",type:"geojson",data:G,children:[e.jsx(z,{id:"radius-circles-fill",type:"fill",paint:{"fill-color":"#ef4444","fill-opacity":.25}}),e.jsx(z,{id:"radius-circles-stroke",type:"line",paint:{"line-color":"#ef4444","line-width":1.5,"line-dasharray":[2,2]}})]}),l.map(t=>e.jsx(te,{longitude:t.longitude,latitude:t.latitude,style:{zIndex:10},children:e.jsx("button",{onClick:f=>{f.stopPropagation(),N(t)},"aria-label":m("mapEditor.viewLocation",{name:t.name}),children:e.jsx(O,{className:"text-red-500 w-8 h-8 drop-shadow-lg",strokeWidth:1.5})})},t.id)),x&&e.jsx(ae,{longitude:x.longitude,latitude:x.latitude,onClose:()=>N(null),closeOnClick:!1,anchor:"bottom",offset:35,children:e.jsxs("div",{className:"flex flex-col",children:[E&&e.jsx("img",{src:E.thumbnail,alt:E.name,className:"w-full h-32 object-contain bg-gray-900/50 rounded-t-md"}),e.jsxs("div",{className:"p-3",children:[e.jsx("h3",{className:"font-bold text-lg text-white mb-1",children:x.name}),e.jsx("p",{className:"text-sm text-gray-300 mb-3",children:x.description}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>{S(x),N(null)},className:"flex-1 bg-blue-600 text-white px-2 py-1.5 text-xs rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-1.5",children:[e.jsx(le,{className:"w-3 h-3"})," ",m("common.edit")]}),e.jsxs("button",{onClick:()=>B(x.id),className:"flex-1 bg-red-600 text-white px-2 py-1.5 text-xs rounded-md hover:bg-red-700 transition-colors flex items-center justify-center gap-1.5",children:[e.jsx(se,{className:"w-3 h-3"})," ",m("common.delete")]})]})]})]})})]}),!$&&e.jsx("button",{onClick:()=>T(!0),className:"fixed top-1/2 -translate-y-1/2 left-0 z-30 py-4 px-1 bg-gray-900/70 hover:bg-gray-800/90 backdrop-blur-sm rounded-r-lg shadow-lg transition-colors","aria-label":m("locationList.toggle"),title:m("locationList.toggle"),children:e.jsx(oe,{className:"w-5 h-5 text-white"})}),e.jsx("div",{className:"absolute bottom-6 right-6 z-10",children:e.jsxs("div",{className:"relative",children:[r&&e.jsx("div",{className:"absolute bottom-full right-0 mb-3",children:e.jsx(ge,{onSelect:D})}),e.jsx("button",{onClick:()=>{g(t=>!t),j(!1)},className:"bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-transform hover:scale-110","aria-label":m("mapEditor.addLocation"),"aria-expanded":r,children:e.jsx(ne,{className:`w-6 h-6 transition-transform duration-300 ${r?"rotate-45":""}`})})]})}),(M||I)&&!o&&!i&&e.jsx(xe,{initialData:M||I,onSave:q,onClose:()=>{S(null),v(null)}}),o&&e.jsx(pe,{onSave:W,onClose:()=>y(!1)}),i&&e.jsx(fe,{onImport:J,onClose:()=>L(!1)}),F&&e.jsx(me,{isOpen:F,onClose:()=>P(!1),rallyId:d})]})};export{Le as default};
