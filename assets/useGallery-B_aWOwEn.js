var q=Object.defineProperty;var L=(o,t,e)=>t in o?q(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var S=(o,t,e)=>L(o,typeof t!="symbol"?t+"":t,e);import{r as k}from"./react-vendor-B6On5FFh.js";import{b as P,a as H,u as N,j as v,k as W,l as $,m as U}from"./index-CASFG7ec.js";const z=(o=0,t=1)=>{const e=Math.random(),n=Math.random();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*n)*t+o};class _{constructor(t,e,n){S(this,"data");S(this,"width");S(this,"height");this.width=e,this.height=t;const r=e*t;if(n instanceof Float32Array){if(n.length!==r)throw new Error("Data array does not match matrix dimensions");this.data=n}else this.data=new Float32Array(r),typeof n=="number"&&this.data.fill(n)}static ones(t,e){return new _(t,e,1)}static zeros(t,e){return new _(t,e,0)}get(t,e){return t<0||t>=this.height||e<0||e>=this.width?0:this.data[t*this.width+e]}set(t,e,n){t>=0&&t<this.height&&e>=0&&e<this.width&&(this.data[t*this.width+e]=n)}clone(){return new _(this.height,this.width,new Float32Array(this.data))}getBilinear(t,e){const n=Math.floor(t),r=Math.floor(e),a=Math.ceil(t),s=Math.ceil(e);if(n<0||a>=this.height||r<0||s>=this.width)return 0;const h=this.get(n,r),f=this.get(n,s),c=this.get(a,r),i=this.get(a,s),u=t-n,l=e-r,d=h*(1-l)+f*l,m=c*(1-l)+i*l;return d*(1-u)+m*u}}function F(o,t){const e=_.zeros(o.height,o.width);for(let n=0;n<o.data.length;n++)e.data[n]=o.data[n]*t.data[n];return e}function j(o,t,e,n,r){const a=_.zeros(o.height,o.width);for(let s=0;s<o.data.length;s++)a.data[s]=o.data[s]*t+e.data[s]*n+r;return a}function C(o){const t=o.clone();let e=1/0,n=-1/0;for(let a=0;a<t.data.length;a++)t.data[a]<e&&(e=t.data[a]),t.data[a]>n&&(n=t.data[a]);const r=n-e;if(r>0)for(let a=0;a<t.data.length;a++)t.data[a]=(t.data[a]-e)/r;return t}function O(o){let t=0;for(let e=0;e<o.data.length;e++)o.data[e]!==0&&t++;return t}const E=240,X=10,B=1;function G(o,t){const e=[];for(let n=0;n<o.length;n+=3){const r=o[n],a=o[n+1],s=o[n+2],h=(r+a+s)/3,f=r>E&&a>E&&s>E;h>t&&!f&&e.push(r,a,s)}return new Float32Array(e)}function x(o,t){return Math.sqrt((o[0]-t[0])**2+(o[1]-t[1])**2+(o[2]-t[2])**2)}function K(o,t){if(o.length===0||t===0)return{colors:[],labels:new Int32Array(0)};const e=o.length/3,n=[];for(let f=0;f<o.length;f+=3)n.push([o[f],o[f+1],o[f+2]]);e<t&&(t=e);let r=[];const a=new Set;for(;r.length<t;){const f=Math.floor(Math.random()*e);a.has(f)||(r.push([...n[f]]),a.add(f))}const s=new Int32Array(e);for(let f=0;f<X;f++){for(let l=0;l<e;l++){let d=1/0,m=0;for(let p=0;p<r.length;p++){const y=x(n[l],r[p]);y<d&&(d=y,m=p)}s[l]=m}const c=Array(r.length).fill(0).map(()=>[0,0,0]),i=new Array(r.length).fill(0);for(let l=0;l<e;l++){const d=s[l];c[d][0]+=n[l][0],c[d][1]+=n[l][1],c[d][2]+=n[l][2],i[d]++}let u=!0;for(let l=0;l<r.length;l++){if(i[l]>0)c[l][0]/=i[l],c[l][1]/=i[l],c[l][2]/=i[l];else{const d=Math.floor(Math.random()*e);c[l]=[...n[d]]}x(c[l],r[l])>B&&(u=!1)}if(r=c,u)break}return{colors:r.map(f=>f.map(Math.round)),labels:s}}function Y(o,t){const e=_.zeros(o.height,o.width),n=Math.floor(t/2);for(let r=0;r<o.height;r++)for(let a=0;a<o.width;a++){let s=255;for(let h=-n;h<=n;h++)for(let f=-n;f<=n;f++)s=Math.min(s,o.get(r+h,a+f));e.set(r,a,s)}return e}function V(o,t,e,n,r,a){const s=new Array(n*r).fill(-1);let h=0;for(let c=0;c<o.length;c+=3){const i=o[c],u=o[c+1],l=o[c+2],d=(i+u+l)/3,m=i>E&&u>E&&l>E;d>a.background_threshold&&!m&&(s[c/3]=e[h],h++)}const f=[];for(let c=0;c<t.length;c++){const i=new Float32Array(n*r);for(let l=0;l<s.length;l++)i[l]=s[l]===c?255:0;let u=new _(r,n,i);a.color_shape_shrink>0&&(u=Y(u,a.color_shape_shrink)),f.push(u)}return f}function Z(o,t,e){const n=t*Math.PI/180,r=e*Math.cos(n),a=e*Math.sin(n);return[r,a,(1-r)*o.x-a*o.y,-a,r,a*o.x+(1-r)*o.y]}function J(o,t,e,n){const r=_.zeros(n,e),[a,s,h,f,c,i]=t,u=a*c-s*f;if(Math.abs(u)<1e-6)return r;const l=1/u,d=c*l,m=-s*l,p=(s*i-c*h)*l,y=-f*l,A=a*l,b=(f*h-a*i)*l;for(let w=0;w<n;w++)for(let I=0;I<e;I++){const g=d*I+m*w+p,M=y*I+A*w+b,T=o.getBilinear(M,g);r.set(w,I,T)}return r}function Q(o,t,e,n,r){return o.map(a=>{const s=z(...n),h=z(...n),f=z(...r),c=Z({x:t/2,y:e/2},f,1);return c[2]+=s,c[5]+=h,J(a,c,t,e)})}function R(o){var f;const t=o.length,e=((f=o[0])==null?void 0:f.length)||0,n=Array(t).fill(null).map(()=>Array(e));for(let c=0;c<t;c++)for(let i=0;i<e;i++)n[c][i]=o[c][i]>127;const r=Array(t).fill(null).map(()=>Array(e));for(let c=0;c<t;c++)tt(n[c],r[c]);const a=Array(t).fill(null).map(()=>Array(e)),s=Array(t),h=Array(t);for(let c=0;c<e;c++){for(let i=0;i<t;i++)s[i]=r[i][c];et(s,h);for(let i=0;i<t;i++)a[i][c]=Math.sqrt(h[i])}return a}function tt(o,t){const e=o.length;let n=1/0;for(let r=0;r<e;r++)o[r]?n++:n=0,t[r]=n*n;n=1/0;for(let r=e-1;r>=0;r--)o[r]?n++:n=0,t[r]=Math.min(t[r],n*n)}function et(o,t){const e=o.length;if(e===0)return;const n=Array(e),r=Array(e+1);let a=0;n[0]=0,r[0]=-1/0,r[1]=1/0;for(let s=1;s<e;s++){let h=(o[s]+s*s-(o[n[a]]+n[a]*n[a]))/(2*s-2*n[a]);for(;h<=r[a];)a--,h=(o[s]+s*s-(o[n[a]]+n[a]*n[a]))/(2*s-2*n[a]);a++,n[a]=s,r[a]=h,r[a+1]=1/0}a=0;for(let s=0;s<e;s++){for(;r[a+1]<s;)a++;t[s]=(s-n[a])*(s-n[a])+o[n[a]]}}function nt(o,t,e){const n=Array(e).fill(null).map(()=>Array(t));for(let r=0;r<e;r++)for(let a=0;a<t;a++)n[r][a]=o.get(r,a);return R(n)}function ot(o,t,e,n,r){return o.map(a=>{const s=Array(e).fill(0).map(()=>Array(t).fill(0));for(let c=0;c<e;c++)for(let i=0;i<t;i++)s[c][i]=a.get(c,i);const h=R(s),f=_.ones(e,t);for(let c=0;c<e;c++)for(let i=0;i<t;i++){const u=h[c][i];for(let l=1;l<=n;l++)if(u>l-1&&u<=l){const d=r*(n-l+1)/n;f.set(c,i,d);break}}return f})}function rt(o,t,e){const n=_.zeros(t,o);for(let r=0;r<3;r++){const a=2**r,s=1/a,h=1/a;for(let f=0;f<t;f++)for(let c=0;c<o;c++){const i=h*Math.sin(c*s*2*Math.PI/e)*Math.sin(f*s*2*Math.PI/e),u=n.get(f,c);n.set(f,c,u+i)}}return C(n)}function at(o,t,e,n,r){const a=_.ones(t,o);if(r<=0||e<=0)return a;for(let s=0;s<e;s++){const h=Math.random()*(n[1]-n[0])+n[0],f=Math.random()*o,c=Math.random()*t,i=Math.max(0,Math.floor(f-h)),u=Math.min(o,Math.ceil(f+h)),l=Math.max(0,Math.floor(c-h)),d=Math.min(t,Math.ceil(c+h));for(let m=l;m<d;m++)for(let p=i;p<u;p++){const y=Math.sqrt((p-f)**2+(m-c)**2);if(y<h){const b=1-(y/h)**2,w=1-r*b;a.get(m,p)>w&&a.set(m,p,w)}}}return a}function st(o,t,e,n){const r=[];for(let a=0;a<o;a++){const s=z(...n.noise_scale),h=rt(t,e,s),f=Math.round(z(...n.num_patches)),c=z(...n.ink_depletion_intensity),i=at(t,e,f,n.patch_size_range,c),u=z(...n.wear_intensity),l=_.ones(e,t);let d=j(h,u,l,1-u,0);d=F(d,i),d=C(d),r.push(d)}return r}function ct(o,t){const e=[];let n=0;for(let r=0;r<o.length;r++){const a=t>0?o[r].density/t:1/o.length;n+=a,e.push(n)}return e.length>0&&(e[e.length-1]=1),e}function lt(o){const t=Math.random();let e=0,n=o.length-1;if(o.length===0)return-1;if(t<=o[0])return 0;if(t>=o[o.length-1])return o.length-1;for(;e<n;){const r=Math.floor((e+n)/2);o[r]<t?e=r+1:n=r}return e}function it(o,t,e,n,r,a){const s=F(t,e);let h=null;a.bleeding_factor>0&&(h=nt(o,n,r));const f=[];let c=0;for(let d=0;d<r;d++)for(let m=0;m<n;m++)if(o.get(d,m)>127){const p=s.get(d,m);f.push({x:m,y:d,density:p}),c+=p}if(f.length===0)return[];const i=ct(f,c),u=Math.floor(a.splat_density*f.length),l=[];for(let d=0;d<u;d++){const m=lt(i);if(m<0)continue;const p=f[m],{x:y,y:A,density:b}=p,I=(Math.random()*(a.splat_size_range[1]-a.splat_size_range[0])+a.splat_size_range[0])*(.5+.5*b);let g=0;a.bleeding_factor>0&&h&&h[A][y]<5&&(g=-Math.log(Math.random())*a.bleeding_factor);const M=I+g,T=Math.min(255,Math.floor(100+155*b));l.push({x:y,y:A,size:M,opacity:T})}return l}function ft(o,t,e,n,r,a=!1){const s=document.createElement("canvas");s.width=e,s.height=n;const h=s.getContext("2d");if(!a){const[f,c,i]=r;h.fillStyle=`rgb(${f}, ${c}, ${i})`,h.fillRect(0,0,e,n)}return o.forEach((f,c)=>{const[i,u,l]=t[c],d=f.sort((m,p)=>p.size-m.size);for(const m of d)h.fillStyle=`rgba(${i}, ${u}, ${l}, ${m.opacity/255})`,h.beginPath(),h.ellipse(m.x,m.y,m.size/2,m.size/2,0,0,2*Math.PI),h.fill()}),h.getImageData(0,0,e,n)}function ht(o,t){const{data:e,width:n,height:r}=o,a=new Uint8ClampedArray(n*r*3);for(let g=0,M=0;g<e.length;g+=4,M+=3)a[M]=e[g],a[M+1]=e[g+1],a[M+2]=e[g+2];const s=G(a,t.background_threshold),h=t.num_colors==="auto"?15:t.num_colors,{colors:f,labels:c}=K(s,h),i=V(a,f,c,n,r,t),u=240,l=g=>g[0]>u&&g[1]>u&&g[2]>u,d=i.map((g,M)=>({mask:g,color:f[M],size:O(g)})).filter(g=>!l(g.color)).sort((g,M)=>M.size-g.size);if(d.length===0){const g=document.createElement("canvas");return g.width=n,g.height=r,g.getContext("2d").getImageData(0,0,n,r)}const m=d.map(g=>g.mask),p=d.map(g=>g.color),y=Q(m,n,r,t.shift,t.rotation),A=ot(y,n,r,t.edge_width,t.edge_boost),b=st(p.length,n,r,t),w=[];for(let g=0;g<y.length;g++){const M=it(y[g],A[g],b[g],n,r,t);w.push(M)}return ft(w,p,n,r,t.background_color,!0)}const _t={stamp_size:500,num_colors:"auto",background_threshold:5,color_shape_shrink:5,shift:[0,1],rotation:[0,1],edge_width:4,edge_boost:3,wear_intensity:[.1,.05],noise_scale:[50,5],rotation_angle:[0,0],ink_depletion_intensity:[.3,.05],num_patches:[2,1],patch_size_range:[20,100],splat_density:.75,splat_size_range:[1,2],bleeding_factor:.1,background_color:[255,255,255]};function dt(o,t){const e=document.createElement("canvas"),n=e.getContext("2d");if(!n)throw new Error("Could not create canvas context");const r=o.width/o.height,a=r>=1?t:t*r,s=r<1?t:t/r;return e.width=Math.ceil(a),e.height=Math.ceil(s),n.drawImage(o,0,0,e.width,e.height),e}async function wt(o,t){return new Promise((e,n)=>{setTimeout(()=>{try{const r=ht(o,t);e(r)}catch(r){n(r)}},0)})}const D=128;async function ut(o){const t=document.createElement("canvas"),e=o.width/o.height;t.width=D,t.height=D/e;const n=t.getContext("2d");return n?(n.drawImage(o,0,0,t.width,t.height),t.toDataURL("image/png")):""}function bt(){const{user:o}=P(),[t,e]=k.useState([]),[n,r]=k.useState(!0),{addToast:a}=H(),{t:s}=N();k.useEffect(()=>{o!=null&&o.id?(r(!0),v().then(i=>e(i)).catch(i=>{console.error("Failed to load stamps from DB",i),a(s("gallery.loadErrorToast"),"error")}).finally(()=>{r(!1)})):(e([]),r(!1))},[o==null?void 0:o.id,a,s]);const h=k.useCallback(async(i,u,l)=>{if(!o){a(s("gallery.loginToast"),"info");return}try{const d=dt(i,u.stamp_size),m=d.toDataURL("image/png"),p=await ut(d),y={user_id:o.id,name:l,thumbnail:p,settings:u,sourceImageURL:m},A=await W(y);e(b=>[A,...b]),a(s("gallery.addSuccessToast",{name:l}),"success"),await v().then(e)}catch(d){console.error("Failed to add stamp to gallery:",d),a(s("gallery.addErrorToast"),"error"),e(m=>m.filter(p=>p.user_id===o.id))}},[a,o,s]),f=k.useCallback(async i=>{const u=t;e(l=>l.filter(d=>d.id!==i));try{await $(i),a(s("gallery.deleteSuccessToast"),"info")}catch(l){console.error("Failed to delete stamp:",l),a(s("gallery.deleteErrorToast"),"error"),e(u)}},[a,t,s]),c=k.useCallback(async(i,u)=>{const l=[...t],d=t.find(p=>p.id===i);if(!d)return;const m=d.name;e(p=>p.map(y=>y.id===i?{...y,name:u}:y));try{await U(i,u),a(s("gallery.renameSuccessToast",{name:u}),"success")}catch(p){console.error("Failed to rename stamp:",p),a(s("gallery.renameErrorToast",{oldName:m}),"error"),e(l)}},[a,t,s]);return{stamps:t,loading:n,addStampToGallery:h,deleteStampFromGallery:f,renameStampInGallery:c}}export{dt as c,_t as d,wt as g,bt as u};
