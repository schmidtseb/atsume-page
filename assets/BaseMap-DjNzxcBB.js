import{r as l,j as y,F as R,H as I}from"./react-vendor-CzGlubEb.js";import{b as v,a as b,u as w,e as x,f as A,h as C,i as L}from"./index-BTQ1ARHp.js";import{b as F}from"./maplibre-gl-vendor-Csyg3Y42.js";function j(r){const{user:a}=v(),[s,d]=l.useState([]),[T,h]=l.useState(!0),{addToast:o}=b(),{t}=w();l.useEffect(()=>{a!=null&&a.id&&r?(h(!0),x(r).then(e=>d(e)).catch(e=>{console.error("Failed to load geolocations from DB",e),o(t("geolocations.loadErrorToast"),"error")}).finally(()=>h(!1))):(d([]),h(!1))},[a==null?void 0:a.id,r,o,t]);const g=l.useCallback(async e=>{if(!a||!r){o(t("geolocations.loginToast"),"info");return}const u={user_id:a.id,rally_id:r,name:e.name,latitude:e.latitude,longitude:e.longitude,radius:e.radius,description:e.description??null,stamp_id:e.stamp_id??null};let n=null;try{n=await A(u),d(m=>[n,...m]),o(t("geolocations.addSuccessToast",{name:n.name}),"success")}catch(m){console.error("Failed to add geolocation:",m),o(t("geolocations.addErrorToast"),"error")}},[a,r,o,t]),i=l.useCallback(async(e,u)=>{const n=[...s];d(m=>m.map(E=>E.id===e?{...E,...u}:E));try{await C(e,u),o(t("geolocations.updateSuccessToast"),"success")}catch(m){console.error("Failed to update geolocation:",m),o(t("geolocations.updateErrorToast"),"error"),d(n)}},[s,o,t]),p=l.useCallback(async e=>{const u=[...s];d(n=>n.filter(m=>m.id!==e));try{await L(e),o(t("geolocations.deleteSuccessToast"),"info")}catch(n){console.error("Failed to delete geolocation:",n),o(t("geolocations.deleteErrorToast"),"error"),d(u)}},[s,o,t]);return{geolocations:s,loading:T,addGeolocation:g,updateGeolocation:i,deleteGeolocation:p}}function B(r,a,s,d){const h=r*Math.PI/180,o=s*Math.PI/180,t=(s-r)*Math.PI/180,g=(d-a)*Math.PI/180,i=Math.sin(t/2)*Math.sin(t/2)+Math.cos(h)*Math.cos(o)*Math.sin(g/2)*Math.sin(g/2);return 6371e3*(2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)))}function $(r,a,s=64){const[d,T]=r,h={latitude:T,longitude:d},o=a/1e3,t=[],g=o/(111.32*Math.cos(h.latitude*Math.PI/180)),i=o/110.574;let p,e,u;for(let n=0;n<s;n++)p=n/s*(2*Math.PI),e=g*Math.cos(p),u=i*Math.sin(p),t.push([h.longitude+e,h.latitude+u]);return t.push(t[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[t]},properties:{}}}const z=({isVisible:r,onMapLoad:a,onGeolocate:s,onMapClick:d,children:T,className:h="",cursor:o="",mapRef:t})=>{const{addToast:g}=b(),{t:i}=w(),[p,e]=l.useState({longitude:-.09,latitude:51.505,zoom:3}),[u,n]=l.useState(!1),m=l.useRef(null),E=t||m,M=l.useRef(null),S=l.useRef(!1),G=c=>{let f=i("mapEditor.locationError.unknown");switch(c.code){case c.PERMISSION_DENIED:f=i("mapEditor.locationError.denied");break;case c.POSITION_UNAVAILABLE:f=i("mapEditor.locationError.unavailable");break;case c.TIMEOUT:f=i("mapEditor.locationError.timeout");break}g(f,"error")},P=l.useCallback(c=>{S.current||(S.current=!0,g(i("mapEditor.centeredToast"),"success")),s==null||s({latitude:c.coords.latitude,longitude:c.coords.longitude})},[g,i,s]),k=l.useCallback(()=>{u||setTimeout(()=>{if(M.current)try{M.current.trigger(),n(!0)}catch(c){console.warn("Failed to trigger geolocation on load:",c)}},500),a==null||a()},[u,a]);return l.useEffect(()=>{if(r&&E.current){const c=setTimeout(()=>{var f;return(f=E.current)==null?void 0:f.getMap().resize()},1);return()=>clearTimeout(c)}},[r,E]),l.useEffect(()=>{if(!u){const c=setTimeout(()=>{if(M.current)try{M.current.trigger(),n(!0)}catch(f){console.warn("Failed to trigger geolocation on mount:",f),(navigator.userAgent.includes("iPhone")||navigator.userAgent.includes("iPad"))&&g(i("mapEditor.iOSLocationPrompt")||"Tap the location button to center on your position","info")}},1e3);return()=>clearTimeout(c)}},[u,g,i]),y.jsx("div",{className:`relative w-full h-full bg-gray-700 ${o} ${h}`,children:y.jsxs(R,{ref:E,mapLib:F,...p,onMove:c=>e(c.viewState),onClick:d,onLoad:k,mapStyle:"https://tiles.openfreemap.org/styles/positron",style:{width:"100%",height:"100%"},children:[y.jsx(I,{ref:M,positionOptions:{enableHighAccuracy:!0,timeout:1e4,maximumAge:0},trackUserLocation:r,showUserLocation:!0,showAccuracyCircle:!0,fitBoundsOptions:{maxZoom:14},onError:G,onGeolocate:P}),T]})})};export{z as B,$ as c,B as g,j as u};
