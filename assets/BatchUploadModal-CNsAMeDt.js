import{r as g,j as e,X as R,o as I,x as U,C as T,y as k}from"./react-vendor-BpF3ZOKC.js";import{b as B,c as A,u as E,a as _,d as $}from"./index-BQP-UfdX.js";import{p as D}from"./presets-CtbnJzjA.js";import{d as L}from"./stamp-D6e6GvNL.js";import"./vendor-CFJUWez9.js";import"./maplibre-gl-vendor-Csyg3Y42.js";import"./supabase-vendor-DfscHDRx.js";async function M(x,f,d,s){const a={successCount:0,totalCount:d.length,errors:[]};for(let c=0;c<d.length;c++){const t=d[c];try{const r=D.find(o=>o.name===t.preset),h={...L,...r?r.settings:{}},u=await B({user_id:x,name:t.name,thumbnail:"data:image/jpeg;base64,"+t.image,sourceImageURL:"data:image/jpeg;base64,"+t.image,settings:h});await A({user_id:x,rally_id:f,stamp_id:u.id,name:t.name,description:t.description,latitude:t.coordinates[0],longitude:t.coordinates[1],radius:t.collection_radius}),a.successCount++}catch(r){console.error(`Error processing item ${t.name}:`,r),a.errors.push({item:t,error:r.message})}s(Math.round((c+1)/d.length*100))}return a}const X=({isOpen:x,onClose:f,rallyId:d})=>{const{t:s}=E(),{toast:a}=_(),{user:c}=$(),[t,r]=g.useState(null),[h,u]=g.useState(0),[o,i]=g.useState("idle"),[j,n]=g.useState(null),b=g.useRef(null),S=l=>{if(l.target.files&&l.target.files[0]){const m=l.target.files[0];m.type==="application/json"?(r(m),i("idle"),n(null),u(0)):(r(null),i("error"),n(s("batchUpload.invalidFileType")),a(s("batchUpload.invalidFileType"),"destructive"))}},v=async()=>{if(!t){n(s("batchUpload.noFileSelected")),a(s("batchUpload.noFileSelected"),"destructive");return}if(!c){n(s("batchUpload.loginRequired")),a(s("batchUpload.loginRequired"),"destructive");return}i("uploading"),n(null);try{const l=new FileReader;l.onload=async m=>{var C;try{const y=(C=m.target)==null?void 0:C.result,z=JSON.parse(y);i("processing");const p=await M(c.id,d,z,F=>{u(F)});p.errors.length>0?(i("error"),n(s("batchUpload.partialSuccess",{success:p.successCount,total:p.totalCount})),a(s("batchUpload.partialSuccess",{success:p.successCount,total:p.totalCount}),"warning")):(i("success"),a(s("batchUpload.success",{count:p.successCount}),"success"))}catch(y){i("error"),n(s("batchUpload.invalidJson")+`: ${y.message}`),a(s("batchUpload.invalidJson"),"destructive")}},l.readAsText(t)}catch(l){i("error"),n(s("batchUpload.uploadFailed")+`: ${l.message}`),a(s("batchUpload.uploadFailed")+`: ${l.message}`,"destructive")}},w=()=>{r(null),u(0),i("idle"),n(null),b.current&&(b.current.value=""),f()};return x?e.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"#1f2937",padding:"20px",borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",zIndex:1e3,width:"90%",maxWidth:"425px",border:"1px solid #374151"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px"},children:[e.jsx("h2",{style:{fontSize:"1.25rem",fontWeight:"600",color:"#f9fafb"},children:s("batchUpload.title")}),e.jsx("button",{onClick:w,style:{background:"none",border:"none",cursor:"pointer",color:"#9ca3af"},children:e.jsx(R,{size:20})})]}),e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"24px",border:"2px dashed #4b5563",borderRadius:"8px",color:"#9ca3af"},children:[e.jsx("input",{id:"json-upload",type:"file",accept:".json",onChange:S,style:{display:"none"},ref:b}),e.jsxs("label",{htmlFor:"json-upload",style:{cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(I,{size:48,style:{marginBottom:"8px"}}),e.jsx("p",{style:{fontSize:"0.875rem",marginBottom:"4px"},children:s("batchUpload.dragDrop")}),e.jsx("p",{style:{fontSize:"0.75rem",color:"#6b7280"},children:s("batchUpload.orClick")})]}),t&&e.jsxs("p",{style:{marginTop:"8px",fontSize:"0.875rem",color:"#f9fafb"},children:[s("batchUpload.selectedFile"),": ",t.name]})]}),o==="uploading"&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#60a5fa",marginTop:"15px"},children:[e.jsx(U,{size:20,style:{animation:"spin 1s linear infinite"}}),e.jsx("span",{children:s("batchUpload.readingFile")})]}),o==="processing"&&e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"8px",marginTop:"15px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#60a5fa"},children:[e.jsx(U,{size:20,style:{animation:"spin 1s linear infinite"}}),e.jsx("span",{children:s("batchUpload.processingItems")})]}),e.jsx("div",{style:{width:"100%",height:"8px",backgroundColor:"#4b5563",borderRadius:"4px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${h}%`,height:"100%",backgroundColor:"#60a5fa",transition:"width 0.3s ease-in-out"}})}),e.jsxs("p",{style:{fontSize:"0.875rem",color:"#9ca3af",textAlign:"center"},children:[h,"%"]})]}),o==="success"&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#4ade80",marginTop:"15px"},children:[e.jsx(T,{size:20}),e.jsx("span",{children:s("batchUpload.uploadComplete")})]}),o==="error"&&j&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#ef4444",marginTop:"15px"},children:[e.jsx(k,{size:20}),e.jsx("span",{children:j})]}),e.jsx("button",{onClick:v,disabled:!t||o==="uploading"||o==="processing",style:{marginTop:"15px",width:"100%",padding:"10px 15px",backgroundColor:"#60a5fa",color:"#f9fafb",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"1rem",fontWeight:"500",opacity:!t||o==="uploading"||o==="processing"?.5:1,transition:"opacity 0.2s ease-in-out"},children:s(o==="processing"?"common.submitting":"batchUpload.uploadButton")})]})]}):null};export{X as default};
