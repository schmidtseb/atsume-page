import{j as e,C as Ge,i as Ce,F as Ve,I as Xe,H as Te,R as Pe,r as a,g as De,J as ke,K as Ye,N as qe,X as He,O as Je,Q as Ke,s as Ze,t as Ie,u as Qe,V as We,o as et}from"./react-vendor-XTfPaM14.js";import{u as G,B as tt,c as st,a as Fe,b as Ne,d as ot,g as lt,e as at,S as nt,L as rt,f as it,h as ve,i as ct,j as dt}from"./index-M2HUoeYB.js";import{i as ut}from"./vendor-DoV0xLrY.js";import{B as Se,u as mt,I as gt}from"./Button-BKuiEg7y.js";import"./maplibre-gl-vendor-BKez82u8.js";import"./supabase-vendor-BmfpuRp6.js";const ze=({isOpen:t,onClose:m,imageSrc:o,imageAlt:c,noImageMessage:u,children:g})=>{const{t:h}=G();return e.jsxs(tt,{isOpen:t,onClose:m,className:"flex flex-col",children:[o?e.jsx("div",{className:"w-full h-48 bg-white rounded-t-2xl flex items-center justify-center p-2",children:e.jsx("img",{src:o,alt:c||"",className:"max-w-full max-h-full object-contain"})}):e.jsx("div",{className:"w-full h-48 flex items-center justify-center bg-gray-900/50 rounded-t-2xl text-gray-500",children:u||h("stampDetailModal.noImage")}),e.jsx("div",{className:"p-6 flex flex-col gap-4",children:g})]})},ht=({location:t,onClose:m})=>{var c,u,g;const{t:o}=G();return e.jsx(ze,{isOpen:!0,onClose:m,imageSrc:((c=t.stamp)==null?void 0:c.thumbnail)||void 0,imageAlt:((u=t.stamp)==null?void 0:u.name)||"",noImageMessage:o("stampDetailModal.noImage"),children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-400 mb-4",children:[e.jsx(Ge,{className:"w-6 h-6"}),e.jsx("span",{className:"font-semibold",children:o("stampDetailModal.collected")})]}),e.jsx("h2",{className:"text-2xl font-bold mb-1",children:t.name}),e.jsx("p",{className:"text-gray-400 mb-2 text-sm",children:(g=t.stamp)==null?void 0:g.name}),t.description&&e.jsx("p",{className:"text-gray-300 text-sm mt-4",children:t.description})]})})},fe=({children:t,className:m})=>e.jsx("div",{className:ut("fixed bottom-6 left-1/2 -translate-x-1/2 z-50 bg-gray-900/80 text-white px-4 py-2 rounded-full text-sm flex items-center justify-center gap-2",m),children:t}),ft=({stamp:t,onClose:m,onGoToLocation:o})=>{const{t:c,locale:u}=G(),g=new Date(t.collected_at).toLocaleDateString(u,{year:"numeric",month:"long",day:"numeric"});return e.jsxs(ze,{isOpen:!0,onClose:m,imageSrc:t.stamp_image_data||void 0,imageAlt:t.stamp.name||"",noImageMessage:c("stampDetailModal.noImage"),children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:t.stamp.name}),e.jsx("p",{className:"text-gray-400 text-sm",children:c("collectionDetailModal.stampDesign")})]}),e.jsx("div",{className:"border-t border-gray-700 -mx-6"}),e.jsxs("button",{onClick:()=>o(t.geolocation),className:"text-left flex flex-col gap-3 p-3 -m-3 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer group",title:c("collectionDetailModal.goToLocation",{name:t.geolocation.name}),children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ce,{className:"w-5 h-5 mt-0.5 text-blue-400 flex-shrink-0"}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-white flex items-center gap-1.5",children:[t.geolocation.name,e.jsx(Ve,{className:"w-4 h-4 text-gray-500 group-hover:text-white transition-colors"})]}),e.jsx("p",{className:"text-sm text-gray-400",children:c("collectionDetailModal.location")})]})]}),t.geolocation.description&&e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Xe,{className:"w-5 h-5 mt-0.5 text-blue-400 flex-shrink-0"}),e.jsx("div",{children:e.jsx("p",{className:"text-sm text-gray-300",children:t.geolocation.description})})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Te,{className:"w-5 h-5 mt-0.5 text-blue-400 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-white",children:g}),e.jsx("p",{className:"text-sm text-gray-400",children:c("collectionDetailModal.dateCollected")})]})]})]})]})},Be=a.createContext(null),Oe=()=>{const t=a.useContext(Be);if(!t)throw new Error("usePopover must be used within a Popover");return t},_e=({children:t})=>{const[m,o]=a.useState(!1),c=a.useRef(null),u=a.useRef(null);return a.useEffect(()=>{const g=h=>{m&&c.current&&!c.current.contains(h.target)&&u.current&&!u.current.contains(h.target)&&o(!1)};return document.addEventListener("mousedown",g),()=>{document.removeEventListener("mousedown",g)}},[m]),e.jsx(Be.Provider,{value:{open:m,setOpen:o,triggerRef:c,contentRef:u},children:t})},Me=({children:t})=>{const{setOpen:m,triggerRef:o}=Oe();return Pe.cloneElement(t,{ref:o,onClick:()=>m(c=>!c)})},xe=Pe.forwardRef(({className:t,align:m="center",topOffset:o=4,leftOffset:c=0,...u},g)=>{const{open:h,triggerRef:p,contentRef:y}=Oe(),[j,f]=a.useState({top:0,left:0});return a.useLayoutEffect(()=>{if(h&&p.current){const x=p.current.getBoundingClientRect(),v=x.bottom+o,N=x.left+c;f({top:v,left:N})}},[h,p,y,m,o,c]),e.jsx("div",{ref:g||y,style:{top:`${j.top}px`,left:`${j.left}px`,visibility:h?"visible":"hidden",pointerEvents:h?"auto":"none"},className:st("absolute z-50 w-72 rounded-2xl border border-gray-600 bg-popover p-6 text-popover-foreground shadow-md outline-none",t),...u})});xe.displayName="PopoverContent";const Ae=({joinedRallies:t,collections:m,geolocations:o,visibleRallies:c,toggleRallyVisibility:u,getRallyColor:g,showVisibilityToggle:h=!1,selectedRallyId:p,setSelectedRallyId:y})=>{const{t:j}=G();return e.jsxs("div",{className:"space-y-1",children:[t.map(f=>e.jsxs("div",{className:`flex items-center justify-between p-4 rounded-xl cursor-pointer
            ${p===f.id?"bg-blue-600 text-white":"text-gray-200 hover:bg-gray-700"}`,onClick:()=>y&&y(f.id),children:[e.jsx("span",{className:"text-sm",children:f.name}),m&&o&&e.jsxs("span",{className:"text-xs opacity-75",children:[m.filter(x=>x.rally_id===f.id&&x.geolocation_id).length," ","/",o.filter(x=>x.rally_id===f.id).length]})]},f.id)),h&&e.jsxs(e.Fragment,{children:[e.jsx("h4",{className:"text-white text-sm font-semibold mt-4 mb-2",children:j("rally.toggleVisibility")}),e.jsx("div",{className:"space-y-1",children:t.map(f=>e.jsxs("label",{className:"flex items-center space-x-2 text-gray-200 text-sm",children:[e.jsx("input",{type:"checkbox",checked:c.includes(f.id),onChange:()=>u(f.id),className:"form-checkbox h-4 w-4 text-blue-600 rounded",style:{color:g(f.id)}}),e.jsx("span",{style:{color:g(f.id)},children:f.name})]},f.id))})]})]})},xt=({joinedRallies:t,selectedRallyId:m,setSelectedRallyId:o,showVisibilityToggle:c=!1,visibleRallies:u,toggleRallyVisibility:g,getRallyColor:h,collections:p,geolocations:y,collectedCount:j=0,totalCount:f=0})=>{const{t:x}=G();if(t.length===0)return null;const v=t.find(N=>N.id===m);return e.jsxs(_e,{children:[e.jsx(Me,{children:e.jsxs(Se,{variant:"ghost",className:`bg-gray-900/80 text-white px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-2 shadow-lg ring-2 ring-white/20 ${t.length<=1?"cursor-default hover:bg-gray-900/80":"hover:bg-gray-800/90"}`,children:[e.jsx(De,{className:"w-4 h-4 text-yellow-400"}),e.jsx("span",{children:v?x("rally.progress",{collectedCount:j,totalCount:f})+` (${v.name})`:x("rally.noRallySelected")}),t.length>1&&e.jsx(ke,{className:"ml-2 h-4 w-4"})]})}),t.length>1&&e.jsxs(xe,{className:"w-64 p-4 bg-gray-800 rounded-2xl shadow-lg z-50",align:"center",topOffset:4,children:[e.jsx("h4",{className:"text-white text-sm font-semibold mb-2",children:x("rally.selectRally")}),e.jsx(Ae,{joinedRallies:t,collections:p||[],geolocations:y||[],visibleRallies:u||[],toggleRallyVisibility:g||(()=>{}),getRallyColor:h||(()=>""),showVisibilityToggle:c,selectedRallyId:m,setSelectedRallyId:o})]})]})},pt=({isPanMode:t,pendingPlacement:m,lastPlacedInfo:o,hoveredStampId:c})=>{const{t:u}=G();return m||o?null:t?e.jsxs(fe,{className:"pointer-events-none",children:[e.jsx(Ye,{className:"w-4 h-4"})," ",u("logbook.panMode")]}):c?e.jsxs(fe,{className:"pointer-events-none",children:[e.jsx(qe,{className:"w-4 h-4"})," ",u("logbook.clickToView")]}):null},bt=({isOpen:t,onClose:m,pendingPlacement:o,onPlace:c,onCancelPlacement:u,onRemovePlacement:g,collections:h,geolocationsWithStamps:p,onGoToLocation:y,joinedRallies:j,adminTestingRallyId:f,stampImageCache:x})=>{const{t:v}=G(),{addToast:N}=Fe(),{joinedRallies:T}=Ne(),[w,C]=a.useState(!1),[D,Q]=a.useState(!1),[L,S]=a.useState(null),[ie,oe]=a.useState(null),[U,ce]=a.useState(null),[F,le]=a.useState(null);a.useEffect(()=>{!f&&!F&&T.length>0&&le(T[0].id)},[F,T,f]);const[P,W]=a.useState(null),J=a.useRef(null),ee=a.useRef(null),z=a.useRef(null),pe=5,$=a.useMemo(()=>{const s=f||F;return s?h.filter(d=>d.logbook_x!==null&&d.logbook_y!==null&&d.logbook_rotation!==null&&d.rally_id===s).map(d=>{const r=p.find(i=>i.id===d.geolocation_id);return!r||!r.stamp?null:{...d,stamp:r.stamp,geolocation:r}}).filter(d=>d!==null):[]},[h,p,F,f]),O=a.useCallback((s,d,r)=>{var i;(i=ee.current)==null||i.call(ee,s,d,r)},[]),{viewTransform:R,viewTransformRef:te,viewportSize:B,isPanMode:ae,isPanning:Y,containerProps:I,stampPreview:k,containerRef:be,canvasRef:ye,canvasNode:A,isInitialized:we}=mt({onPlaceRequest:O,isPlacementDisabled:!o||D||!P}),de=a.useCallback((s,d)=>({x:(s-R.x)/R.scale,y:(d-R.y)/R.scale}),[R]),l=a.useCallback((s,d)=>{for(let r=$.length-1;r>=0;r--){const i=$[r],M=x.get(i.id);if(!M||!i.logbook_x||!i.logbook_y)continue;const{width:H,height:se}=M,{logbook_x:ue,logbook_y:je,logbook_rotation:ne}=i,re=s-ue,X=d-je,Z=-(ne||0)*(Math.PI/180),me=Math.cos(Z),ge=Math.sin(Z),he=re*me-X*ge,Re=re*ge+X*me;if(he>=-H/2&&he<=H/2&&Re>=-se/2&&Re<=se/2)return i}return null},[$,x]),n=a.useCallback((s,d)=>{s.clearRect(0,0,d.width,d.height);for(const r of $){const i=x.get(r.id);i&&r.logbook_x!=null&&r.logbook_y!=null&&(s.save(),s.translate(r.logbook_x,r.logbook_y),s.rotate((r.logbook_rotation||0)*(Math.PI/180)),s.drawImage(i,-i.width/2,-i.height/2),s.restore())}},[$,x,R,B]),b=a.useCallback((s,d)=>{if(n(s,d),k&&P){const r=Math.atan2(k.current.y-k.start.y,k.current.x-k.start.x)*180/Math.PI,i=Math.hypot(k.current.y-k.start.y,k.current.x-k.start.x),{bitmap:M}=P;s.save(),s.globalAlpha=.7,s.translate(k.start.x,k.start.y),i>5&&s.rotate(r*Math.PI/180),s.drawImage(M,-M.width/2,-M.height/2),s.restore()}if(U&&!Y&&!k){const r=$.find(M=>M.id===U),i=r?x.get(r.id):null;r&&i&&r.logbook_x&&r.logbook_y&&(s.save(),s.translate(r.logbook_x,r.logbook_y),s.rotate((r.logbook_rotation||0)*(Math.PI/180)),s.strokeStyle="rgba(59, 130, 246, 0.9)",s.lineWidth=4/R.scale,s.setLineDash([8/R.scale,4/R.scale]),s.strokeRect(-i.width/2,-i.height/2,i.width,i.height),s.restore())}},[n,k,P,U,$,x,R.scale,Y]),_=a.useCallback(async(s,d,r)=>{if(!(!o||!P))try{if(J.current&&(J.current.currentTime=0,J.current.play().catch(console.warn)),A){const i=A.getContext("2d");if(i){const{bitmap:M}=P;i.save(),i.translate(s,d),i.rotate((r||0)*Math.PI/180),i.drawImage(M,-M.width/2,-M.height/2),i.restore()}}c(o.collection.id,{x:s,y:d,rotation:r},P.dataUrl),S({collectionId:o.collection.id,name:o.stamp.name}),W(null)}catch(i){console.error("Error placing stamp:",i),N(v("logbook.placeErrorToast"),"error")}},[o,P,c,N,A,v]);a.useEffect(()=>{ee.current=_},[_]),a.useEffect(()=>{if(!J.current){const s=new Audio("/atsume-page/stamp-sound.mp3");s.preload="auto",J.current=s}},[]),a.useEffect(()=>{if(o&&t){S(null),le(o.collection.rally_id);let s=!1;return(async()=>{Q(!0),W(null);try{const{stamp:i}=o,M={...i.settings,stamp_size:Math.min(i.settings.stamp_size,500)},H=new Image;H.crossOrigin="anonymous",H.src=i.sourceImageURL,await new Promise((ge,he)=>{H.onload=()=>ge(),H.onerror=()=>he()});const se=ot(H,M.stamp_size),ue=se.getContext("2d",{willReadFrequently:!0});if(!ue)throw new Error("No context");const je=ue.getImageData(0,0,se.width,se.height),ne=await lt(je,M),re=await createImageBitmap(ne),X=document.createElement("canvas");X.width=ne.width,X.height=ne.height;const Z=X.getContext("2d");if(!Z)throw new Error("No context for data URL");Z.fillStyle="#FFFFFF",Z.fillRect(0,0,X.width,X.height),Z.drawImage(re,0,0);const me=X.toDataURL("image/jpeg",.8);s||W({bitmap:re,dataUrl:me})}catch(r){console.error("Logbook: Failed to generate pending stamp",r),s||N(v("logbook.prepareErrorToast"),"error")}finally{s||Q(!1)}})(),()=>{s=!0}}else t||W(null)},[o,t,N,v]),a.useEffect(()=>{if(!A||!t)return;const s=A.getContext("2d");if(!s)return;const d=requestAnimationFrame(()=>{b(s,A)});return()=>cancelAnimationFrame(d)},[A,t,b,R.scale]);const q=a.useCallback(()=>{C(!0),setTimeout(()=>{m(),C(!1),S(null),o&&u(o.collection.id)},300)},[m,o,u]),V=()=>{L&&(g(L.collectionId),S(null))},E=a.useCallback(s=>{const d=s.currentTarget.getBoundingClientRect(),r=de(s.clientX-d.left,s.clientY-d.top);return l(r.x,r.y)},[de,l]),Ue={...I,onMouseDown:s=>{var r,i;if(Y||k||D||o){(r=I.onMouseDown)==null||r.call(I,s);return}const d=E(s);z.current={clientX:s.clientX,clientY:s.clientY,isPotentialClick:!!d},(i=I.onMouseDown)==null||i.call(I,s)},onMouseMove:s=>{var r,i;if((r=z.current)!=null&&r.isPotentialClick&&Math.hypot(s.clientX-z.current.clientX,s.clientY-z.current.clientY)>pe&&(z.current.isPotentialClick=!1),(i=I.onMouseMove)==null||i.call(I,s),Y||k||D||o){U&&ce(null);return}const d=E(s);(d==null?void 0:d.id)!==U&&ce(d?d.id:null)},onMouseUp:s=>{var d,r;if((d=z.current)!=null&&d.isPotentialClick){const i=E(s);i&&oe(i)}(r=I.onMouseUp)==null||r.call(I),z.current=null}},$e=ae?"cursor-grab":o?"cursor-crosshair":U&&!Y&&!k?"cursor-pointer":"cursor-default";return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`fixed inset-0 z-40 bg-gray-900/50 backdrop-blur-sm transition-opacity duration-300 ${t&&!w?"opacity-100":"opacity-0 pointer-events-none"}`,children:[e.jsx(gt,{canvasRef:ye,containerRef:be,canvasNode:A,containerProps:Ue,viewTransform:R,viewTransformRef:te,viewportSize:B,isPanning:Y,isPanMode:ae,stampPreview:k,cursorClass:$e,ariaLabel:v("logbook.stampingArea"),className:`transition-opacity duration-300 ${we?"opacity-100":"opacity-0"}`}),e.jsx("button",{onClick:q,className:"absolute top-4 right-4 z-50 p-2 text-white bg-gray-900/50 rounded-full hover:bg-gray-700 transition-colors","aria-label":v("logbook.close"),children:e.jsx(He,{className:"w-6 h-6"})}),j.length>0&&!f&&e.jsx("div",{className:"absolute top-4 left-4 z-50",children:e.jsx(xt,{joinedRallies:j,selectedRallyId:F,setSelectedRallyId:le,collections:h,geolocations:p,collectedCount:h.filter(s=>s.geolocation_id&&s.rally_id===F).length,totalCount:p.filter(s=>s.rally_id===F).length})}),(D||o&&!P)&&e.jsxs("div",{className:"absolute inset-0 bg-black/60 flex items-center justify-center text-white text-lg z-50 pointer-events-none",children:[e.jsx(Je,{className:"w-6 h-6 mr-3 animate-pulse"}),v("logbook.preparingStamp")]}),o&&!D&&e.jsx(fe,{className:"pointer-events-none text-center",children:e.jsxs("div",{children:[v("logbook.pendingPlacement")," ",e.jsx("strong",{children:o.stamp.name}),e.jsx("br",{}),e.jsx("span",{className:"text-xs text-gray-300",children:v("logbook.pendingPlacementSubtext")})]})}),L&&!o&&!D&&e.jsxs(fe,{className:"backdrop-blur-sm shadow-lg animate-fade-in",children:[e.jsx("span",{className:"text-gray-300",children:v("logbook.placedToast",{name:L.name})}),e.jsxs("button",{onClick:V,className:"flex items-center gap-1.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 rounded-full transition-colors",children:[e.jsx(Ke,{className:"w-4 h-4"}),v("logbook.redo")]})]}),e.jsx(pt,{isPanMode:ae,pendingPlacement:!!o,lastPlacedInfo:!!L,hoveredStampId:U})]}),ie&&e.jsx(ft,{stamp:ie,onClose:()=>oe(null),onGoToLocation:y})]})},yt=({isOpen:t,onClose:m,allCollections:o,allGeolocationsWithStamps:c,onSelectLocation:u,adminTestingRallyId:g})=>{var T;const{t:h}=G(),{joinedRallies:p}=Ne(),[y,j]=a.useState(null);a.useEffect(()=>{g?j(g):!y&&p.length>0&&j(p[0].id)},[y,p,g]);const f=a.useMemo(()=>{const w=g||y;return w?o.filter(C=>C.rally_id===w):[]},[o,y,g]),x=a.useMemo(()=>{const w=g||y;return w?c.filter(C=>C.rally_id===w):[]},[c,y,g]),v=a.useMemo(()=>f.filter(C=>C.logbook_x!=null&&C.stamp_image_data).map(C=>{const D=x.find(Q=>Q.id===C.geolocation_id);return D?{...D,collectionId:C.id}:null}).filter(Boolean),[f,x]),{handleSelect:N}=at({onSelectLocation:u,onClose:m});return e.jsxs(nt,{isOpen:t,onClose:m,title:h("collectedStampsList.title"),emptyMessage:h("collectedStampsList.empty"),emptySubtext:h("collectedStampsList.emptySubtext"),children:[p.length>0&&!g&&e.jsx("div",{className:"px-4 py-2 border-b border-gray-700",children:e.jsxs(_e,{children:[e.jsx(Me,{children:e.jsxs(Se,{variant:"ghost",className:`w-full bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center justify-between gap-2 shadow-lg ring-1 ring-white/10 ${p.length<=1?"cursor-default hover:bg-gray-700":""}`,disabled:p.length<=1,children:[y?(T=p.find(w=>w.id===y))==null?void 0:T.name:h("rally.selectRally"),p.length>1&&e.jsx(ke,{className:"ml-2 h-4 w-4"})]})}),p.length>1&&e.jsxs(xe,{className:"w-64 p-4 bg-gray-800 rounded-2xl shadow-lg z-50",children:[e.jsx("h4",{className:"text-white text-sm font-semibold mb-2",children:h("rally.selectRally")}),e.jsx("div",{className:"space-y-1",children:p.map(w=>e.jsxs("div",{className:`flex items-center justify-between p-2 rounded-md cursor-pointer
                          ${y===w.id?"bg-blue-600 text-white":"text-gray-200 hover:bg-gray-700"}`,onClick:()=>j(w.id),children:[e.jsx("span",{className:"text-sm",children:w.name}),c.length>0&&e.jsxs("span",{className:"text-xs opacity-75",children:[o.filter(C=>C.rally_id===w.id&&C.geolocation_id).length," ","/",c.filter(C=>C.rally_id===w.id).length]})]},w.id))})]})]})}),v.map(w=>e.jsx(rt,{location:w,onClick:N,collectionId:w.collectionId},w.collectionId))]})},wt=({joinedRallies:t,collections:m,geolocations:o,visibleRallies:c,toggleRallyVisibility:u,getRallyColor:g})=>{const{t:h}=G(),p=m.filter(j=>j.geolocation_id&&c.includes(j.rally_id)).length,y=o.filter(j=>c.includes(j.rally_id)).length;return t.length===0?null:e.jsxs(_e,{children:[e.jsx(Me,{children:e.jsxs(Se,{variant:"ghost",className:`bg-gray-900/80 text-white px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-2 shadow-lg ring-2 ring-white/20 ${t.length<=1?"cursor-default hover:bg-gray-900/80":"hover:bg-gray-800/90"}`,children:[o.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"w-4 h-4 text-yellow-400"}),e.jsx("span",{children:h("rally.progress",{collectedCount:p,totalCount:y})})]}),t.length>0&&e.jsx(ke,{className:"ml-2 h-4 w-4"})]})}),e.jsxs(xe,{className:"w-64 p-4 bg-gray-800 rounded-2xl shadow-lg z-50",topOffset:0,children:[e.jsx("h4",{className:"text-white text-sm font-semibold mb-2",children:h("rally.selectRally")}),e.jsx(Ae,{joinedRallies:t,collections:m,geolocations:o,visibleRallies:c,toggleRallyVisibility:u,getRallyColor:g,showVisibilityToggle:!0})]})]})},Ee=["#EF4444","#3B82F6","#10B981","#F59E0B","#6366F1","#EC4899","#8B5CF6"],Mt=({adminTestingRallyId:t=null,isVisible:m=!0})=>{const{addToast:o}=Fe(),{user:c,joinedRallies:u,role:g}=Ne(),h=a.useRef(null),{geolocations:p,geolocationsLoading:y,refreshGeolocations:j,stamps:f,collections:x,collectionsLoading:v,isCollected:N,collectStamp:T,updateCollectionPlacement:w,revertCollectionPlacement:C,refreshCollections:D,refreshStamps:Q}=it();a.useEffect(()=>{m&&(c!=null&&c.id)&&(u.length>0||t)&&(j(),D(),Q())},[m,c==null?void 0:c.id,u,t,j,D]);const{t:L}=G(),[S,ie]=a.useState(null),[oe,U]=a.useState(null),[ce,F]=a.useState(!1),[le,P]=a.useState(!1),[W,J]=a.useState(!1),[ee,z]=a.useState(null),[pe,$]=a.useState(new Map),[O,R]=a.useState([]);a.useEffect(()=>{u.length>0&&O.length===0&&R(u.map(l=>l.id))},[u,O.length]);const te=a.useCallback(l=>{const n=u.findIndex(b=>b.id===l);return n===-1?"#737373":Ee[n%Ee.length]},[u]),B=a.useMemo(()=>p.map(n=>{const b=f.find(_=>_.id===n.stamp_id)||null;return{...n,stamp:b}}).filter(n=>g==="admin"?!0:n.stamp_id!==null&&n.stamp&&(n.stamp.thumbnail||n.stamp.sourceImageURL)).filter(n=>t?n.rally_id===t:O.includes(n.rally_id)),[p,f,O,t,x,g]),ae=a.useMemo(()=>S?B.some(l=>!(t?l.rally_id===t:O.includes(l.rally_id))||N(l.id,l.rally_id)?!1:ve(S.latitude,S.longitude,l.latitude,l.longitude)<=l.radius):!1,[S,B,N,O,t]),Y=a.useMemo(()=>({type:"FeatureCollection",features:B.map(n=>{const b=N(n.id,n.rally_id);let _=!1;const q=t?n.rally_id===t:O.includes(n.rally_id);!b&&S&&q&&(_=ve(S.latitude,S.longitude,n.latitude,n.longitude)<=n.radius);const V=b?"collected":_?"collectable":"locked",E=ct([n.longitude,n.latitude],n.radius);return E.properties={id:n.id,state:V,rallyId:n.rally_id,color:te(n.rally_id)},E})}),[B,N,S,O,te,t]);a.useEffect(()=>{const l=x.filter(_=>_.logbook_x!=null&&_.stamp_image_data);let n=!1;const b=async()=>{const _=l.map(async E=>{try{const K=new Image;K.src=E.stamp_image_data,await K.decode();const Le=await createImageBitmap(K);return[E.id,Le]}catch(K){return console.error(`Failed to preload image for collection ${E.id}`,K),null}}),q=await Promise.all(_);if(n)return;const V=new Map;for(const E of q)E&&V.set(E[0],E[1]);$(V)};return l.length>0?b():$(new Map),()=>{n=!0}},[x]);const I=async l=>{if(!(W||!l.stamp))try{const n=await T(l.id,l.rally_id);n&&(z({collection:n,stamp:l.stamp}),F(!0))}finally{J(!1)}},k=(l,n,b)=>{w(l,n,b),z(null)},be=async l=>{await C(l);const n=x.find(b=>b.id===l);if(n){const b=B.find(_=>_.id===n.geolocation_id);b&&b.stamp&&z({collection:n,stamp:b.stamp})}},ye=async l=>{await C(l),z(null),o(L("collections.placementCancelledToast"),"info")},A=l=>{F(!1),P(!1),h.current&&(h.current.flyTo({center:[l.longitude,l.latitude],zoom:15,speed:1.2}),o(L("rally.flyingToast",{name:l.name}),"info"))},we=l=>{ie(l)},de=l=>{R(n=>n.includes(l)?n.filter(b=>b!==l):[...n,l])};return e.jsxs(e.Fragment,{children:[e.jsxs(dt,{isVisible:m,onGeolocate:we,mapRef:h,children:[e.jsxs(Ze,{id:"rally-radius-circles",type:"geojson",data:Y,children:[e.jsx(Ie,{id:"rally-radius-fill",type:"fill",paint:{"fill-color":["match",["get","state"],"collectable",["get","color"],"collected","#F59E0B","#737373"],"fill-opacity":["match",["get","state"],"collectable",.3,"collected",.2,.1]}}),e.jsx(Ie,{id:"rally-radius-stroke",type:"line",paint:{"line-color":["match",["get","state"],"collectable",["get","color"],"collected","#F59E0B","#a3a3a3"],"line-width":2,"line-dasharray":[2,2]}})]}),B.map(l=>{const n=N(l.id,l.rally_id);let b=!1;!n&&S&&(b=ve(S.latitude,S.longitude,l.latitude,l.longitude)<=l.radius);const _=n?"#F59E0B":te(l.rally_id);let q="";return b&&(q="animate-pulse-marker"),e.jsx(Qe,{longitude:l.longitude,latitude:l.latitude,style:{zIndex:20},children:e.jsx("button",{onClick:V=>{V.stopPropagation(),b?I(l):n?U(l):o(L("rally.outOfReach"),"info")},"aria-label":L("rally.locationStatus",{name:l.name}),className:`${b||n?"cursor-pointer":"cursor-default"}`,children:e.jsx(Ce,{className:`${q} w-8 h-8 drop-shadow-lg`,style:{color:_},strokeWidth:1.5})})},l.id)})]}),e.jsx("div",{className:`absolute top-32 left-1/2 -translate-x-1/2 z-25 transition-all duration-500 ease-in-out pointer-events-none
          ${ae?"opacity-100 translate-y-0":"opacity-0 -translate-y-full"}`,children:e.jsxs("div",{className:"bg-blue-600/90 backdrop-blur-sm text-white px-5 py-3 rounded-full text-base font-semibold flex items-center gap-3 shadow-lg ring-2 ring-white/20",children:[e.jsx(Ce,{className:"w-5 h-5 animate-pulse-marker"}),e.jsx("span",{children:L("rally.nearbyStamp")})]})}),!(y||v)&&u.length>0&&e.jsx("div",{className:"absolute top-20 z-25 flex flex-col items-center gap-2 w-full",children:e.jsx(wt,{joinedRallies:u,collections:x,geolocations:B,visibleRallies:O,toggleRallyVisibility:de,getRallyColor:te})}),e.jsx("button",{onClick:()=>F(!0),className:"fixed top-1/2 -translate-y-1/2 right-0 z-30 py-4 px-2 bg-gray-900/70 hover:bg-gray-800/90 backdrop-blur-sm rounded-l-lg shadow-lg transition-colors logbook-toggle-button","aria-label":L("rally.logbookToggle"),title:L("rally.logbookToggle"),children:e.jsx(We,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>P(!0),className:"fixed top-1/2 -translate-y-1/2 left-0 z-30 py-4 px-2 bg-gray-900/70 hover:bg-gray-800/90 backdrop-blur-sm rounded-r-lg shadow-lg transition-colors collected-stamps-toggle-button","aria-label":L("rally.collectedStampsToggle"),title:L("rally.collectedStampsToggle"),children:e.jsx(et,{className:"w-5 h-5"})}),oe&&e.jsx(ht,{location:oe,onClose:()=>U(null)}),e.jsx(bt,{isOpen:ce,onClose:()=>{F(!1)},collections:x,geolocationsWithStamps:B,pendingPlacement:ee,onPlace:k,onRemovePlacement:be,onCancelPlacement:ye,stampImageCache:pe,onGoToLocation:A,joinedRallies:u,adminTestingRallyId:t}),e.jsx(yt,{isOpen:le,onClose:()=>P(!1),allCollections:x,allGeolocationsWithStamps:B,onSelectLocation:A,adminTestingRallyId:t})]})};export{Mt as default};
