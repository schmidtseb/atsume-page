import{r as s,j as f}from"./react-vendor-ZaBYvqzn.js";const S=4e3,I=3e3,z=.1,K=2,Z=5,B=200;function ot({onPlaceRequest:h,isPlacementDisabled:d=!1,isPanOnly:x=!1}){const[i,u]=s.useState({x:0,y:0,scale:1}),[a,v]=s.useState({width:0,height:0}),[l,p]=s.useState("idle"),[y,C]=s.useState(!1),[o,b]=s.useState(null),[X,j]=s.useState(null),[m,F]=s.useState(null),w=s.useRef(i),g=s.useRef({clientX:0,clientY:0,viewX:0,viewY:0}),$=s.useRef({dist:0,midX:0,midY:0,initialTransform:{x:0,y:0,scale:1}}),_=s.useRef(0),T=s.useRef(!1),D=s.useRef(!1);s.useEffect(()=>{w.current=i},[i]);const Y=s.useCallback(t=>{const{width:e,height:n}=a,c=Math.max(z,Math.min(K,t.scale)),r=e>S*c?(e-S*c)/2:Math.max(e-S*c-B,Math.min(B,t.x)),M=n>I*c?(n-I*c)/2:Math.max(n-I*c-B,Math.min(B,t.y));return{x:r,y:M,scale:c}},[a]),E=s.useCallback((t,e)=>{const{x:n,y:c,scale:r}=w.current;return{x:(t-n)/r,y:(e-c)/r}},[]);s.useEffect(()=>{if(m&&(m.width=S,m.height=I,!T.current&&a.width>0&&a.height>0)){const t=Math.min(a.width/S,a.height/I,.8),e=Y({scale:t,x:(a.width-S*t)/2,y:(a.height-I*t)/2});u(e),T.current=!0}},[a,m,Y]),s.useEffect(()=>{T.current&&a.width>0&&a.height>0&&u(t=>Y(t))},[a,Y]),s.useEffect(()=>{if(!X)return;const t=new ResizeObserver(e=>{for(const n of e){const{width:c,height:r}=n.contentRect;v({width:c,height:r})}});return t.observe(X),()=>t.disconnect()},[X]);const H=s.useCallback(t=>{if(t.preventDefault(),t.stopPropagation(),!X)return;const{clientX:e,clientY:n,deltaY:c}=t,r=X.getBoundingClientRect();u(M=>{const k=1-c*.001,V=M.scale*k,R=Math.max(z,Math.min(K,V));if(R===M.scale)return M;const G=(e-r.left-M.x)/M.scale,O=(n-r.top-M.y)/M.scale,U=e-r.left-G*R,A=n-r.top-O*R;return Y({scale:R,x:U,y:A})})},[X,Y]);s.useEffect(()=>{if(X)return X.addEventListener("wheel",H,{passive:!1}),()=>X.removeEventListener("wheel",H)},[X,H]),s.useEffect(()=>{const t=n=>{var c,r;n.code==="Space"&&!n.repeat&&((c=document.activeElement)==null?void 0:c.tagName)!=="INPUT"&&((r=document.activeElement)==null?void 0:r.tagName)!=="TEXTAREA"&&(n.preventDefault(),C(!0))},e=n=>{n.code==="Space"&&(n.preventDefault(),C(!1),l==="panning"&&p("idle"))};return document.addEventListener("keydown",t),document.addEventListener("keyup",e),()=>{document.removeEventListener("keydown",t),document.removeEventListener("keyup",e)}},[l]);const q=s.useCallback(t=>{if(D.current){D.current=!1;return}if(t.button!==0&&t.button!==1)return;if(y||x||t.button===1||d)p("panning"),g.current={clientX:t.clientX,clientY:t.clientY,viewX:i.x,viewY:i.y};else{p("stamping");const n=t.currentTarget.getBoundingClientRect(),c=E(t.clientX-n.left,t.clientY-n.top);b({start:c,current:c}),g.current={clientX:t.clientX,clientY:t.clientY,viewX:0,viewY:0}}},[y,x,d,i,E]),J=s.useCallback(t=>{if(l==="panning"&&m){const e=t.clientX-g.current.clientX,n=t.clientY-g.current.clientY,c={x:g.current.viewX,y:g.current.viewY,scale:i.scale},r=Y({...c,x:c.x+e,y:c.y+n});w.current=r,m.style.transform=`translate(${r.x}px, ${r.y}px) scale(${r.scale})`}else if(l==="stamping"&&o){const e=t.currentTarget.getBoundingClientRect(),n=E(t.clientX-e.left,t.clientY-e.top);b({...o,current:n})}},[l,i.scale,Y,o,E,m]),W=s.useCallback(t=>{if(l==="panning")u(w.current);else if(l==="stamping"&&o){const e=Math.hypot(t.clientX-g.current.clientX,t.clientY-g.current.clientY);let n=0;if(e>=Z){const c=o.current.x-o.start.x,r=o.current.y-o.start.y;n=Math.atan2(r,c)*180/Math.PI}h(o.start.x,o.start.y,n)}p("idle"),b(null)},[l,o,h]),Q=s.useCallback(t=>{if(t.touches.length>=2){p("pinching");const e=t.touches[0],n=t.touches[1],c=Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY);$.current={dist:c,midX:(e.clientX+n.clientX)/2,midY:(e.clientY+n.clientY)/2,initialTransform:{...i}};return}if(t.touches.length===1){const e=t.touches[0];if(d||(y||x)){p("panning"),g.current={clientX:e.clientX,clientY:e.clientY,viewX:i.x,viewY:i.y};return}p("stamping");const c=t.currentTarget.getBoundingClientRect(),r=E(e.clientX-c.left,e.clientY-c.top);b({start:r,current:r}),g.current={clientX:e.clientX,clientY:e.clientY,viewX:0,viewY:0},"force"in e&&(_.current=e.force),D.current=!0}},[y,x,d,i,E]),P=s.useCallback(t=>{if(l==="pinching"&&t.touches.length>=2&&m){const e=t.touches[0],n=t.touches[1],c=(e.clientX+n.clientX)/2,r=(e.clientY+n.clientY)/2,M=Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY),{initialTransform:k,dist:V}=$.current,R=t.currentTarget.getBoundingClientRect(),G=($.current.midX-R.left-k.x)/k.scale,O=($.current.midY-R.top-k.y)/k.scale,U=M/V,A=k.scale*U,nt=c-R.left-G*A,ct=r-R.top-O*A,L=Y({x:nt,y:ct,scale:A});w.current=L,m.style.transform=`translate(${L.x}px, ${L.y}px) scale(${L.scale})`}else if(l==="stamping"&&t.touches.length===1&&o){const e=t.touches[0],n=t.currentTarget.getBoundingClientRect(),c=E(e.clientX-n.left,e.clientY-n.top);b({...o,current:c}),"force"in e&&(_.current=e.force)}else if(l==="panning"&&t.touches.length===1&&m){const e=t.touches[0],n=e.clientX-g.current.clientX,c=e.clientY-g.current.clientY,r={x:g.current.viewX,y:g.current.viewY,scale:i.scale},M=Y({...r,x:r.x+n,y:r.y+c});w.current=M}},[l,i.scale,Y,o,E,m]),tt=s.useCallback(t=>{if(l==="panning"||l==="pinching")u(w.current);else if(l==="stamping"&&t.changedTouches.length===1&&o){const e=t.changedTouches[0],n=Math.hypot(e.clientX-g.current.clientX,e.clientY-g.current.clientY);let c=0;if(n>=Z){const r=o.current.x-o.start.x,M=o.current.y-o.start.y;c=Math.atan2(M,r)*180/Math.PI}h(o.start.x,o.start.y,c),_.current=0}t.touches.length<2&&(p("idle"),b(null),setTimeout(()=>{D.current=!1},500))},[l,o,h]),et=s.useCallback(()=>{u(t=>({...t}))},[]);return s.useEffect(()=>{m&&(m.style.transform=`translate(${i.x}px, ${i.y}px) scale(${i.scale})`)},[i,m]),s.useEffect(()=>()=>{T.current=!1},[]),{viewTransform:i,viewTransformRef:w,viewportSize:a,isPanning:l==="panning"||l==="pinching",isPanMode:y||x,stampPreview:o,containerProps:{onMouseDown:q,onMouseMove:J,onMouseUp:W,onMouseLeave:W,onTouchStart:Q,onTouchMove:P,onTouchEnd:tt},forceCanvasUpdate:et,containerRef:j,canvasRef:F,canvasNode:m,isInitialized:T.current}}const N=160,st=({mainCanvas:h,viewTransformRef:d,viewportSize:x,canvasWidth:i,canvasHeight:u})=>{const a=s.useRef(null),v=s.useRef(null),l=i/u,p=N/l;return s.useEffect(()=>{if(!h||!a.current)return;const y=a.current.getContext("2d",{alpha:!1});if(!y)return;const C=()=>{if(!x.width||!x.height){v.current=requestAnimationFrame(C);return}y.fillStyle="#f7f3e9",y.fillRect(0,0,N,p),y.drawImage(h,0,0,N,p);const o=d.current;if(!o){v.current=requestAnimationFrame(C);return}const{x:b,y:X,scale:j}=o,m=-b/j*(N/i),F=-X/j*(p/u),w=x.width/j*(N/i),g=x.height/j*(p/u);y.strokeStyle="rgba(0, 150, 255, 1)",y.lineWidth=1.5,y.strokeRect(m,F,w,g),v.current=requestAnimationFrame(C)};return v.current=requestAnimationFrame(C),()=>{v.current&&cancelAnimationFrame(v.current)}},[h,d,x,i,u,p]),f.jsx("div",{className:"absolute bottom-4 right-4 z-20 bg-gray-900/70 backdrop-blur-sm p-1 rounded-lg shadow-lg border border-gray-700 pointer-events-none","aria-hidden":"true",children:f.jsx("canvas",{ref:a,width:N,height:p,className:"rounded-md"})})},rt=({stampPreview:h,viewTransform:d})=>{if(!(h!=null&&h.start)||!h.current)return null;const x=h.start.x*d.scale+d.x,i=h.start.y*d.scale+d.y,u=h.current.x*d.scale+d.x,a=h.current.y*d.scale+d.y;return Math.hypot(u-x,a-i)<5?null:f.jsxs("svg",{className:"absolute top-0 left-0 w-full h-full pointer-events-none z-50","aria-hidden":"true",children:[f.jsx("defs",{children:f.jsxs("filter",{id:"glow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[f.jsx("feGaussianBlur",{stdDeviation:"3",result:"coloredBlur"}),f.jsxs("feMerge",{children:[f.jsx("feMergeNode",{in:"coloredBlur"}),f.jsx("feMergeNode",{in:"SourceGraphic"})]})]})}),f.jsxs("g",{style:{filter:"url(#glow)"},children:[f.jsx("circle",{cx:x,cy:i,r:"8",stroke:"rgba(0, 0, 0, 0.5)",strokeWidth:"2",fill:"rgba(255, 255, 255, 0.8)"}),f.jsx("line",{x1:x,y1:i,x2:u,y2:a,stroke:"rgba(255, 255, 255, 0.8)",strokeWidth:"2",strokeDasharray:"4,4"}),f.jsx("circle",{cx:u,cy:a,r:"4",fill:"rgba(255, 255, 255, 0.8)"})]})]})},at=({canvasRef:h,containerRef:d,canvasNode:x,containerProps:i,viewTransform:u,viewTransformRef:a,viewportSize:v,isPanning:l,stampPreview:p,cursorClass:y,ariaLabel:C,className:o})=>f.jsxs(f.Fragment,{children:[f.jsxs("div",{ref:d,className:`relative w-full h-full bg-paper-texture overflow-hidden touch-none ${y} ${l?"cursor-grabbing":""} ${o}`,...i,children:[f.jsx("canvas",{ref:h,className:"bg-white shadow-xl","aria-label":C,style:{position:"absolute",top:0,left:0,height:I,width:S,transform:`translate(${u.x}px, ${u.y}px) scale(${u.scale})`,transformOrigin:"0 0",willChange:"transform"}}),f.jsx(st,{mainCanvas:x,viewTransformRef:a,viewportSize:v,canvasWidth:S,canvasHeight:I})]}),f.jsx(rt,{stampPreview:p,viewTransform:u})]});export{at as I,ot as u};
