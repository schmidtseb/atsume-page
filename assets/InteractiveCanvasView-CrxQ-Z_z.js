import{r,j as d}from"./react-vendor-B6On5FFh.js";const S=4e3,I=3e3,W=.1,z=2,K=5,L=200;function it({onPlaceRequest:h,isPlacementDisabled:f=!1,isPanOnly:x=!1}){const[i,u]=r.useState({x:0,y:0,scale:1}),[a,w]=r.useState({width:0,height:0}),[l,p]=r.useState("idle"),[m,b]=r.useState(!1),[o,R]=r.useState(null),[M,B]=r.useState(null),[X,_]=r.useState(null),v=r.useRef(i),y=r.useRef({clientX:0,clientY:0,viewX:0,viewY:0}),T=r.useRef({dist:0,midX:0,midY:0,initialTransform:{x:0,y:0,scale:1}}),A=r.useRef(0),$=r.useRef(!1);r.useEffect(()=>{v.current=i},[i]);const Y=r.useCallback(t=>{const{width:e,height:n}=a,c=Math.max(W,Math.min(z,t.scale)),s=e>S*c?(e-S*c)/2:Math.max(e-S*c-L,Math.min(L,t.x)),g=n>I*c?(n-I*c)/2:Math.max(n-I*c-L,Math.min(L,t.y));return{x:s,y:g,scale:c}},[a]),E=r.useCallback((t,e)=>{const{x:n,y:c,scale:s}=v.current;return{x:(t-n)/s,y:(e-c)/s}},[]);r.useEffect(()=>{if(X&&(X.width=S,X.height=I,!$.current&&a.width>0&&a.height>0)){const t=Math.min(a.width/S,a.height/I,.8),e=Y({scale:t,x:(a.width-S*t)/2,y:(a.height-I*t)/2});u(e),$.current=!0}},[a,X,Y]),r.useEffect(()=>{$.current&&a.width>0&&a.height>0&&u(t=>Y(t))},[a,Y]),r.useEffect(()=>{if(!M)return;const t=new ResizeObserver(e=>{for(const n of e){const{width:c,height:s}=n.contentRect;w({width:c,height:s})}});return t.observe(M),()=>t.disconnect()},[M]);const F=r.useCallback(t=>{if(t.preventDefault(),t.stopPropagation(),!M)return;const{clientX:e,clientY:n,deltaY:c}=t,s=M.getBoundingClientRect();u(g=>{const k=1-c*.001,V=g.scale*k,C=Math.max(W,Math.min(z,V));if(C===g.scale)return g;const G=(e-s.left-g.x)/g.scale,H=(n-s.top-g.y)/g.scale,O=e-s.left-G*C,N=n-s.top-H*C;return Y({scale:C,x:O,y:N})})},[M,Y]);r.useEffect(()=>{if(M)return M.addEventListener("wheel",F,{passive:!1}),()=>M.removeEventListener("wheel",F)},[M,F]),r.useEffect(()=>{const t=n=>{var c,s;n.code==="Space"&&!n.repeat&&((c=document.activeElement)==null?void 0:c.tagName)!=="INPUT"&&((s=document.activeElement)==null?void 0:s.tagName)!=="TEXTAREA"&&(n.preventDefault(),b(!0))},e=n=>{n.code==="Space"&&(n.preventDefault(),b(!1),l==="panning"&&p("idle"))};return document.addEventListener("keydown",t),document.addEventListener("keyup",e),()=>{document.removeEventListener("keydown",t),document.removeEventListener("keyup",e)}},[l]);const Z=r.useCallback(t=>{if(t.button!==0&&t.button!==1)return;if(m||x||t.button===1||f)p("panning"),y.current={clientX:t.clientX,clientY:t.clientY,viewX:i.x,viewY:i.y};else{p("stamping");const n=t.currentTarget.getBoundingClientRect(),c=E(t.clientX-n.left,t.clientY-n.top);R({start:c,current:c}),y.current={clientX:t.clientX,clientY:t.clientY,viewX:0,viewY:0}}},[m,x,f,i,E]),q=r.useCallback(t=>{if(l==="panning"&&X){const e=t.clientX-y.current.clientX,n=t.clientY-y.current.clientY,c={x:y.current.viewX,y:y.current.viewY,scale:i.scale},s=Y({...c,x:c.x+e,y:c.y+n});v.current=s,X.style.transform=`translate(${s.x}px, ${s.y}px) scale(${s.scale})`}else if(l==="stamping"&&o){const e=t.currentTarget.getBoundingClientRect(),n=E(t.clientX-e.left,t.clientY-e.top);R({...o,current:n})}},[l,i.scale,Y,o,E,X]),U=r.useCallback(t=>{if(l==="panning")u(v.current);else if(l==="stamping"&&o){const e=Math.hypot(t.clientX-y.current.clientX,t.clientY-y.current.clientY);let n=0;if(e>=K){const c=o.current.x-o.start.x,s=o.current.y-o.start.y;n=Math.atan2(s,c)*180/Math.PI}h(o.start.x,o.start.y,0,n)}p("idle"),R(null)},[l,o,h]),J=r.useCallback(t=>{if(t.touches.length>=2){p("pinching");const e=t.touches[0],n=t.touches[1],c=Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY);T.current={dist:c,midX:(e.clientX+n.clientX)/2,midY:(e.clientY+n.clientY)/2,initialTransform:{...i}};return}if(t.touches.length===1){const e=t.touches[0];if(f||(m||x)){p("panning"),y.current={clientX:e.clientX,clientY:e.clientY,viewX:i.x,viewY:i.y};return}p("stamping");const c=t.currentTarget.getBoundingClientRect(),s=E(e.clientX-c.left,e.clientY-c.top);R({start:s,current:s}),y.current={clientX:e.clientX,clientY:e.clientY,viewX:0,viewY:0},"force"in e&&(A.current=e.force)}},[m,x,f,i,E]),Q=r.useCallback(t=>{if(l==="pinching"&&t.touches.length>=2&&X){const e=t.touches[0],n=t.touches[1],c=(e.clientX+n.clientX)/2,s=(e.clientY+n.clientY)/2,g=Math.hypot(e.clientX-n.clientX,e.clientY-n.clientY),{initialTransform:k,dist:V}=T.current,C=t.currentTarget.getBoundingClientRect(),G=(T.current.midX-C.left-k.x)/k.scale,H=(T.current.midY-C.top-k.y)/k.scale,O=g/V,N=k.scale*O,et=c-C.left-G*N,nt=s-C.top-H*N,D=Y({x:et,y:nt,scale:N});v.current=D,X.style.transform=`translate(${D.x}px, ${D.y}px) scale(${D.scale})`}else if(l==="stamping"&&t.touches.length===1&&o){const e=t.touches[0],n=t.currentTarget.getBoundingClientRect(),c=E(e.clientX-n.left,e.clientY-n.top);R({...o,current:c}),"force"in e&&(A.current=e.force)}else if(l==="panning"&&t.touches.length===1&&X){const e=t.touches[0],n=e.clientX-y.current.clientX,c=e.clientY-y.current.clientY,s={x:y.current.viewX,y:y.current.viewY,scale:i.scale},g=Y({...s,x:s.x+n,y:s.y+c});v.current=g,X.style.transform=`translate(${g.x}px, ${g.y}px) scale(${g.scale})`}},[l,i.scale,Y,o,E,X]),P=r.useCallback(t=>{if(l==="panning"||l==="pinching")u(v.current);else if(l==="stamping"&&t.changedTouches.length===1&&o){const e=t.changedTouches[0],n=Math.hypot(e.clientX-y.current.clientX,e.clientY-y.current.clientY);let c=0;if(n>=K){const s=o.current.x-o.start.x,g=o.current.y-o.start.y;c=Math.atan2(g,s)*180/Math.PI}h(o.start.x,o.start.y,A.current,c),A.current=0}t.touches.length<2&&(p("idle"),R(null))},[l,o,h]),tt=r.useCallback(()=>{u(t=>({...t}))},[]);return r.useEffect(()=>()=>{$.current=!1},[]),{viewTransform:i,viewTransformRef:v,viewportSize:a,isPanning:l==="panning"||l==="pinching",isPanMode:m||x,stampPreview:o,containerProps:{onMouseDown:Z,onMouseMove:q,onMouseUp:U,onMouseLeave:U,onTouchStart:J,onTouchMove:Q,onTouchEnd:P},forceCanvasUpdate:tt,containerRef:B,canvasRef:_,canvasNode:X}}const j=160,ct=({mainCanvas:h,viewTransformRef:f,viewportSize:x,canvasWidth:i,canvasHeight:u})=>{const a=r.useRef(null),w=r.useRef(null),l=i/u,p=j/l;return r.useEffect(()=>{if(!h||!a.current)return;const m=a.current.getContext("2d",{alpha:!1});if(!m)return;const b=()=>{if(!x.width||!x.height){w.current=requestAnimationFrame(b);return}m.fillStyle="#f7f3e9",m.fillRect(0,0,j,p),m.drawImage(h,0,0,j,p);const{x:o,y:R,scale:M}=f.current,B=-o/M*(j/i),X=-R/M*(p/u),_=x.width/M*(j/i),v=x.height/M*(p/u);m.strokeStyle="rgba(0, 150, 255, 1)",m.lineWidth=1.5,m.strokeRect(B,X,_,v),w.current=requestAnimationFrame(b)};return w.current=requestAnimationFrame(b),()=>{w.current&&cancelAnimationFrame(w.current)}},[h,f,x,i,u,p]),d.jsx("div",{className:"absolute bottom-4 right-4 z-20 bg-gray-900/70 backdrop-blur-sm p-1 rounded-lg shadow-lg border border-gray-700 pointer-events-none","aria-hidden":"true",children:d.jsx("canvas",{ref:a,width:j,height:p,className:"rounded-md"})})},st=({stampPreview:h,viewTransform:f})=>{if(!(h!=null&&h.start)||!h.current)return null;const x=h.start.x*f.scale+f.x,i=h.start.y*f.scale+f.y,u=h.current.x*f.scale+f.x,a=h.current.y*f.scale+f.y;return Math.hypot(u-x,a-i)<5?null:d.jsxs("svg",{className:"absolute top-0 left-0 w-full h-full pointer-events-none z-50","aria-hidden":"true",children:[d.jsx("defs",{children:d.jsxs("filter",{id:"glow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[d.jsx("feGaussianBlur",{stdDeviation:"3",result:"coloredBlur"}),d.jsxs("feMerge",{children:[d.jsx("feMergeNode",{in:"coloredBlur"}),d.jsx("feMergeNode",{in:"SourceGraphic"})]})]})}),d.jsxs("g",{style:{filter:"url(#glow)"},children:[d.jsx("circle",{cx:x,cy:i,r:"8",stroke:"rgba(0, 0, 0, 0.5)",strokeWidth:"2",fill:"rgba(255, 255, 255, 0.8)"}),d.jsx("line",{x1:x,y1:i,x2:u,y2:a,stroke:"rgba(255, 255, 255, 0.8)",strokeWidth:"2",strokeDasharray:"4,4"}),d.jsx("circle",{cx:u,cy:a,r:"4",fill:"rgba(255, 255, 255, 0.8)"})]})]})},ot=({canvasRef:h,containerRef:f,canvasNode:x,containerProps:i,viewTransform:u,viewTransformRef:a,viewportSize:w,isPanning:l,stampPreview:p,cursorClass:m,ariaLabel:b})=>d.jsxs(d.Fragment,{children:[d.jsxs("div",{ref:f,className:`relative w-full h-full bg-paper-texture overflow-hidden touch-none ${m} ${l?"cursor-grabbing":""}`,...i,children:[d.jsx("canvas",{ref:h,className:"bg-white shadow-xl","aria-label":b,style:{position:"absolute",top:0,left:0,height:I,width:S,transform:`translate(${u.x}px, ${u.y}px) scale(${u.scale})`,transformOrigin:"0 0",willChange:"transform"}}),d.jsx(ct,{mainCanvas:x,viewTransformRef:a,viewportSize:w,canvasWidth:S,canvasHeight:I})]}),d.jsx(st,{stampPreview:p,viewTransform:u})]});export{ot as I,it as u};
