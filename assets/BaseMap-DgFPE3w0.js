import{r as u,j as S,F as v,H as R}from"./react-vendor-B6On5FFh.js";import{b as I,a as w,u as b,e as x,f as A,h as C,i as L}from"./index-CASFG7ec.js";import{v as O}from"./vendor-Gjd468CK.js";import{b as F}from"./maplibre-gl-vendor-Csyg3Y42.js";function $(i){const{user:a}=I(),[r,d]=u.useState([]),[M,m]=u.useState(!0),{addToast:o}=w(),{t}=b();u.useEffect(()=>{a!=null&&a.id&&i?(m(!0),x(i).then(e=>d(e)).catch(e=>{console.error("Failed to load geolocations from DB",e),o(t("geolocations.loadErrorToast"),"error")}).finally(()=>m(!1))):(d([]),m(!1))},[a==null?void 0:a.id,i,o,t]);const g=u.useCallback(async e=>{if(!a||!i){o(t("geolocations.loginToast"),"info");return}const s={id:O(),user_id:a.id,rally_id:i,created_at:new Date().toISOString(),name:e.name,latitude:e.latitude,longitude:e.longitude,radius:e.radius,description:e.description??null,stamp_id:e.stamp_id??null};d(n=>[s,...n]);try{await A({...s}),o(t("geolocations.addSuccessToast",{name:s.name}),"success")}catch(n){console.error("Failed to add geolocation:",n),o(t("geolocations.addErrorToast"),"error"),d(f=>f.filter(h=>h.id!==s.id))}},[a,i,o,t]),c=u.useCallback(async(e,s)=>{const n=[...r];d(f=>f.map(h=>h.id===e?{...h,...s}:h));try{await C(e,s),o(t("geolocations.updateSuccessToast"),"success")}catch(f){console.error("Failed to update geolocation:",f),o(t("geolocations.updateErrorToast"),"error"),d(n)}},[r,o,t]),E=u.useCallback(async e=>{const s=[...r];d(n=>n.filter(f=>f.id!==e));try{await L(e),o(t("geolocations.deleteSuccessToast"),"info")}catch(n){console.error("Failed to delete geolocation:",n),o(t("geolocations.deleteErrorToast"),"error"),d(s)}},[r,o,t]);return{geolocations:r,loading:M,addGeolocation:g,updateGeolocation:c,deleteGeolocation:E}}function z(i,a,r,d){const m=i*Math.PI/180,o=r*Math.PI/180,t=(r-i)*Math.PI/180,g=(d-a)*Math.PI/180,c=Math.sin(t/2)*Math.sin(t/2)+Math.cos(m)*Math.cos(o)*Math.sin(g/2)*Math.sin(g/2);return 6371e3*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function U(i,a,r=64){const[d,M]=i,m={latitude:M,longitude:d},o=a/1e3,t=[],g=o/(111.32*Math.cos(m.latitude*Math.PI/180)),c=o/110.574;let E,e,s;for(let n=0;n<r;n++)E=n/r*(2*Math.PI),e=g*Math.cos(E),s=c*Math.sin(E),t.push([m.longitude+e,m.latitude+s]);return t.push(t[0]),{type:"Feature",geometry:{type:"Polygon",coordinates:[t]},properties:{}}}const H=({isVisible:i,onMapLoad:a,onGeolocate:r,onMapClick:d,children:M,className:m="",cursor:o="",mapRef:t})=>{const{addToast:g}=w(),{t:c}=b(),[E,e]=u.useState({longitude:-.09,latitude:51.505,zoom:3}),[s,n]=u.useState(!1),f=u.useRef(null),h=t||f,T=u.useRef(null),y=u.useRef(!1),G=l=>{let p=c("mapEditor.locationError.unknown");switch(l.code){case l.PERMISSION_DENIED:p=c("mapEditor.locationError.denied");break;case l.POSITION_UNAVAILABLE:p=c("mapEditor.locationError.unavailable");break;case l.TIMEOUT:p=c("mapEditor.locationError.timeout");break}g(p,"error")},P=u.useCallback(l=>{y.current||(y.current=!0,g(c("mapEditor.centeredToast"),"success")),r==null||r({latitude:l.coords.latitude,longitude:l.coords.longitude})},[g,c,r]),k=u.useCallback(()=>{s||setTimeout(()=>{if(T.current)try{T.current.trigger(),n(!0)}catch(l){console.warn("Failed to trigger geolocation on load:",l)}},500),a==null||a()},[s,a]);return u.useEffect(()=>{if(i&&h.current){const l=setTimeout(()=>{var p;return(p=h.current)==null?void 0:p.getMap().resize()},1);return()=>clearTimeout(l)}},[i,h]),u.useEffect(()=>{if(!s){const l=setTimeout(()=>{if(T.current)try{T.current.trigger(),n(!0)}catch(p){console.warn("Failed to trigger geolocation on mount:",p),(navigator.userAgent.includes("iPhone")||navigator.userAgent.includes("iPad"))&&g(c("mapEditor.iOSLocationPrompt")||"Tap the location button to center on your position","info")}},1e3);return()=>clearTimeout(l)}},[s,g,c]),S.jsx("div",{className:`relative w-full h-full bg-gray-700 ${o} ${m}`,children:S.jsxs(v,{ref:h,mapLib:F,...E,onMove:l=>e(l.viewState),onClick:d,onLoad:k,mapStyle:"https://tiles.openfreemap.org/styles/positron",style:{width:"100%",height:"100%"},children:[S.jsx(R,{ref:T,positionOptions:{enableHighAccuracy:!0,timeout:1e4,maximumAge:0},trackUserLocation:i,showUserLocation:!0,showAccuracyCircle:!0,fitBoundsOptions:{maxZoom:14},onError:G,onGeolocate:P}),M]})})};export{H as B,U as c,z as g,$ as u};
