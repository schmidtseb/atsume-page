import{r as h,j as e,X as k,o as I,x as v,C as B,y as A}from"./react-vendor-DJ-QoGxu.js";import{b as E,c as _,u as $,a as D,d as G}from"./index-DQy-5LOC.js";import{p as L}from"./presets-CtbnJzjA.js";import{d as M,u as J}from"./useGallery-BeyW6TB5.js";import{u as W}from"./useGeolocations-BZFd3C9v.js";import"./vendor-CFJUWez9.js";import"./maplibre-gl-vendor-Csyg3Y42.js";import"./supabase-vendor-C_Ws-sQM.js";async function q(x,b,c,s){const o={successCount:0,totalCount:c.length,errors:[]};for(let d=0;d<c.length;d++){const t=c[d];try{const p=L.find(m=>m.name===t.preset),l={...M,...p?p.settings:{}},g=await E({user_id:x,name:t.name,thumbnail:"data:image/jpeg;base64,"+t.image,sourceImageURL:"data:image/jpeg;base64,"+t.image,settings:l});await _({user_id:x,rally_id:b,stamp_id:g.id,name:t.name,description:t.description,latitude:t.coordinates[0],longitude:t.coordinates[1],radius:t.collection_radius}),o.successCount++}catch(p){console.error(`Error processing item ${t.name}:`,p),o.errors.push({item:t,error:p.message})}s(Math.round((d+1)/c.length*100))}return o}const Y=({isOpen:x,onClose:b,rallyId:c})=>{const{t:s}=$(),{toast:o}=D(),{user:d}=G(),{refreshGeolocations:t}=W(c),{refreshStamps:p}=J(),[l,g]=h.useState(null),[m,y]=h.useState(0),[a,r]=h.useState("idle"),[U,n]=h.useState(null),j=h.useRef(null),w=i=>{if(i.target.files&&i.target.files[0]){const f=i.target.files[0];f.type==="application/json"?(g(f),r("idle"),n(null),y(0)):(g(null),r("error"),n(s("batchUpload.invalidFileType")),o(s("batchUpload.invalidFileType"),"destructive"))}},z=async()=>{if(!l){n(s("batchUpload.noFileSelected")),o(s("batchUpload.noFileSelected"),"destructive");return}if(!d){n(s("batchUpload.loginRequired")),o(s("batchUpload.loginRequired"),"destructive");return}r("uploading"),n(null);try{const i=new FileReader;i.onload=async f=>{var S;try{const C=(S=f.target)==null?void 0:S.result,R=JSON.parse(C);r("processing");const u=await q(d.id,c,R,T=>{y(T)});u.errors.length>0?(r("error"),n(s("batchUpload.partialSuccess",{success:u.successCount,total:u.totalCount})),o(s("batchUpload.partialSuccess",{success:u.successCount,total:u.totalCount}),"warning")):(r("success"),o(s("batchUpload.success",{count:u.successCount}),"success"),t(),p())}catch(C){r("error"),n(s("batchUpload.invalidJson")+`: ${C.message}`),o(s("batchUpload.invalidJson"),"destructive")}},i.readAsText(l)}catch(i){r("error"),n(s("batchUpload.uploadFailed")+`: ${i.message}`),o(s("batchUpload.uploadFailed")+`: ${i.message}`,"destructive")}},F=()=>{g(null),y(0),r("idle"),n(null),j.current&&(j.current.value=""),b()};return x?e.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"#1f2937",padding:"20px",borderRadius:"8px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",zIndex:1e3,width:"90%",maxWidth:"425px",border:"1px solid #374151"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px"},children:[e.jsx("h2",{style:{fontSize:"1.25rem",fontWeight:"600",color:"#f9fafb"},children:s("batchUpload.title")}),e.jsx("button",{onClick:F,style:{background:"none",border:"none",cursor:"pointer",color:"#9ca3af"},children:e.jsx(k,{size:20})})]}),e.jsxs("div",{style:{marginBottom:"15px"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"24px",border:"2px dashed #4b5563",borderRadius:"8px",color:"#9ca3af"},children:[e.jsx("input",{id:"json-upload",type:"file",accept:".json",onChange:w,style:{display:"none"},ref:j}),e.jsxs("label",{htmlFor:"json-upload",style:{cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(I,{size:48,style:{marginBottom:"8px"}}),e.jsx("p",{style:{fontSize:"0.875rem",marginBottom:"4px"},children:s("batchUpload.dragDrop")}),e.jsx("p",{style:{fontSize:"0.75rem",color:"#6b7280"},children:s("batchUpload.orClick")})]}),l&&e.jsxs("p",{style:{marginTop:"8px",fontSize:"0.875rem",color:"#f9fafb"},children:[s("batchUpload.selectedFile"),": ",l.name]})]}),a==="uploading"&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#60a5fa",marginTop:"15px"},children:[e.jsx(v,{size:20,style:{animation:"spin 1s linear infinite"}}),e.jsx("span",{children:s("batchUpload.readingFile")})]}),a==="processing"&&e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"8px",marginTop:"15px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#60a5fa"},children:[e.jsx(v,{size:20,style:{animation:"spin 1s linear infinite"}}),e.jsx("span",{children:s("batchUpload.processingItems")})]}),e.jsx("div",{style:{width:"100%",height:"8px",backgroundColor:"#4b5563",borderRadius:"4px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${m}%`,height:"100%",backgroundColor:"#60a5fa",transition:"width 0.3s ease-in-out"}})}),e.jsxs("p",{style:{fontSize:"0.875rem",color:"#9ca3af",textAlign:"center"},children:[m,"%"]})]}),a==="success"&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#4ade80",marginTop:"15px"},children:[e.jsx(B,{size:20}),e.jsx("span",{children:s("batchUpload.uploadComplete")})]}),a==="error"&&U&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",color:"#ef4444",marginTop:"15px"},children:[e.jsx(A,{size:20}),e.jsx("span",{children:U})]}),e.jsx("button",{onClick:z,disabled:!l||a==="uploading"||a==="processing",style:{marginTop:"15px",width:"100%",padding:"10px 15px",backgroundColor:"#60a5fa",color:"#f9fafb",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"1rem",fontWeight:"500",opacity:!l||a==="uploading"||a==="processing"?.5:1,transition:"opacity 0.2s ease-in-out"},children:s(a==="processing"?"common.submitting":"batchUpload.uploadButton")})]})]}):null};export{Y as default};
