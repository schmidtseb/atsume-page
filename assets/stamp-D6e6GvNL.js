var T=Object.defineProperty;var q=(r,n,e)=>n in r?T(r,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[n]=e;var x=(r,n,e)=>q(r,typeof n!="symbol"?n+"":n,e);const I=(r=0,n=1)=>{const e=Math.random(),t=Math.random();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*t)*n+r};class _{constructor(n,e,t){x(this,"data");x(this,"width");x(this,"height");this.width=e,this.height=n;const o=e*n;if(t instanceof Float32Array){if(t.length!==o)throw new Error("Data array does not match matrix dimensions");this.data=t}else this.data=new Float32Array(o),typeof t=="number"&&this.data.fill(t)}static ones(n,e){return new _(n,e,1)}static zeros(n,e){return new _(n,e,0)}get(n,e){return n<0||n>=this.height||e<0||e>=this.width?0:this.data[n*this.width+e]}set(n,e,t){n>=0&&n<this.height&&e>=0&&e<this.width&&(this.data[n*this.width+e]=t)}clone(){return new _(this.height,this.width,new Float32Array(this.data))}getBilinear(n,e){const t=Math.floor(n),o=Math.floor(e),s=Math.ceil(n),c=Math.ceil(e);if(t<0||s>=this.height||o<0||c>=this.width)return 0;const h=this.get(t,o),l=this.get(t,c),a=this.get(s,o),f=this.get(s,c),g=n-t,i=e-o,d=h*(1-i)+l*i,m=a*(1-i)+f*i;return d*(1-g)+m*g}}function D(r,n){const e=_.zeros(r.height,r.width);for(let t=0;t<r.data.length;t++)e.data[t]=r.data[t]*n.data[t];return e}function C(r,n,e,t,o){const s=_.zeros(r.height,r.width);for(let c=0;c<r.data.length;c++)s.data[c]=r.data[c]*n+e.data[c]*t+o;return s}function F(r){const n=r.clone();let e=1/0,t=-1/0;for(let s=0;s<n.data.length;s++)n.data[s]<e&&(e=n.data[s]),n.data[s]>t&&(t=n.data[s]);const o=t-e;if(o>0)for(let s=0;s<n.data.length;s++)n.data[s]=(n.data[s]-e)/o;return n}function P(r){let n=0;for(let e=0;e<r.data.length;e++)r.data[e]!==0&&n++;return n}const k=240,R=10,H=1;function N(r,n){const e=[];for(let t=0;t<r.length;t+=3){const o=r[t],s=r[t+1],c=r[t+2],h=(o+s+c)/3,l=o>k&&s>k&&c>k;h>n&&!l&&e.push(o,s,c)}return new Float32Array(e)}function E(r,n){return Math.sqrt((r[0]-n[0])**2+(r[1]-n[1])**2+(r[2]-n[2])**2)}function W(r,n){if(r.length===0||n===0)return{colors:[],labels:new Int32Array(0)};const e=r.length/3,t=[];for(let l=0;l<r.length;l+=3)t.push([r[l],r[l+1],r[l+2]]);e<n&&(n=e);let o=[];const s=new Set;for(;o.length<n;){const l=Math.floor(Math.random()*e);s.has(l)||(o.push([...t[l]]),s.add(l))}const c=new Int32Array(e);for(let l=0;l<R;l++){for(let i=0;i<e;i++){let d=1/0,m=0;for(let M=0;M<o.length;M++){const y=E(t[i],o[M]);y<d&&(d=y,m=M)}c[i]=m}const a=Array(o.length).fill(0).map(()=>[0,0,0]),f=new Array(o.length).fill(0);for(let i=0;i<e;i++){const d=c[i];a[d][0]+=t[i][0],a[d][1]+=t[i][1],a[d][2]+=t[i][2],f[d]++}let g=!0;for(let i=0;i<o.length;i++){if(f[i]>0)a[i][0]/=f[i],a[i][1]/=f[i],a[i][2]/=f[i];else{const d=Math.floor(Math.random()*e);a[i]=[...t[d]]}E(a[i],o[i])>H&&(g=!1)}if(o=a,g)break}return{colors:o.map(l=>l.map(Math.round)),labels:c}}function $(r,n){const e=_.zeros(r.height,r.width),t=Math.floor(n/2);for(let o=0;o<r.height;o++)for(let s=0;s<r.width;s++){let c=255;for(let h=-t;h<=t;h++)for(let l=-t;l<=t;l++)c=Math.min(c,r.get(o+h,s+l));e.set(o,s,c)}return e}function L(r,n,e,t,o,s){const c=new Array(t*o).fill(-1);let h=0;for(let a=0;a<r.length;a+=3){const f=r[a],g=r[a+1],i=r[a+2],d=(f+g+i)/3,m=f>k&&g>k&&i>k;d>s.background_threshold&&!m&&(c[a/3]=e[h],h++)}const l=[];for(let a=0;a<n.length;a++){const f=new Float32Array(t*o);for(let i=0;i<c.length;i++)f[i]=c[i]===a?255:0;let g=new _(o,t,f);s.color_shape_shrink>0&&(g=$(g,s.color_shape_shrink)),l.push(g)}return l}function O(r,n,e){const t=n*Math.PI/180,o=e*Math.cos(t),s=e*Math.sin(t);return[o,s,(1-o)*r.x-s*r.y,-s,o,s*r.x+(1-o)*r.y]}function X(r,n,e,t){const o=_.zeros(t,e),[s,c,h,l,a,f]=n,g=s*a-c*l;if(Math.abs(g)<1e-6)return o;const i=1/g,d=a*i,m=-c*i,M=(c*f-a*h)*i,y=-l*i,z=s*i,A=(l*h-s*f)*i;for(let w=0;w<t;w++)for(let b=0;b<e;b++){const u=d*b+m*w+M,p=y*b+z*w+A,v=r.getBilinear(p,u);o.set(w,b,v)}return o}function j(r,n,e,t,o){return r.map(s=>{const c=I(...t),h=I(...t),l=I(...o),a=O({x:n/2,y:e/2},l,1);return a[2]+=c,a[5]+=h,X(s,a,n,e)})}function S(r){var l;const n=r.length,e=((l=r[0])==null?void 0:l.length)||0,t=Array(n).fill(null).map(()=>Array(e));for(let a=0;a<n;a++)for(let f=0;f<e;f++)t[a][f]=r[a][f]>127;const o=Array(n).fill(null).map(()=>Array(e));for(let a=0;a<n;a++)K(t[a],o[a]);const s=Array(n).fill(null).map(()=>Array(e)),c=Array(n),h=Array(n);for(let a=0;a<e;a++){for(let f=0;f<n;f++)c[f]=o[f][a];Y(c,h);for(let f=0;f<n;f++)s[f][a]=Math.sqrt(h[f])}return s}function K(r,n){const e=r.length;let t=1/0;for(let o=0;o<e;o++)r[o]?t++:t=0,n[o]=t*t;t=1/0;for(let o=e-1;o>=0;o--)r[o]?t++:t=0,n[o]=Math.min(n[o],t*t)}function Y(r,n){const e=r.length;if(e===0)return;const t=Array(e),o=Array(e+1);let s=0;t[0]=0,o[0]=-1/0,o[1]=1/0;for(let c=1;c<e;c++){let h=(r[c]+c*c-(r[t[s]]+t[s]*t[s]))/(2*c-2*t[s]);for(;h<=o[s];)s--,h=(r[c]+c*c-(r[t[s]]+t[s]*t[s]))/(2*c-2*t[s]);s++,t[s]=c,o[s]=h,o[s+1]=1/0}s=0;for(let c=0;c<e;c++){for(;o[s+1]<c;)s++;n[c]=(c-t[s])*(c-t[s])+r[t[s]]}}function B(r,n,e){const t=Array(e).fill(null).map(()=>Array(n));for(let o=0;o<e;o++)for(let s=0;s<n;s++)t[o][s]=r.get(o,s);return S(t)}function V(r,n,e,t,o){return r.map(s=>{const c=Array(e).fill(0).map(()=>Array(n).fill(0));for(let a=0;a<e;a++)for(let f=0;f<n;f++)c[a][f]=s.get(a,f);const h=S(c),l=_.ones(e,n);for(let a=0;a<e;a++)for(let f=0;f<n;f++){const g=h[a][f];for(let i=1;i<=t;i++)if(g>i-1&&g<=i){const d=o*(t-i+1)/t;l.set(a,f,d);break}}return l})}function U(r,n,e){const t=_.zeros(n,r);for(let o=0;o<3;o++){const s=2**o,c=1/s,h=1/s;for(let l=0;l<n;l++)for(let a=0;a<r;a++){const f=h*Math.sin(a*c*2*Math.PI/e)*Math.sin(l*c*2*Math.PI/e),g=t.get(l,a);t.set(l,a,g+f)}}return F(t)}function Z(r,n,e,t,o){const s=_.ones(n,r);if(o<=0||e<=0)return s;for(let c=0;c<e;c++){const h=Math.random()*(t[1]-t[0])+t[0],l=Math.random()*r,a=Math.random()*n,f=Math.max(0,Math.floor(l-h)),g=Math.min(r,Math.ceil(l+h)),i=Math.max(0,Math.floor(a-h)),d=Math.min(n,Math.ceil(a+h));for(let m=i;m<d;m++)for(let M=f;M<g;M++){const y=Math.sqrt((M-l)**2+(m-a)**2);if(y<h){const A=1-(y/h)**2,w=1-o*A;s.get(m,M)>w&&s.set(m,M,w)}}}return s}function G(r,n,e,t){const o=[];for(let s=0;s<r;s++){const c=I(...t.noise_scale),h=U(n,e,c),l=Math.round(I(...t.num_patches)),a=I(...t.ink_depletion_intensity),f=Z(n,e,l,t.patch_size_range,a),g=I(...t.wear_intensity),i=_.ones(e,n);let d=C(h,g,i,1-g,0);d=D(d,f),d=F(d),o.push(d)}return o}function J(r,n){const e=[];let t=0;for(let o=0;o<r.length;o++){const s=n>0?r[o].density/n:1/r.length;t+=s,e.push(t)}return e.length>0&&(e[e.length-1]=1),e}function Q(r){const n=Math.random();let e=0,t=r.length-1;if(r.length===0)return-1;if(n<=r[0])return 0;if(n>=r[r.length-1])return r.length-1;for(;e<t;){const o=Math.floor((e+t)/2);r[o]<n?e=o+1:t=o}return e}function tt(r,n,e,t,o,s){const c=D(n,e);let h=null;s.bleeding_factor>0&&(h=B(r,t,o));const l=[];let a=0;for(let d=0;d<o;d++)for(let m=0;m<t;m++)if(r.get(d,m)>127){const M=c.get(d,m);l.push({x:m,y:d,density:M}),a+=M}if(l.length===0)return[];const f=J(l,a),g=Math.floor(s.splat_density*l.length),i=[];for(let d=0;d<g;d++){const m=Q(f);if(m<0)continue;const M=l[m],{x:y,y:z,density:A}=M,b=(Math.random()*(s.splat_size_range[1]-s.splat_size_range[0])+s.splat_size_range[0])*(.5+.5*A);let u=0;s.bleeding_factor>0&&h&&h[z][y]<5&&(u=-Math.log(Math.random())*s.bleeding_factor);const p=b+u,v=Math.min(255,Math.floor(100+155*A));i.push({x:y,y:z,size:p,opacity:v})}return i}function nt(r,n,e,t,o,s=!1){const c=document.createElement("canvas");c.width=e,c.height=t;const h=c.getContext("2d");if(!s){const[l,a,f]=o;h.fillStyle=`rgb(${l}, ${a}, ${f})`,h.fillRect(0,0,e,t)}return r.forEach((l,a)=>{const[f,g,i]=n[a],d=l.sort((m,M)=>M.size-m.size);for(const m of d)h.fillStyle=`rgba(${f}, ${g}, ${i}, ${m.opacity/255})`,h.beginPath(),h.ellipse(m.x,m.y,m.size/2,m.size/2,0,0,2*Math.PI),h.fill()}),h.getImageData(0,0,e,t)}function et(r,n){const{data:e,width:t,height:o}=r,s=new Uint8ClampedArray(t*o*3);for(let u=0,p=0;u<e.length;u+=4,p+=3)s[p]=e[u],s[p+1]=e[u+1],s[p+2]=e[u+2];const c=N(s,n.background_threshold),h=n.num_colors==="auto"?15:n.num_colors,{colors:l,labels:a}=W(c,h),f=L(s,l,a,t,o,n),g=240,i=u=>u[0]>g&&u[1]>g&&u[2]>g,d=f.map((u,p)=>({mask:u,color:l[p],size:P(u)})).filter(u=>!i(u.color)).sort((u,p)=>p.size-u.size);if(d.length===0){const u=document.createElement("canvas");return u.width=t,u.height=o,u.getContext("2d").getImageData(0,0,t,o)}const m=d.map(u=>u.mask),M=d.map(u=>u.color),y=j(m,t,o,n.shift,n.rotation),z=V(y,t,o,n.edge_width,n.edge_boost),A=G(M.length,t,o,n),w=[];for(let u=0;u<y.length;u++){const p=tt(y[u],z[u],A[u],t,o,n);w.push(p)}return nt(w,M,t,o,n.background_color,!0)}const at={stamp_size:512,num_colors:"auto",background_threshold:5,color_shape_shrink:5,shift:[0,1],rotation:[0,1],edge_width:4,edge_boost:3,wear_intensity:[.1,.05],noise_scale:[50,5],rotation_angle:[0,0],ink_depletion_intensity:[.3,.05],num_patches:[2,1],patch_size_range:[20,100],splat_density:.75,splat_size_range:[1,2],bleeding_factor:.1,background_color:[255,255,255]};function ct(r,n){const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("Could not create canvas context");const o=r.width/r.height,s=o>=1?n:n*o,c=o<1?n:n/o;return e.width=Math.ceil(s),e.height=Math.ceil(c),t.drawImage(r,0,0,e.width,e.height),e}async function lt(r,n){return new Promise((e,t)=>{setTimeout(()=>{try{const o=et(r,n);e(o)}catch(o){t(o)}},0)})}export{ct as c,at as d,lt as g};
